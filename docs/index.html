<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>thesctrading</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-985aa47af68dae11cd4d235c71fb941e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-c1fac2584b48ed01fb6e278e36375074.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">thesctrading</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sc-trading-strategy-overview" id="toc-sc-trading-strategy-overview" class="nav-link active" data-scroll-target="#sc-trading-strategy-overview">S&amp;C Trading Strategy Overview</a>
  <ul class="collapse">
  <li><a href="#strategy-outline" id="toc-strategy-outline" class="nav-link" data-scroll-target="#strategy-outline">1. Strategy Outline</a></li>
  <li><a href="#exit-strategy" id="toc-exit-strategy" class="nav-link" data-scroll-target="#exit-strategy">2. Exit Strategy</a></li>
  <li><a href="#position-sizing-framework" id="toc-position-sizing-framework" class="nav-link" data-scroll-target="#position-sizing-framework">3. Position Sizing Framework</a></li>
  <li><a href="#data-requirements" id="toc-data-requirements" class="nav-link" data-scroll-target="#data-requirements">4. Data Requirements</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">5. Next Steps</a></li>
  <li><a href="#fred-data-software-developer-job-postings" id="toc-fred-data-software-developer-job-postings" class="nav-link" data-scroll-target="#fred-data-software-developer-job-postings">6. FRED Data: Software Developer Job Postings</a></li>
  </ul></li>
  <li><a href="#blotter-ledger-code" id="toc-blotter-ledger-code" class="nav-link" data-scroll-target="#blotter-ledger-code">Blotter &amp; Ledger Code</a>
  <ul class="collapse">
  <li><a href="#fetch-data" id="toc-fetch-data" class="nav-link" data-scroll-target="#fetch-data">Fetch data</a></li>
  <li><a href="#clean-data" id="toc-clean-data" class="nav-link" data-scroll-target="#clean-data">Clean Data</a></li>
  <li><a href="#print-dfs" id="toc-print-dfs" class="nav-link" data-scroll-target="#print-dfs">Print DFs</a></li>
  <li><a href="#vol" id="toc-vol" class="nav-link" data-scroll-target="#vol">Vol</a></li>
  <li><a href="#blotter-ledger-initialization" id="toc-blotter-ledger-initialization" class="nav-link" data-scroll-target="#blotter-ledger-initialization">Blotter &amp; Ledger Initialization</a></li>
  <li><a href="#blotter-ledger-loop" id="toc-blotter-ledger-loop" class="nav-link" data-scroll-target="#blotter-ledger-loop">Blotter &amp; Ledger Loop</a></li>
  <li><a href="#extra" id="toc-extra" class="nav-link" data-scroll-target="#extra">Extra</a></li>
  </ul></li>
  <li><a href="#outputting-interactive-blotter-ledger-final-hw-here" id="toc-outputting-interactive-blotter-ledger-final-hw-here" class="nav-link" data-scroll-target="#outputting-interactive-blotter-ledger-final-hw-here">Outputting Interactive Blotter &amp; Ledger (FINAL HW HERE)</a>
  <ul class="collapse">
  <li><a href="#navcharts-extra-not-necessary" id="toc-navcharts-extra-not-necessary" class="nav-link" data-scroll-target="#navcharts-extra-not-necessary">NAV/Charts &amp; Extra (not necessary)</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">thesctrading</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sc-trading-strategy-overview" class="level2">
<h2 class="anchored" data-anchor-id="sc-trading-strategy-overview">S&amp;C Trading Strategy Overview</h2>
<section id="strategy-outline" class="level3">
<h3 class="anchored" data-anchor-id="strategy-outline">1. Strategy Outline</h3>
<p>Our team is implementing a buy low / sell high strategy focused on short-term momentum trading in TSLA stock. We aim to take advantage of periods of elevated volatility and momentum, holding positions for 10 trading days or less. We use the 10 day window to account for the fact that some of our data sources are weekly and may provide more signal over a longer trade horizon. Of course, if the system hits its limit point during the window, the position will close similar to our HW1 model.</p>
<p><em>note that we plan to use backward elimination ML method to determine most important features. We plan to trial a variety of alternative data features from FRED (detailed at the end of the website) as well as some competitor company technical factors. <strong>We also wish to include valuation metrics using the yfinance package.</strong></em></p>
<section id="example-trade-walkthrough" class="level4">
<h4 class="anchored" data-anchor-id="example-trade-walkthrough">Example Trade Walkthrough</h4>
<p>Pre-Trade Filter</p>
<ol type="1">
<li>Check if job postings for software roles increased week-over-week (as well as other FRED/alternative data including pairs performance)</li>
<li>Check if implied volatility (IV) percentile &gt; 50% and &lt; 90%</li>
<li>If both are true → proceed to trade evaluation</li>
</ol>
<hr>
<p>Buy Conditions</p>
<ol type="1">
<li>Price is above the 50-day SMA (or EMA) <em>note we may also include valuation metrics here to avoid extreme overvaluation given our long-only strategy</em></li>
<li>Gamma exposure is positive (or some other Greek we can calculate)</li>
</ol>
<hr>
</section>
</section>
<section id="exit-strategy" class="level3">
<h3 class="anchored" data-anchor-id="exit-strategy">2. Exit Strategy</h3>
<p>We use four exit triggers to manage risk and lock in profits:</p>
<ol type="1">
<li>If position is open for more than 10 trading days, exit regardless of performance</li>
<li>If IV percentile drops below 30%, exit</li>
<li>Exit if price reaches a profit target of 2x last week’s average true range (ATR)</li>
<li>Use a trailing stop loss of 1.5x ATR below the highest price reached since entry</li>
</ol>
<hr>
</section>
<section id="position-sizing-framework" class="level3">
<h3 class="anchored" data-anchor-id="position-sizing-framework">3. Position Sizing Framework</h3>
<p>Position size will adapt based on strength of indicators and perhaps on a regression of additional features not used to determine the weekly position strategy similar to the logistic regression model used in HW1. We envision a less binary model where sizing is continuous determined on a variety of features (allows us to take risk off but also keep risk on more granularly than the original model).</p>
<p>Conditions for each tier will be finalized after further backtesting.</p>
<hr>
</section>
<section id="data-requirements" class="level3">
<h3 class="anchored" data-anchor-id="data-requirements">4. Data Requirements</h3>
<p>We plan to collect and process:</p>
<ul>
<li>Price data and technical indicators (SMA, ATR, IV, Options contracts)</li>
<li>Job posting data &amp; other relevant metrics from FRED</li>
<li>Automotive industry data from FRED</li>
<li>Implied volatility percentile data (via IBKR)</li>
</ul>
<p>We may use the FRED API, yFinance, or custom scrapers to automate data gathering.</p>
<hr>
</section>
<section id="next-steps" class="level3">
<h3 class="anchored" data-anchor-id="next-steps">5. Next Steps</h3>
<ul>
<li>Gather full feature list and find good alt data and implement backward elimination model to decide useful features</li>
<li>Build &amp; backtest position sizing model</li>
<li>Backtest the strategy on historical TSLA data</li>
<li>Deploy the final version to https://thesctrading.com</li>
</ul>
</section>
<section id="fred-data-software-developer-job-postings" class="level3">
<h3 class="anchored" data-anchor-id="fred-data-software-developer-job-postings">6. FRED Data: Software Developer Job Postings</h3>
<p>The below is demonstrating our ability to use the FRED API to pull in features. This example is weekly software job postings. We plan to scour FRED to identify other features that may be useful. Other things may include potential regulatory items or things indicating sentiment on Elon as well as other automotive industry stats including production, CPI, etc. We plan to test a variety and perhaps identify the most powerful features through supervised feature selection methods. Likely <strong>backward selection</strong> where the model evaluates all the features and removes the least powerful/most noisy one by one.</p>
<div id="e0ab0c88" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fredapi <span class="im">import</span> Fred</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to FRED</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>fred <span class="op">=</span> Fred(api_key<span class="op">=</span><span class="st">"1c00931ee7dc4304c6bb68b72fb2d68f"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch data</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>series_id <span class="op">=</span> <span class="st">"IHLIDXUSTPSOFTDEVE"</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> fred.get_series(series_id)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to DataFrame</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data, columns<span class="op">=</span>[<span class="st">"Job Postings"</span>])</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>df.index.name <span class="op">=</span> <span class="st">"Date"</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.reset_index()</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Display last 5 rows as table</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>df.tail()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Job Postings</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1899</td>
<td>2025-04-14</td>
<td>64.17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1900</td>
<td>2025-04-15</td>
<td>64.04</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1901</td>
<td>2025-04-16</td>
<td>63.84</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1902</td>
<td>2025-04-17</td>
<td>63.81</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1903</td>
<td>2025-04-18</td>
<td>63.77</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="75a80ebc" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the time series</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>plt.plot(df[<span class="st">"Date"</span>], df[<span class="st">"Job Postings"</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"US Software Developer Job Postings Index"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Index Value"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="blotter-ledger-code" class="level1">
<h1>Blotter &amp; Ledger Code</h1>
<div id="a92de9ae" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shinybroker <span class="im">as</span> sb</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="fetch-data" class="level3">
<h3 class="anchored" data-anchor-id="fetch-data">Fetch data</h3>
<div id="0c31689b" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>asset<span class="op">=</span> sb.Contract({</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'symbol'</span>: <span class="st">"TSLA"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'secType'</span>: <span class="st">"STK"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'exchange'</span>: <span class="st">"SMART"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'currency'</span>: <span class="st">"USD"</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>benchmark <span class="op">=</span> sb.Contract({</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'symbol'</span>: <span class="st">"SPX"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'secType'</span>: <span class="st">"IND"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'exchange'</span>: <span class="st">"CBOE"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'currency'</span>: <span class="st">"USD"</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#### Get hourly data to use for calculating vol</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>historical_data_hourly_fetch <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    endDateTime<span class="op">=</span><span class="st">''</span>,         <span class="co"># Let IBKR set the "now" time</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'1 Y'</span>,      <span class="co"># Past 1 year</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 hour'</span>, <span class="co"># Daily bars</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    whatToShow<span class="op">=</span><span class="st">'TRADES'</span>,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#date_format=1,          # String time zone date</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#keepUpToDate=False</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>historical_data_hourly <span class="op">=</span> historical_data_hourly_fetch[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co">#### Get daily data as well because it speeds up the code</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co">####   writing process.</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>historical_data_daily_fetch <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    endDateTime<span class="op">=</span><span class="st">''</span>,         <span class="co"># Let IBKR set the "now" time</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'1 Y'</span>,      <span class="co"># Past 1 year</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 day'</span>, <span class="co"># Daily bars</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    whatToShow<span class="op">=</span><span class="st">'TRADES'</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">#date_format=1,          # String time zone date</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">#keepUpToDate=False</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>historical_data_daily <span class="op">=</span> historical_data_daily_fetch[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="co"># print("HDD", historical_data_daily)</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co">#### Fetch your liquid trading hours for the asset</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="co">#### You'll need this later!</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>ares_deets <span class="op">=</span> sb.fetch_contract_details(</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>sb.Contract({</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'symbol'</span>: <span class="st">"TSLA"</span>,</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'secType'</span>: <span class="st">"STK"</span>,</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'exchange'</span>: <span class="st">"SMART"</span>,</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'currency'</span>: <span class="st">"USD"</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>liquid_hours <span class="op">=</span> ares_deets[<span class="st">'liquidHours'</span>]</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="co"># print(liquid_hours)</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co">#liquid_hours = (ares_deets['liquidHours'][0])</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> safe_fetch_iv(contract, durationStr, barSizeSetting, label):</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        fetch <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>            contract<span class="op">=</span>contract,</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>            endDateTime<span class="op">=</span><span class="st">''</span>,</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>            durationStr<span class="op">=</span>durationStr,</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>            barSizeSetting<span class="op">=</span>barSizeSetting,</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>            whatToShow<span class="op">=</span><span class="st">'OPTION_IMPLIED_VOLATILITY'</span>,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>            useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> fetch[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="co">#        print(f"{label} IV data fetched. Rows: {len(df)}")</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a><span class="co">#        print(f"{label} IV fetch failed: {e}")</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace your fetch calls with:</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a><span class="co">#iv_historical_data_hourly = safe_fetch_iv(</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a><span class="co">#    contract=asset,</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a><span class="co">#    durationStr='1 Y',</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a><span class="co">#    barSizeSetting='1 hour',</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a><span class="co">#    label="Hourly"</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a><span class="co">#)</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>iv_historical_data_daily <span class="op">=</span> safe_fetch_iv(</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'1 Y'</span>,</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 day'</span>,</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Daily"</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>historical_data_daily_fetch_SMA <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    endDateTime<span class="op">=</span><span class="st">''</span>,         <span class="co"># Let IBKR set the "now" time</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'2 Y'</span>,      <span class="co"># Past 1 year</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 day'</span>, <span class="co"># Daily bars</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    whatToShow<span class="op">=</span><span class="st">'TRADES'</span>,</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">#date_format=1,          # String time zone date</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    <span class="co">#keepUpToDate=False</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA <span class="op">=</span> historical_data_daily_fetch_SMA[<span class="st">'hst_dta'</span>]<span class="co">#%% md</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="clean-data" class="level3">
<h3 class="anchored" data-anchor-id="clean-data">Clean Data</h3>
<div id="2703f81a" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure 'date' is a datetime column</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(historical_data_daily_SMA[<span class="st">'timestamp'</span>])</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by date just to be safe</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA <span class="op">=</span> historical_data_daily_SMA.sort_values(<span class="st">'timestamp'</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate 20-day simple moving average</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA[<span class="st">'SMA_20'</span>] <span class="op">=</span> historical_data_daily_SMA[<span class="st">'close'</span>].rolling(window<span class="op">=</span><span class="dv">20</span>).mean()</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(historical_data_daily_SMA[<span class="st">'SMA_20'</span>])</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">#### Prepare Data</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate trade period</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_trade_period(dt):</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    iso_year, iso_week, _ <span class="op">=</span> dt.isocalendar()</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(<span class="ss">f"</span><span class="sc">{</span>iso_year<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>iso_week<span class="sc">:02d}</span><span class="ss">"</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure 'date' column is in datetime format</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(historical_data_daily[<span class="st">'timestamp'</span>])</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(historical_data_hourly[<span class="st">'timestamp'</span>])</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>iv_historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(iv_historical_data_daily[<span class="st">'timestamp'</span>])</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">#iv_historical_data_hourly['timestamp'] = pd.to_datetime(iv_historical_data_hourly['timestamp'])</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">#liquid_hours['timestamp'] = pd.to_datetime(liquid_hours['timestamp'])</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply trade period calculation</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">=</span> historical_data_daily[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">=</span> historical_data_hourly[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>iv_historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">=</span> iv_historical_data_daily[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co">#iv_historical_data_hourly['trd_prd'] = iv_historical_data_hourly['timestamp'].apply(get_trade_period)</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA[<span class="st">'trd_prd'</span>] <span class="op">=</span> historical_data_daily_SMA[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co">#liquid_hours['trd_prd'] = liquid_hours['timestamp'].apply(get_trade_period)</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the first full five-trading-day week</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>weekly_counts <span class="op">=</span> historical_data_daily.groupby(<span class="st">'trd_prd'</span>)[<span class="st">'timestamp'</span>].count()</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>first_full_week <span class="op">=</span> weekly_counts[weekly_counts <span class="op">&gt;=</span> <span class="dv">5</span>].index.<span class="bu">min</span>()</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter historical_data_daily</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>historical_data_daily <span class="op">=</span> historical_data_daily[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">&gt;=</span> first_full_week]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>0           NaN
1           NaN
2           NaN
3           NaN
4           NaN
         ...   
496    252.5465
497    253.1375
498    254.2540
499    255.8975
500    256.5825
Name: SMA_20, Length: 501, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="print-dfs" class="level3">
<h3 class="anchored" data-anchor-id="print-dfs">Print DFs</h3>
<div id="c6c68002" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print dataframes</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Historical Data Daily:"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(historical_data_daily)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Historical Data Hourly:"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(historical_data_hourly)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"IV Historical Data Daily:"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(iv_historical_data_daily)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\n IV Historical Data Hourly:")</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">#print(iv_historical_data_daily)</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Historical SMA Data Daily:"</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(historical_data_daily_SMA)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nLiquid Hours:")</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co">#print(liquid_hours)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Historical Data Daily:
     timestamp    open    high     low   close     volume      wap  barCount  \
3   2024-05-06  183.82  187.56  182.20  184.76   67560804  184.514    211750   
4   2024-05-07  182.40  183.26  177.40  177.81   56540364  179.213    188515   
5   2024-05-08  171.61  176.06  170.15  174.72   60452680  173.845    206507   
6   2024-05-09  175.04  175.62  171.37  171.97   49326575  173.059    160082   
7   2024-05-10  173.00  173.06  167.75  168.47   56253503  169.465    195279   
..         ...     ...     ...     ...     ...        ...      ...       ...   
245 2025-04-24  250.71  259.54  249.20  259.51   66589238  255.298    308174   
246 2025-04-25  261.69  286.85  259.63  284.95  121592392  277.990    539626   
247 2025-04-28  289.01  294.86  272.42  285.88  107320088  282.586    490614   
248 2025-04-29  285.46  293.29  279.46  292.03   80220219  284.814    358174   
249 2025-04-30  279.91  284.45  270.78  282.16   86840626  277.788    388239   

     trd_prd  
3    2024.19  
4    2024.19  
5    2024.19  
6    2024.19  
7    2024.19  
..       ...  
245  2025.17  
246  2025.17  
247  2025.18  
248  2025.18  
249  2025.18  

[247 rows x 9 columns]

Historical Data Hourly:
               timestamp    open    high     low   close    volume      wap  \
0    2024-05-01 09:30:00  182.00  184.11  180.42  182.79  10441797  182.492   
1    2024-05-01 10:00:00  182.79  183.17  179.41  180.86  14119172  180.777   
2    2024-05-01 11:00:00  180.89  181.94  179.01  180.00   9513004  180.165   
3    2024-05-01 12:00:00  179.99  182.88  179.71  181.22   7272803  181.450   
4    2024-05-01 13:00:00  181.22  181.25  179.82  180.98   6011126  180.507   
...                  ...     ...     ...     ...     ...       ...      ...   
1736 2025-04-30 11:00:00  276.70  281.43  276.66  278.58  12486884  278.941   
1737 2025-04-30 12:00:00  278.53  279.45  275.14  277.44   8963199  277.066   
1738 2025-04-30 13:00:00  277.43  280.24  275.33  279.15   9147764  278.138   
1739 2025-04-30 14:00:00  279.22  281.16  277.84  278.46   8842429  279.395   
1740 2025-04-30 15:00:00  278.44  284.45  278.44  282.07  14770252  282.075   

      barCount  trd_prd  
0        35696  2024.18  
1        48243  2024.18  
2        34310  2024.18  
3        23907  2024.18  
4        20066  2024.18  
...        ...      ...  
1736     53341  2025.18  
1737     38724  2025.18  
1738     39027  2025.18  
1739     39796  2025.18  
1740     71176  2025.18  

[1741 rows x 9 columns]
IV Historical Data Daily:
     timestamp      open      high       low     close  volume    wap  \
0   2024-05-01  0.481093  0.483109  0.451011  0.454455       1  0.483   
1   2024-05-02  0.459488  0.469330  0.442692  0.444137       1  0.469   
2   2024-05-03  0.446375  0.446375  0.431739  0.431977       1  0.446   
3   2024-05-06  0.435755  0.449979  0.435755  0.440089       1  0.450   
4   2024-05-07  0.442296  0.442962  0.419881  0.421135       1  0.443   
..         ...       ...       ...       ...       ...     ...    ...   
245 2025-04-24  0.671968  0.671968  0.633996  0.637854       1  0.672   
246 2025-04-25  0.638552  0.705876  0.635520  0.644997       1  0.706   
247 2025-04-28  0.634837  0.676476  0.634837  0.644505       1  0.676   
248 2025-04-29  0.644775  0.657697  0.626440  0.636044       1  0.658   
249 2025-04-30  0.636203  0.705177  0.634774  0.638933       1  0.705   

     barCount  trd_prd  
0           0  2024.18  
1           0  2024.18  
2           0  2024.18  
3           0  2024.19  
4           0  2024.19  
..        ...      ...  
245         0  2025.17  
246         0  2025.17  
247         0  2025.18  
248         0  2025.18  
249         0  2025.18  

[250 rows x 9 columns]
Historical SMA Data Daily:
     timestamp    open    high     low   close     volume      wap  barCount  \
0   2023-05-02  161.88  165.49  158.93  160.31  109355709  161.851    327664   
1   2023-05-03  160.01  165.00  159.91  160.61  101261209  163.367    312305   
2   2023-05-04  162.71  162.95  159.65  161.20   80745661  161.374    254071   
3   2023-05-05  163.97  170.79  163.51  170.06   87252277  168.131    295930   
4   2023-05-08  173.71  173.80  169.19  171.79   92489431  171.316    292637   
..         ...     ...     ...     ...     ...        ...      ...       ...   
496 2025-04-24  250.71  259.54  249.20  259.51   66589238  255.298    308174   
497 2025-04-25  261.69  286.85  259.63  284.95  121592392  277.990    539626   
498 2025-04-28  289.01  294.86  272.42  285.88  107320088  282.586    490614   
499 2025-04-29  285.46  293.29  279.46  292.03   80220219  284.814    358174   
500 2025-04-30  279.91  284.45  270.78  282.16   86840626  277.788    388239   

       SMA_20  trd_prd  
0         NaN  2023.18  
1         NaN  2023.18  
2         NaN  2023.18  
3         NaN  2023.18  
4         NaN  2023.19  
..        ...      ...  
496  252.5465  2025.17  
497  253.1375  2025.17  
498  254.2540  2025.18  
499  255.8975  2025.18  
500  256.5825  2025.18  

[501 rows x 10 columns]</code></pre>
</div>
</div>
</section>
<section id="vol" class="level3">
<h3 class="anchored" data-anchor-id="vol">Vol</h3>
<div id="0101930e" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calc Obs &amp; Exp Vol</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trade periods from daily historical data</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>trade_periods <span class="op">=</span> historical_data_daily[<span class="st">'trd_prd'</span>].unique()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate observed volatility using hourly data</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>hourly_log_returns <span class="op">=</span> np.log(historical_data_hourly[<span class="st">'close'</span>] <span class="op">/</span> historical_data_hourly[<span class="st">'close'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>hourly_vols <span class="op">=</span> hourly_log_returns.groupby(historical_data_hourly[<span class="st">'timestamp'</span>].dt.strftime(<span class="st">'%Y-%W'</span>)).std()</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert hourly vol to weekly vol (scale by sqrt(32.5))</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>weekly_vols <span class="op">=</span> hourly_vols <span class="op">*</span> np.sqrt(<span class="fl">32.5</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>vol_calcs <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>trade_periods, columns<span class="op">=</span>[<span class="st">'obs_vol'</span>, <span class="st">'exp_vol'</span>])</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>vol_calcs[<span class="st">'obs_vol'</span>] <span class="op">=</span> weekly_vols.values[:<span class="bu">len</span>(trade_periods)]</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Set expected vol (shifted obs_vol)</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>vol_calcs[<span class="st">'exp_vol'</span>] <span class="op">=</span> vol_calcs[<span class="st">'obs_vol'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co"># print("\nVolatility Calculations:")</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># print(vol_calcs)</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calc Obs &amp; Exp Vol</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trade periods from daily historical data</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>trade_periods <span class="op">=</span> historical_data_daily[<span class="st">'trd_prd'</span>].unique()</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate observed volatility using hourly data</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>hourly_log_returns <span class="op">=</span> np.log(historical_data_hourly[<span class="st">'close'</span>] <span class="op">/</span> historical_data_hourly[<span class="st">'close'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>hourly_vols <span class="op">=</span> hourly_log_returns.groupby(historical_data_hourly[<span class="st">'timestamp'</span>].dt.strftime(<span class="st">'%Y-%W'</span>)).std()</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert hourly vol to weekly vol (scale by sqrt(32.5))</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>weekly_vols <span class="op">=</span> hourly_vols <span class="op">*</span> np.sqrt(<span class="fl">32.5</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>smart_vol_calcs <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>trade_periods, columns<span class="op">=</span>[<span class="st">'obs_vol'</span>, <span class="st">'exp_vol'</span>])</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>smart_vol_calcs[<span class="st">'obs_vol'</span>] <span class="op">=</span> weekly_vols.values[:<span class="bu">len</span>(trade_periods)]</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Set expected vol (from options IV)</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trd_prd <span class="kw">in</span> smart_vol_calcs.index:</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    smart_vol_calcs.at[trd_prd, <span class="st">'exp_vol'</span>] <span class="op">=</span> iv_historical_data_daily.loc[</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        iv_historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'open'</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    ].iloc[<span class="dv">0</span>] <span class="op">*</span> np.sqrt(<span class="dv">1</span><span class="op">/</span><span class="dv">52</span>)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Volatility Calculations:"</span>)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(smart_vol_calcs)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>vol_calcs <span class="op">=</span> smart_vol_calcs</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="co">#vol_calcs = smart_vol_calcs # manually toggle active vol calc</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Volatility Calculations:
          obs_vol   exp_vol
2024.19  0.068504  0.060428
2024.20  0.061715  0.056235
2024.21  0.060780  0.057065
2024.22  0.054364   0.05865
2024.23  0.058449  0.062852
2024.24  0.037432  0.066161
2024.25  0.094526  0.063209
2024.26  0.053955  0.068624
2024.27  0.057880  0.072917
2024.28  0.092603  0.089998
2024.29  0.092234  0.087609
2024.30  0.074038  0.082953
2024.31  0.144589  0.065302
2024.32  0.089899  0.077582
2024.33  0.071581  0.067391
2024.34  0.074922  0.067607
2024.35  0.054022    0.0644
2024.36  0.066319  0.065056
2024.37  0.089354  0.084408
2024.38  0.071509  0.085434
2024.39  0.065599  0.086869
2024.40  0.059781  0.102473
2024.41  0.086492  0.091437
2024.42  0.095892  0.081762
2024.43  0.023740  0.072765
2024.44  0.155556  0.077749
2024.45  0.044636  0.069555
2024.46  0.118930  0.081791
2024.47  0.113059  0.080485
2024.48  0.084483  0.083869
2024.49  0.056495  0.069864
2024.50  0.060759  0.081762
2024.51  0.066586  0.087517
2024.52  0.120209  0.093676
2025.01  0.072765  0.098979
2025.02  0.064760  0.093683
2025.03  0.101750  0.090645
2025.04  0.058076  0.095296
2025.05  0.088851  0.084076
2025.06  0.054660  0.073864
2025.07  0.067115  0.069304
2025.08  0.079422  0.071383
2025.09  0.073297  0.070159
2025.10  0.053188  0.086255
2025.11  0.092879  0.092589
2025.12  0.113185  0.093491
2025.13  0.143258   0.09621
2025.14  0.094862   0.10395
2025.15  0.111623  0.125462
2025.16  0.131136   0.11333
2025.17  0.183519  0.098171
2025.18  0.065244  0.088036</code></pre>
</div>
</div>
</section>
<section id="blotter-ledger-initialization" class="level3">
<h3 class="anchored" data-anchor-id="blotter-ledger-initialization">Blotter &amp; Ledger Initialization</h3>
<div id="b4c77515" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trade periods from daily historical data</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>trade_periods <span class="op">=</span> historical_data_daily[<span class="st">'trd_prd'</span>].unique()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calc blotter</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>blotter <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>trade_periods[<span class="dv">1</span>:], columns<span class="op">=</span>[<span class="st">'entry_timestamp'</span>, <span class="st">'qty'</span>, <span class="st">'exit_timestamp'</span>, <span class="st">'entry_price'</span>, <span class="st">'exit_price'</span>, <span class="st">'success'</span>, <span class="st">'iv'</span>, <span class="st">'wap'</span>, <span class="st">'sma'</span>])</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>blotter[:] <span class="op">=</span> <span class="va">None</span>  <span class="co"># Set empty values</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nBlotter:")</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#print(blotter)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Ledger</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>filtered_historical <span class="op">=</span> historical_data_daily[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">!=</span> historical_data_daily[<span class="st">'trd_prd'</span>].iloc[<span class="dv">0</span>]]</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>ledger <span class="op">=</span> pd.DataFrame()</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'date'</span>] <span class="op">=</span> filtered_historical[<span class="st">'timestamp'</span>]</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'position'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'cash'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'mark'</span>] <span class="op">=</span> historical_data_daily[<span class="st">'close'</span>][<span class="dv">1</span>:]</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">#ledger['cash'] = 50000</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nLedger:")</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co">#print(ledger)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="blotter-ledger-loop" class="level3">
<h3 class="anchored" data-anchor-id="blotter-ledger-loop">Blotter &amp; Ledger Loop</h3>
<div id="d87e1142" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create function for IV percentile</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_iv_percentile_series(iv_df, window<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    iv_percentiles <span class="op">=</span> {}</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    iv_df_sorted <span class="op">=</span> iv_df.sort_values(<span class="st">"timestamp"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> iv_df_sorted.iterrows():</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        trd_prd <span class="op">=</span> row[<span class="st">'trd_prd'</span>]</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        curr_iv <span class="op">=</span> row[<span class="st">'open'</span>]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        recent_ivs <span class="op">=</span> iv_df_sorted[iv_df_sorted[<span class="st">'timestamp'</span>] <span class="op">&lt;</span> row[<span class="st">'timestamp'</span>]].tail(window)[<span class="st">'open'</span>]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(recent_ivs) <span class="op">&gt;=</span> <span class="dv">10</span>:</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>            percentile <span class="op">=</span> (recent_ivs <span class="op">&lt;</span> curr_iv).mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>            iv_percentiles[trd_prd] <span class="op">=</span> percentile</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> iv_percentiles</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># calc percentiles for each trade period...</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># want to only trade if IV percentile is &gt;50% and &lt;90%</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>iv_percentiles_by_trdprd <span class="op">=</span> calc_iv_percentile_series(iv_historical_data_daily)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># shift dict to use previous iv percentile</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>prev_iv_percentiles <span class="op">=</span> {}</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>sorted_keys <span class="op">=</span> <span class="bu">sorted</span>(iv_percentiles_by_trdprd.keys())</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(sorted_keys)):</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    curr <span class="op">=</span> sorted_keys[i]</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    prev <span class="op">=</span> sorted_keys[i <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    prev_iv_percentiles[curr] <span class="op">=</span> iv_percentiles_by_trdprd[prev]</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Blotter &amp; Ledger Loop</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="co"># This is where "backtesting" really occurs. We're calculating the blotter &amp;</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ledger that our trading system WOULD have produced.</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trd_prd <span class="kw">in</span> blotter.index:</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    entry_timestamp <span class="op">=</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'timestamp'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    entry_price <span class="op">=</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'open'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    prev_close <span class="op">=</span> historical_data_daily.loc[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">&lt;</span> trd_prd, <span class="st">'close'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    exp_vol <span class="op">=</span> vol_calcs.loc[trd_prd, <span class="st">'exp_vol'</span>]</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    iv <span class="op">=</span> iv_historical_data_daily.loc[iv_historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'wap'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    wap <span class="op">=</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'wap'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    sma <span class="op">=</span> historical_data_daily_SMA.loc[historical_data_daily_SMA[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'SMA_20'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    prev_iv <span class="op">=</span> prev_iv_percentiles.get(trd_prd, <span class="va">None</span>)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># INPUT PRE-TRADE FILTERS HERE</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prev_iv <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="kw">not</span> (<span class="dv">85</span> <span class="op">&lt;</span> prev_iv <span class="op">&lt;</span> <span class="dv">90</span>):</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"no trade"</span>)</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> entry_price <span class="op">&gt;</span> prev_close:</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="op">-</span><span class="dv">100</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>        exit_price_strategy <span class="op">=</span> entry_price <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> exp_vol)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        exit_price_strategy <span class="op">=</span> entry_price <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> exp_vol)</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    period_data <span class="op">=</span> historical_data_hourly[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd]</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>    max_high <span class="op">=</span> period_data[<span class="st">'high'</span>].<span class="bu">max</span>()</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    min_low <span class="op">=</span> period_data[<span class="st">'low'</span>].<span class="bu">min</span>()</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (qty <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> max_high <span class="op">&gt;=</span> exit_price_strategy) <span class="kw">or</span> (qty <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">and</span> min_low <span class="op">&lt;=</span> exit_price_strategy):</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> exit_price_strategy</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> qty <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>            exit_timestamp <span class="op">=</span> period_data.loc[period_data[<span class="st">'high'</span>] <span class="op">&gt;=</span> exit_price_strategy, <span class="st">'timestamp'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>            exit_high_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'high'</span>] <span class="op">&gt;=</span> exit_price_strategy, <span class="st">'high'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>            exit_low_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'high'</span>] <span class="op">&gt;=</span> exit_price_strategy, <span class="st">'low'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>            exit_timestamp <span class="op">=</span> period_data.loc[period_data[<span class="st">'low'</span>] <span class="op">&lt;=</span> exit_price_strategy, <span class="st">'timestamp'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>            exit_high_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'low'</span>] <span class="op">&lt;=</span> exit_price_strategy, <span class="st">'high'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>            exit_low_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'low'</span>] <span class="op">&lt;=</span> exit_price_strategy, <span class="st">'low'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(exit_low_price, exit_high_price, exit_price_strategy, exit_timestamp, qty)</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> qty <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> <span class="va">None</span>  <span class="co"># or set to None if preferred</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>        exit_timestamp <span class="op">=</span> entry_timestamp</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> historical_data_daily.loc[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'close'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>        <span class="co">#exit_timestamp = historical_data_daily.loc[historical_data_daily['trd_prd'] == trd_prd, 'timestamp'].iloc[-1]</span></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>        exit_timestamp <span class="op">=</span> pd.to_datetime(</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>        historical_data_daily.loc[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'timestamp'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]).replace(hour<span class="op">=</span><span class="dv">15</span>, minute<span class="op">=</span><span class="dv">0</span>, second<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>    blotter.loc[trd_prd] <span class="op">=</span> [entry_timestamp, qty, exit_timestamp, entry_price, exit_price, success, iv, wap, sma]</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'position'</span>] <span class="op">+=</span> qty</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'position'</span>] <span class="op">-=</span> qty</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'cash'</span>] <span class="op">-=</span> qty <span class="op">*</span> entry_price</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'cash'</span>] <span class="op">+=</span> qty <span class="op">*</span> exit_price</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a><span class="co"># finally, calculate your strategy's end-of-day mark-to-market value</span></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> ledger[<span class="st">'position'</span>] <span class="op">*</span> ledger[<span class="st">'mark'</span>] <span class="op">+</span> ledger[<span class="st">'cash'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade
no trade</code></pre>
</div>
</div>
</section>
<section id="extra" class="level3">
<h3 class="anchored" data-anchor-id="extra">Extra</h3>
<div id="9b5daaec" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> blotter[[<span class="st">'iv'</span>, <span class="st">'wap'</span>, <span class="st">'sma'</span>]]</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> blotter[<span class="st">'success'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Split train/test</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y.value_counts())</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> LogisticRegression()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># y_pred = model.predict(X_test) # 0.5 threshold</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> model.predict_proba(X_test)[:, <span class="dv">1</span>]</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> (probs <span class="op">&gt;</span> <span class="fl">0.3</span>).astype(<span class="bu">int</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>fill <span class="op">=</span> <span class="bu">len</span>(y_train)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>padded_y_pred <span class="op">=</span> np.concatenate(([<span class="fl">1.0</span>] <span class="op">*</span> fill, y_pred))</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'prediction'</span>] <span class="op">=</span> pd.Series(padded_y_pred, index<span class="op">=</span>blotter.index)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Results</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Coefficients:"</span>, model.coef_)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Intercept:"</span>, model.intercept_)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, y_pred))</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Blotter"</span>, blotter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>success
0    33
1    18
Name: count, dtype: int64
Coefficients: [[-0.06087965  0.00140635  0.00508984]]
Intercept: [-2.73227591]
              precision    recall  f1-score   support

           0       0.33      0.50      0.40         8
           1       0.00      0.00      0.00         8

    accuracy                           0.25        16
   macro avg       0.17      0.25      0.20        16
weighted avg       0.17      0.25      0.20        16

Blotter              entry_timestamp   qty       exit_timestamp entry_price  \
2024.20  2024-05-13 09:30:00  -100  2024-05-17 15:00:00       170.0   
2024.21  2024-05-20 09:30:00  -100  2024-05-24 15:00:00      177.62   
2024.22  2024-05-28 09:30:00   100  2024-05-31 15:00:00      176.43   
2024.23  2024-06-03 09:30:00  -100  2024-06-07 15:00:00      178.13   
2024.24  2024-06-10 09:30:00   100  2024-06-13 09:30:00      176.11   
2024.25  2024-06-17 09:30:00   100  2024-06-21 15:00:00      177.95   
2024.26  2024-06-24 09:30:00  -100  2024-06-28 15:00:00      184.95   
2024.27  2024-07-01 09:30:00  -100  2024-07-05 15:00:00      201.02   
2024.28  2024-07-08 09:30:00   100  2024-07-11 09:30:00      247.74   
2024.29  2024-07-15 09:30:00  -100  2024-07-19 15:00:00      256.02   
2024.30  2024-07-22 09:30:00  -100  2024-07-24 09:30:00      244.22   
2024.31  2024-07-29 09:30:00  -100  2024-08-02 10:00:00      224.91   
2024.32  2024-08-05 09:30:00   100  2024-08-05 09:30:00      185.15   
2024.33  2024-08-12 09:30:00   100  2024-08-15 10:00:00      199.02   
2024.34  2024-08-19 09:30:00  -100  2024-08-23 15:00:00      217.05   
2024.35  2024-08-26 09:30:00   100  2024-08-30 15:00:00      218.76   
2024.36  2024-09-03 09:30:00  -100  2024-09-06 15:00:00      215.26   
2024.37  2024-09-09 09:30:00  -100  2024-09-13 15:00:00      216.03   
2024.38  2024-09-16 09:30:00   100  2024-09-20 15:00:00       229.3   
2024.39  2024-09-23 09:30:00  -100  2024-09-27 15:00:00      242.61   
2024.40  2024-09-30 09:30:00   100  2024-10-04 15:00:00      259.02   
2024.41  2024-10-07 09:30:00   100  2024-10-11 15:00:00       249.0   
2024.42  2024-10-14 09:30:00  -100  2024-10-18 15:00:00      220.13   
2024.43  2024-10-21 09:30:00   100  2024-10-24 09:30:00      218.91   
2024.44  2024-10-28 09:30:00  -100  2024-11-01 12:00:00      269.95   
2024.45  2024-11-04 09:30:00   100  2024-11-06 09:30:00      244.56   
2024.46  2024-11-11 09:30:00  -100  2024-11-14 10:00:00      346.38   
2024.47  2024-11-18 09:30:00  -100  2024-11-22 15:00:00      340.75   
2024.48  2024-11-25 09:30:00  -100  2024-11-27 10:00:00      360.56   
2024.49  2024-12-02 09:30:00  -100  2024-12-06 15:00:00      352.51   
2024.50  2024-12-09 09:30:00  -100  2024-12-13 15:00:00       397.8   
2024.51  2024-12-16 09:30:00  -100  2024-12-20 15:00:00      441.11   
2024.52  2024-12-23 09:30:00  -100  2024-12-27 15:00:00       431.0   
2025.01  2024-12-30 09:30:00   100  2025-01-03 15:00:00       419.4   
2025.02  2025-01-06 09:30:00  -100  2025-01-10 10:00:00      423.22   
2025.03  2025-01-13 09:30:00   100  2025-01-14 09:30:00      383.24   
2025.04  2025-01-21 09:30:00  -100  2025-01-24 15:00:00      432.67   
2025.05  2025-01-27 09:30:00   100  2025-01-31 15:00:00       394.9   
2025.06  2025-02-03 09:30:00   100  2025-02-07 15:00:00      386.68   
2025.07  2025-02-10 09:30:00   100  2025-02-14 15:00:00       356.4   
2025.08  2025-02-18 09:30:00   100  2025-02-21 15:00:00      355.22   
2025.09  2025-02-24 09:30:00  -100  2025-02-25 09:30:00      338.14   
2025.10  2025-03-03 09:30:00  -100  2025-03-04 09:30:00      300.32   
2025.11  2025-03-10 09:30:00   100  2025-03-14 15:00:00       252.5   
2025.12  2025-03-17 09:30:00   100  2025-03-21 15:00:00      245.01   
2025.13  2025-03-24 09:30:00  -100  2025-03-28 15:00:00      258.13   
2025.14  2025-03-31 09:30:00   100  2025-04-01 11:00:00      249.41   
2025.15  2025-04-07 09:30:00   100  2025-04-07 10:00:00       223.8   
2025.16  2025-04-14 09:30:00  -100  2025-04-17 15:00:00       258.3   
2025.17  2025-04-21 09:30:00   100  2025-04-23 09:30:00      230.27   
2025.18  2025-04-28 09:30:00  -100  2025-04-30 15:00:00      289.01   

         exit_price success     iv      wap       sma  prediction  
2024.20      177.46   False  0.429  172.588  168.2505         1.0  
2024.21      179.24   False   0.43  175.238  174.6105         1.0  
2024.22      178.08   False  0.449  174.397   177.466         1.0  
2024.23      177.48   False  0.477  180.856    176.71         1.0  
2024.24  187.761582    True  0.506  177.165  176.7725         1.0  
2024.25      183.01   False   0.48  180.164  177.7795         1.0  
2024.26      197.88   False  0.525  187.008  178.6105         1.0  
2024.27      251.52   False  0.571  204.955   183.602         1.0  
2024.28  270.035995    True  0.701  246.958  197.5075         1.0  
2024.29       239.2   False  0.675  258.883  216.7975         1.0  
2024.30  223.961197    True  0.626  248.676   233.303         1.0  
2024.31  210.222865    True  0.504   228.68   241.949         1.0  
2024.32  199.514247    True  0.775  191.031  236.2555         1.0  
2024.33  212.432237    True  0.504   197.01  222.3175         1.0  
2024.34      220.32   False  0.518  217.117   213.177         1.0  
2024.35      214.11   False  0.489  217.328   210.879         1.0  
2024.36      210.73   False  0.522  216.047  209.2715         1.0  
2024.37      230.29   False  0.624  216.879  213.5385         1.0  
2024.38      238.25   False  0.644   225.89  218.7495         1.0  
2024.39      260.46   False  0.669  245.968   223.208         1.0  
2024.40      250.08   False  0.763  262.508    235.16         1.0  
2024.41       217.8   False  0.701  246.881  242.7315         1.0  
2024.42       220.7   False  0.598  219.021  243.7365         1.0  
2024.43  234.838989    True  0.549  217.696  239.4415         1.0  
2024.44  248.961663    True  0.567  268.218  236.2515         1.0  
2024.45  261.570463    True  0.539  241.768   237.258         1.0  
2024.46  318.049321    True  0.732  345.854   254.599         1.0  
2024.47      352.56   False  0.679  341.486  281.0005         1.0  
2024.48  330.320241    True   0.63  356.733  305.7515         1.0  
2024.49      389.22   False  0.543  355.734   323.625         1.0  
2024.50      436.23   False  0.625  398.662  346.4705         1.0  
2024.51      421.06   False  0.708  441.734  371.5945         1.0  
2024.52      431.66   False  0.688  426.689   396.037         1.0  
2025.01      410.44   False  0.733    421.8  416.5675         1.0  
2025.02  383.571608    True  0.713  420.501  425.0015         1.0  
2025.03  417.978702    True  0.677  385.577  424.1305         0.0  
2025.04      406.58   False  0.708  417.007   416.712         1.0  
2025.05       404.6   False  0.636  399.837  410.7675         0.0  
2025.06      361.62   False  0.589  384.267   405.239         0.0  
2025.07      355.84   False  0.516  353.953   397.815         0.0  
2025.08       337.8   False  0.534  355.598  380.9495         1.0  
2025.09  314.416585    True  0.557  337.061   367.207         0.0  
2025.10  274.415843    True  0.702  298.757   340.405         1.0  
2025.11      249.98   False  0.901   247.49  310.8755         0.0  
2025.12      248.71   False  0.718  242.375  284.8665         1.0  
2025.13      263.55   False   0.72  263.314   259.223         0.0  
2025.14  275.336175    True  0.831  246.706   254.366         0.0  
2025.15  251.878414    True  1.108  221.791  253.9565         0.0  
2025.16      241.37   False  0.832  256.864  256.1455         0.0  
2025.17  252.875917    True  0.834  228.847   257.065         0.0  
2025.18      282.16   False  0.676  290.517   254.254         0.0  </code></pre>
</div>
</div>
</section>
</section>
<section id="outputting-interactive-blotter-ledger-final-hw-here" class="level1">
<h1>Outputting Interactive Blotter &amp; Ledger (FINAL HW HERE)</h1>
<div id="85d64e93" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your final blotter DataFrame already populated at this point</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>blotter <span class="op">=</span> blotter.<span class="bu">round</span>(<span class="dv">3</span>)  <span class="co"># Optional: round for cleaner display</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="7b950335" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display blotter as interactive table</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itables <span class="im">import</span> show</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>show(blotter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<table id="itables_2e1c402d_9653_4406_be85_8a14220eaf08" class="display nowrap" data-quarto-disable-processing="true" style="table-layout:auto;width:auto;margin:auto;caption-side:bottom">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>entry_timestamp</th>
      <th>qty</th>
      <th>exit_timestamp</th>
      <th>entry_price</th>
      <th>exit_price</th>
      <th>success</th>
      <th>iv</th>
      <th>wap</th>
      <th>sma</th>
      <th>prediction</th>
    </tr>
  </thead><tbody><tr>
<td style="vertical-align:middle; text-align:left">
<a href="https://mwouts.github.io/itables/"><svg class="main-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="64" viewbox="0 0 500 400" style="font-family: 'Droid Sans', sans-serif;">
    <g style="fill:#d9d7fc">
        <path d="M100,400H500V357H100Z"></path>
        <path d="M100,300H400V257H100Z"></path>
        <path d="M0,200H400V157H0Z"></path>
        <path d="M100,100H500V57H100Z"></path>
        <path d="M100,350H500V307H100Z"></path>
        <path d="M100,250H400V207H100Z"></path>
        <path d="M0,150H400V107H0Z"></path>
        <path d="M100,50H500V7H100Z"></path>
    </g>
    <g style="fill:#1a1366;stroke:#1a1366;">
   <rect x="100" y="7" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="5s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="0" y="107" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="3.5s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="0;0;400" dur="3.5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="207" width="300" height="43">
    <animate attributename="width" values="0;300;0" dur="3s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="100;100;400" dur="3s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="307" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="4s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="4s" repeatcount="indefinite"></animate>
  </rect>
        <g style="fill:transparent;stroke-width:8; stroke-linejoin:round" rx="5">
            <g transform="translate(45 50) rotate(-45)">
                <circle r="33" cx="0" cy="0"></circle>
                <rect x="-8" y="32" width="16" height="30"></rect>
            </g>

            <g transform="translate(450 152)">
                <polyline points="-15,-20 -35,-20 -35,40 25,40 25,20"></polyline>
                <rect x="-15" y="-40" width="60" height="60"></rect>
            </g>

            <g transform="translate(50 352)">
                <polygon points="-35,-5 0,-40 35,-5"></polygon>
                <polygon points="-35,10 0,45 35,10"></polygon>
            </g>

            <g transform="translate(75 250)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>

            <g transform="translate(425 250) rotate(180)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>
        </g>
    </g>
</svg>
</a>
Loading ITables v2.3.0 from the internet...
(need <a href="https://mwouts.github.io/itables/troubleshooting.html">help</a>?)</td>
</tr></tbody>
</table>
<link href="https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.css" rel="stylesheet">
<script type="module">
    import {DataTable, jQuery as $} from 'https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.js';

    document.querySelectorAll("#itables_2e1c402d_9653_4406_be85_8a14220eaf08:not(.dataTable)").forEach(table => {
        if (!(table instanceof HTMLTableElement))
            return;

        // Define the table data
        const data = [[2024.2, "2024-05-13 09:30:00", "-100", "2024-05-17 15:00:00", " 170.0", " 177.46", "False", " 0.429", " 172.588", " 168.2505", 1.0], [2024.21, "2024-05-20 09:30:00", "-100", "2024-05-24 15:00:00", " 177.62", " 179.24", "False", " 0.43", " 175.238", " 174.6105", 1.0], [2024.22, "2024-05-28 09:30:00", "100", "2024-05-31 15:00:00", " 176.43", " 178.08", "False", " 0.449", " 174.397", " 177.466", 1.0], [2024.23, "2024-06-03 09:30:00", "-100", "2024-06-07 15:00:00", " 178.13", " 177.48", "False", " 0.477", " 180.856", " 176.71", 1.0], [2024.24, "2024-06-10 09:30:00", "100", "2024-06-13 09:30:00", " 176.11", " 187.761582", "True", " 0.506", " 177.165", " 176.7725", 1.0], [2024.25, "2024-06-17 09:30:00", "100", "2024-06-21 15:00:00", " 177.95", " 183.01", "False", " 0.48", " 180.164", " 177.7795", 1.0], [2024.26, "2024-06-24 09:30:00", "-100", "2024-06-28 15:00:00", " 184.95", " 197.88", "False", " 0.525", " 187.008", " 178.6105", 1.0], [2024.27, "2024-07-01 09:30:00", "-100", "2024-07-05 15:00:00", " 201.02", " 251.52", "False", " 0.571", " 204.955", " 183.602", 1.0], [2024.28, "2024-07-08 09:30:00", "100", "2024-07-11 09:30:00", " 247.74", " 270.035995", "True", " 0.701", " 246.958", " 197.5075", 1.0], [2024.29, "2024-07-15 09:30:00", "-100", "2024-07-19 15:00:00", " 256.02", " 239.2", "False", " 0.675", " 258.883", " 216.7975", 1.0], [2024.3, "2024-07-22 09:30:00", "-100", "2024-07-24 09:30:00", " 244.22", " 223.961197", "True", " 0.626", " 248.676", " 233.303", 1.0], [2024.31, "2024-07-29 09:30:00", "-100", "2024-08-02 10:00:00", " 224.91", " 210.222865", "True", " 0.504", " 228.68", " 241.949", 1.0], [2024.32, "2024-08-05 09:30:00", "100", "2024-08-05 09:30:00", " 185.15", " 199.514247", "True", " 0.775", " 191.031", " 236.2555", 1.0], [2024.33, "2024-08-12 09:30:00", "100", "2024-08-15 10:00:00", " 199.02", " 212.432237", "True", " 0.504", " 197.01", " 222.3175", 1.0], [2024.34, "2024-08-19 09:30:00", "-100", "2024-08-23 15:00:00", " 217.05", " 220.32", "False", " 0.518", " 217.117", " 213.177", 1.0], [2024.35, "2024-08-26 09:30:00", "100", "2024-08-30 15:00:00", " 218.76", " 214.11", "False", " 0.489", " 217.328", " 210.879", 1.0], [2024.36, "2024-09-03 09:30:00", "-100", "2024-09-06 15:00:00", " 215.26", " 210.73", "False", " 0.522", " 216.047", " 209.2715", 1.0], [2024.37, "2024-09-09 09:30:00", "-100", "2024-09-13 15:00:00", " 216.03", " 230.29", "False", " 0.624", " 216.879", " 213.5385", 1.0], [2024.38, "2024-09-16 09:30:00", "100", "2024-09-20 15:00:00", " 229.3", " 238.25", "False", " 0.644", " 225.89", " 218.7495", 1.0], [2024.39, "2024-09-23 09:30:00", "-100", "2024-09-27 15:00:00", " 242.61", " 260.46", "False", " 0.669", " 245.968", " 223.208", 1.0], [2024.4, "2024-09-30 09:30:00", "100", "2024-10-04 15:00:00", " 259.02", " 250.08", "False", " 0.763", " 262.508", " 235.16", 1.0], [2024.41, "2024-10-07 09:30:00", "100", "2024-10-11 15:00:00", " 249.0", " 217.8", "False", " 0.701", " 246.881", " 242.7315", 1.0], [2024.42, "2024-10-14 09:30:00", "-100", "2024-10-18 15:00:00", " 220.13", " 220.7", "False", " 0.598", " 219.021", " 243.7365", 1.0], [2024.43, "2024-10-21 09:30:00", "100", "2024-10-24 09:30:00", " 218.91", " 234.838989", "True", " 0.549", " 217.696", " 239.4415", 1.0], [2024.44, "2024-10-28 09:30:00", "-100", "2024-11-01 12:00:00", " 269.95", " 248.961663", "True", " 0.567", " 268.218", " 236.2515", 1.0], [2024.45, "2024-11-04 09:30:00", "100", "2024-11-06 09:30:00", " 244.56", " 261.570463", "True", " 0.539", " 241.768", " 237.258", 1.0], [2024.46, "2024-11-11 09:30:00", "-100", "2024-11-14 10:00:00", " 346.38", " 318.049321", "True", " 0.732", " 345.854", " 254.599", 1.0], [2024.47, "2024-11-18 09:30:00", "-100", "2024-11-22 15:00:00", " 340.75", " 352.56", "False", " 0.679", " 341.486", " 281.0005", 1.0], [2024.48, "2024-11-25 09:30:00", "-100", "2024-11-27 10:00:00", " 360.56", " 330.320241", "True", " 0.63", " 356.733", " 305.7515", 1.0], [2024.49, "2024-12-02 09:30:00", "-100", "2024-12-06 15:00:00", " 352.51", " 389.22", "False", " 0.543", " 355.734", " 323.625", 1.0], [2024.5, "2024-12-09 09:30:00", "-100", "2024-12-13 15:00:00", " 397.8", " 436.23", "False", " 0.625", " 398.662", " 346.4705", 1.0], [2024.51, "2024-12-16 09:30:00", "-100", "2024-12-20 15:00:00", " 441.11", " 421.06", "False", " 0.708", " 441.734", " 371.5945", 1.0], [2024.52, "2024-12-23 09:30:00", "-100", "2024-12-27 15:00:00", " 431.0", " 431.66", "False", " 0.688", " 426.689", " 396.037", 1.0], [2025.01, "2024-12-30 09:30:00", "100", "2025-01-03 15:00:00", " 419.4", " 410.44", "False", " 0.733", " 421.8", " 416.5675", 1.0], [2025.02, "2025-01-06 09:30:00", "-100", "2025-01-10 10:00:00", " 423.22", " 383.571608", "True", " 0.713", " 420.501", " 425.0015", 1.0], [2025.03, "2025-01-13 09:30:00", "100", "2025-01-14 09:30:00", " 383.24", " 417.978702", "True", " 0.677", " 385.577", " 424.1305", 0.0], [2025.04, "2025-01-21 09:30:00", "-100", "2025-01-24 15:00:00", " 432.67", " 406.58", "False", " 0.708", " 417.007", " 416.712", 1.0], [2025.05, "2025-01-27 09:30:00", "100", "2025-01-31 15:00:00", " 394.9", " 404.6", "False", " 0.636", " 399.837", " 410.7675", 0.0], [2025.06, "2025-02-03 09:30:00", "100", "2025-02-07 15:00:00", " 386.68", " 361.62", "False", " 0.589", " 384.267", " 405.239", 0.0], [2025.07, "2025-02-10 09:30:00", "100", "2025-02-14 15:00:00", " 356.4", " 355.84", "False", " 0.516", " 353.953", " 397.815", 0.0], [2025.08, "2025-02-18 09:30:00", "100", "2025-02-21 15:00:00", " 355.22", " 337.8", "False", " 0.534", " 355.598", " 380.9495", 1.0], [2025.09, "2025-02-24 09:30:00", "-100", "2025-02-25 09:30:00", " 338.14", " 314.416585", "True", " 0.557", " 337.061", " 367.207", 0.0], [2025.1, "2025-03-03 09:30:00", "-100", "2025-03-04 09:30:00", " 300.32", " 274.415843", "True", " 0.702", " 298.757", " 340.405", 1.0], [2025.11, "2025-03-10 09:30:00", "100", "2025-03-14 15:00:00", " 252.5", " 249.98", "False", " 0.901", " 247.49", " 310.8755", 0.0], [2025.12, "2025-03-17 09:30:00", "100", "2025-03-21 15:00:00", " 245.01", " 248.71", "False", " 0.718", " 242.375", " 284.8665", 1.0], [2025.13, "2025-03-24 09:30:00", "-100", "2025-03-28 15:00:00", " 258.13", " 263.55", "False", " 0.72", " 263.314", " 259.223", 0.0], [2025.14, "2025-03-31 09:30:00", "100", "2025-04-01 11:00:00", " 249.41", " 275.336175", "True", " 0.831", " 246.706", " 254.366", 0.0], [2025.15, "2025-04-07 09:30:00", "100", "2025-04-07 10:00:00", " 223.8", " 251.878414", "True", " 1.108", " 221.791", " 253.9565", 0.0], [2025.16, "2025-04-14 09:30:00", "-100", "2025-04-17 15:00:00", " 258.3", " 241.37", "False", " 0.832", " 256.864", " 256.1455", 0.0], [2025.17, "2025-04-21 09:30:00", "100", "2025-04-23 09:30:00", " 230.27", " 252.875917", "True", " 0.834", " 228.847", " 257.065", 0.0], [2025.18, "2025-04-28 09:30:00", "-100", "2025-04-30 15:00:00", " 289.01", " 282.16", "False", " 0.676", " 290.517", " 254.254", 0.0]];

        // Define the dt_args
        let dt_args = {"layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "order": [], "warn_on_selected_rows_not_rendered": true};
        dt_args["data"] = data;

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<div id="3e4f593e" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your final ledger DataFrame already populated at this point</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ledger <span class="op">=</span> ledger.<span class="bu">round</span>(<span class="dv">2</span>)  <span class="co"># Optional: clean output</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fd79364d" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display ledger as interactive table</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>show(ledger)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<table id="itables_bedce3f9_f1b0_45a4_b8c8_57a8a4e714a9" class="display nowrap" data-quarto-disable-processing="true" style="table-layout:auto;width:auto;margin:auto;caption-side:bottom">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>position</th>
      <th>cash</th>
      <th>mark</th>
      <th>mkt_value</th>
    </tr>
  </thead><tbody><tr>
<td style="vertical-align:middle; text-align:left">
<a href="https://mwouts.github.io/itables/"><svg class="main-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="64" viewbox="0 0 500 400" style="font-family: 'Droid Sans', sans-serif;">
    <g style="fill:#d9d7fc">
        <path d="M100,400H500V357H100Z"></path>
        <path d="M100,300H400V257H100Z"></path>
        <path d="M0,200H400V157H0Z"></path>
        <path d="M100,100H500V57H100Z"></path>
        <path d="M100,350H500V307H100Z"></path>
        <path d="M100,250H400V207H100Z"></path>
        <path d="M0,150H400V107H0Z"></path>
        <path d="M100,50H500V7H100Z"></path>
    </g>
    <g style="fill:#1a1366;stroke:#1a1366;">
   <rect x="100" y="7" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="5s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="0" y="107" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="3.5s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="0;0;400" dur="3.5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="207" width="300" height="43">
    <animate attributename="width" values="0;300;0" dur="3s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="100;100;400" dur="3s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="307" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="4s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="4s" repeatcount="indefinite"></animate>
  </rect>
        <g style="fill:transparent;stroke-width:8; stroke-linejoin:round" rx="5">
            <g transform="translate(45 50) rotate(-45)">
                <circle r="33" cx="0" cy="0"></circle>
                <rect x="-8" y="32" width="16" height="30"></rect>
            </g>

            <g transform="translate(450 152)">
                <polyline points="-15,-20 -35,-20 -35,40 25,40 25,20"></polyline>
                <rect x="-15" y="-40" width="60" height="60"></rect>
            </g>

            <g transform="translate(50 352)">
                <polygon points="-35,-5 0,-40 35,-5"></polygon>
                <polygon points="-35,10 0,45 35,10"></polygon>
            </g>

            <g transform="translate(75 250)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>

            <g transform="translate(425 250) rotate(180)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>
        </g>
    </g>
</svg>
</a>
Loading ITables v2.3.0 from the internet...
(need <a href="https://mwouts.github.io/itables/troubleshooting.html">help</a>?)</td>
</tr></tbody>
</table>
<link href="https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.css" rel="stylesheet">
<script type="module">
    import {DataTable, jQuery as $} from 'https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.js';

    document.querySelectorAll("#itables_bedce3f9_f1b0_45a4_b8c8_57a8a4e714a9:not(.dataTable)").forEach(table => {
        if (!(table instanceof HTMLTableElement))
            return;

        // Define the table data
        const data = [[8, "2024-05-13", 0.0, 0.0, 171.89, 0.0], [9, "2024-05-14", -100.0, 17000.0, 177.55, -755.0], [10, "2024-05-15", -100.0, 17000.0, 173.99, -399.0], [11, "2024-05-16", -100.0, 17000.0, 174.84, -484.0], [12, "2024-05-17", -100.0, 17000.0, 177.46, -746.0], [13, "2024-05-20", 0.0, -746.0, 174.95, -746.0], [14, "2024-05-21", -100.0, 17016.0, 186.6, -1644.0], [15, "2024-05-22", -100.0, 17016.0, 180.11, -995.0], [16, "2024-05-23", -100.0, 17016.0, 173.74, -358.0], [17, "2024-05-24", -100.0, 17016.0, 179.24, -908.0], [18, "2024-05-28", 0.0, -908.0, 176.75, -908.0], [19, "2024-05-29", 100.0, -18551.0, 176.19, -932.0], [20, "2024-05-30", 100.0, -18551.0, 178.79, -672.0], [21, "2024-05-31", 100.0, -18551.0, 178.08, -743.0], [22, "2024-06-03", 0.0, -743.0, 176.29, -743.0], [23, "2024-06-04", -100.0, 17070.0, 174.77, -407.0], [24, "2024-06-05", -100.0, 17070.0, 175.0, -430.0], [25, "2024-06-06", -100.0, 17070.0, 177.94, -724.0], [26, "2024-06-07", -100.0, 17070.0, 177.48, -678.0], [27, "2024-06-10", 0.0, -678.0, 173.79, -678.0], [28, "2024-06-11", 100.0, -18289.0, 170.66, -1223.0], [29, "2024-06-12", 100.0, -18289.0, 177.29, -560.0], [30, "2024-06-13", 100.0, -18289.0, 182.47, -42.0], [31, "2024-06-14", 0.0, 487.16, 178.01, 487.16], [32, "2024-06-17", 0.0, 487.16, 187.44, 487.16], [33, "2024-06-18", 100.0, -17307.84, 184.86, 1178.16], [34, "2024-06-20", 100.0, -17307.84, 181.57, 849.16], [35, "2024-06-21", 100.0, -17307.84, 183.01, 993.16], [36, "2024-06-24", 0.0, 993.16, 182.58, 993.16], [37, "2024-06-25", -100.0, 19488.16, 187.35, 753.16], [38, "2024-06-26", -100.0, 19488.16, 196.37, -148.84], [39, "2024-06-27", -100.0, 19488.16, 197.42, -253.84], [40, "2024-06-28", -100.0, 19488.16, 197.88, -299.84], [41, "2024-07-01", 0.0, -299.84, 209.86, -299.84], [42, "2024-07-02", -100.0, 19802.16, 231.26, -3323.84], [43, "2024-07-03", -100.0, 19802.16, 246.39, -4836.84], [44, "2024-07-05", -100.0, 19802.16, 251.52, -5349.84], [45, "2024-07-08", 0.0, -5349.84, 252.94, -5349.84], [46, "2024-07-09", 100.0, -30123.84, 262.33, -3890.84], [47, "2024-07-10", 100.0, -30123.84, 263.26, -3797.84], [48, "2024-07-11", 100.0, -30123.84, 241.03, -6020.84], [49, "2024-07-12", 0.0, -3120.24, 248.23, -3120.24], [50, "2024-07-15", 0.0, -3120.24, 252.64, -3120.24], [51, "2024-07-16", -100.0, 22481.76, 256.56, -3174.24], [52, "2024-07-17", -100.0, 22481.76, 248.5, -2368.24], [53, "2024-07-18", -100.0, 22481.76, 249.23, -2441.24], [54, "2024-07-19", -100.0, 22481.76, 239.2, -1438.24], [55, "2024-07-22", 0.0, -1438.24, 251.51, -1438.24], [56, "2024-07-23", -100.0, 22983.76, 246.38, -1654.24], [57, "2024-07-24", -100.0, 22983.76, 215.99, 1384.76], [58, "2024-07-25", 0.0, 587.64, 220.25, 587.64], [59, "2024-07-26", 0.0, 587.64, 219.8, 587.64], [60, "2024-07-29", 0.0, 587.64, 232.1, 587.64], [61, "2024-07-30", -100.0, 23078.64, 222.62, 816.64], [62, "2024-07-31", -100.0, 23078.64, 232.07, -128.36], [63, "2024-08-01", -100.0, 23078.64, 216.86, 1392.64], [64, "2024-08-02", -100.0, 23078.64, 207.67, 2311.64], [65, "2024-08-05", 0.0, 2056.35, 198.88, 2056.35], [66, "2024-08-06", 0.0, 3492.78, 200.64, 3492.78], [67, "2024-08-07", 0.0, 3492.78, 191.76, 3492.78], [68, "2024-08-08", 0.0, 3492.78, 198.84, 3492.78], [69, "2024-08-09", 0.0, 3492.78, 200.0, 3492.78], [70, "2024-08-12", 0.0, 3492.78, 197.49, 3492.78], [71, "2024-08-13", 100.0, -16409.22, 207.83, 4373.78], [72, "2024-08-14", 100.0, -16409.22, 201.38, 3728.78], [73, "2024-08-15", 100.0, -16409.22, 214.14, 5004.78], [74, "2024-08-16", 0.0, 4834.0, 216.12, 4834.0], [75, "2024-08-19", 0.0, 4834.0, 222.72, 4834.0], [76, "2024-08-20", -100.0, 26539.0, 221.1, 4429.0], [77, "2024-08-21", -100.0, 26539.0, 223.27, 4212.0], [78, "2024-08-22", -100.0, 26539.0, 210.66, 5473.0], [79, "2024-08-23", -100.0, 26539.0, 220.32, 4507.0], [80, "2024-08-26", 0.0, 4507.0, 213.21, 4507.0], [81, "2024-08-27", 100.0, -17369.0, 209.21, 3552.0], [82, "2024-08-28", 100.0, -17369.0, 205.75, 3206.0], [83, "2024-08-29", 100.0, -17369.0, 206.28, 3259.0], [84, "2024-08-30", 100.0, -17369.0, 214.11, 4042.0], [85, "2024-09-03", 0.0, 4042.0, 210.6, 4042.0], [86, "2024-09-04", -100.0, 25568.0, 219.41, 3627.0], [87, "2024-09-05", -100.0, 25568.0, 230.17, 2551.0], [88, "2024-09-06", -100.0, 25568.0, 210.73, 4495.0], [89, "2024-09-09", 0.0, 4495.0, 216.27, 4495.0], [90, "2024-09-10", -100.0, 26098.0, 226.17, 3481.0], [91, "2024-09-11", -100.0, 26098.0, 228.13, 3285.0], [92, "2024-09-12", -100.0, 26098.0, 229.81, 3117.0], [93, "2024-09-13", -100.0, 26098.0, 230.29, 3069.0], [94, "2024-09-16", 0.0, 3069.0, 226.78, 3069.0], [95, "2024-09-17", 100.0, -19861.0, 227.87, 2926.0], [96, "2024-09-18", 100.0, -19861.0, 227.2, 2859.0], [97, "2024-09-19", 100.0, -19861.0, 243.92, 4531.0], [98, "2024-09-20", 100.0, -19861.0, 238.25, 3964.0], [99, "2024-09-23", 0.0, 3964.0, 250.0, 3964.0], [100, "2024-09-24", -100.0, 28225.0, 254.27, 2798.0], [101, "2024-09-25", -100.0, 28225.0, 257.02, 2523.0], [102, "2024-09-26", -100.0, 28225.0, 254.22, 2803.0], [103, "2024-09-27", -100.0, 28225.0, 260.46, 2179.0], [104, "2024-09-30", 0.0, 2179.0, 261.63, 2179.0], [105, "2024-10-01", 100.0, -23723.0, 258.02, 2079.0], [106, "2024-10-02", 100.0, -23723.0, 249.02, 1179.0], [107, "2024-10-03", 100.0, -23723.0, 240.66, 343.0], [108, "2024-10-04", 100.0, -23723.0, 250.08, 1285.0], [109, "2024-10-07", 0.0, 1285.0, 240.83, 1285.0], [110, "2024-10-08", 100.0, -23615.0, 244.5, 835.0], [111, "2024-10-09", 100.0, -23615.0, 241.05, 490.0], [112, "2024-10-10", 100.0, -23615.0, 238.77, 262.0], [113, "2024-10-11", 100.0, -23615.0, 217.8, -1835.0], [114, "2024-10-14", 0.0, -1835.0, 219.16, -1835.0], [115, "2024-10-15", -100.0, 20178.0, 219.57, -1779.0], [116, "2024-10-16", -100.0, 20178.0, 221.33, -1955.0], [117, "2024-10-17", -100.0, 20178.0, 220.89, -1911.0], [118, "2024-10-18", -100.0, 20178.0, 220.7, -1892.0], [119, "2024-10-21", 0.0, -1892.0, 218.85, -1892.0], [120, "2024-10-22", 100.0, -23783.0, 217.97, -1986.0], [121, "2024-10-23", 100.0, -23783.0, 213.65, -2418.0], [122, "2024-10-24", 100.0, -23783.0, 260.48, 2265.0], [123, "2024-10-25", 0.0, -299.1, 269.19, -299.1], [124, "2024-10-28", 0.0, -299.1, 262.51, -299.1], [125, "2024-10-29", -100.0, 26695.9, 259.52, 743.9], [126, "2024-10-30", -100.0, 26695.9, 257.55, 940.9], [127, "2024-10-31", -100.0, 26695.9, 249.85, 1710.9], [128, "2024-11-01", -100.0, 26695.9, 248.98, 1797.9], [129, "2024-11-04", 0.0, 1799.73, 242.84, 1799.73], [130, "2024-11-05", 100.0, -22656.27, 251.44, 2487.73], [131, "2024-11-06", 100.0, -22656.27, 288.53, 6196.73], [132, "2024-11-07", 0.0, 3500.78, 296.91, 3500.78], [133, "2024-11-08", 0.0, 3500.78, 321.22, 3500.78], [134, "2024-11-11", 0.0, 3500.78, 350.0, 3500.78], [135, "2024-11-12", -100.0, 38138.78, 328.49, 5289.78], [136, "2024-11-13", -100.0, 38138.78, 330.24, 5114.78], [137, "2024-11-14", -100.0, 38138.78, 311.18, 7020.78], [138, "2024-11-15", 0.0, 6333.85, 320.72, 6333.85], [139, "2024-11-18", 0.0, 6333.85, 338.74, 6333.85], [140, "2024-11-19", -100.0, 40408.85, 346.0, 5808.85], [141, "2024-11-20", -100.0, 40408.85, 342.03, 6205.85], [142, "2024-11-21", -100.0, 40408.85, 339.64, 6444.85], [143, "2024-11-22", -100.0, 40408.85, 352.56, 5152.85], [144, "2024-11-25", 0.0, 5152.85, 338.59, 5152.85], [145, "2024-11-26", -100.0, 41208.85, 338.23, 7385.85], [146, "2024-11-27", -100.0, 41208.85, 332.89, 7919.85], [147, "2024-11-29", 0.0, 8176.82, 345.16, 8176.82], [148, "2024-12-02", 0.0, 8176.82, 357.09, 8176.82], [149, "2024-12-03", -100.0, 43427.82, 351.42, 8285.82], [150, "2024-12-04", -100.0, 43427.82, 357.93, 7634.82], [151, "2024-12-05", -100.0, 43427.82, 369.49, 6478.82], [152, "2024-12-06", -100.0, 43427.82, 389.22, 4505.82], [153, "2024-12-09", 0.0, 4505.82, 389.79, 4505.82], [154, "2024-12-10", -100.0, 44285.82, 400.99, 4186.82], [155, "2024-12-11", -100.0, 44285.82, 424.77, 1808.82], [156, "2024-12-12", -100.0, 44285.82, 418.1, 2475.82], [157, "2024-12-13", -100.0, 44285.82, 436.23, 662.82], [158, "2024-12-16", 0.0, 662.82, 463.02, 662.82], [159, "2024-12-17", -100.0, 44773.82, 479.86, -3212.18], [160, "2024-12-18", -100.0, 44773.82, 440.13, 760.82], [161, "2024-12-19", -100.0, 44773.82, 436.17, 1156.82], [162, "2024-12-20", -100.0, 44773.82, 421.06, 2667.82], [163, "2024-12-23", 0.0, 2667.82, 430.6, 2667.82], [164, "2024-12-24", -100.0, 45767.82, 462.28, -460.18], [165, "2024-12-26", -100.0, 45767.82, 454.13, 354.82], [166, "2024-12-27", -100.0, 45767.82, 431.66, 2601.82], [167, "2024-12-30", 0.0, 2601.82, 417.41, 2601.82], [168, "2024-12-31", 100.0, -39338.18, 403.84, 1045.82], [169, "2025-01-02", 100.0, -39338.18, 379.28, -1410.18], [170, "2025-01-03", 100.0, -39338.18, 410.44, 1705.82], [171, "2025-01-06", 0.0, 1705.82, 411.05, 1705.82], [172, "2025-01-07", -100.0, 44027.82, 394.36, 4591.82], [173, "2025-01-08", -100.0, 44027.82, 394.94, 4533.82], [174, "2025-01-10", -100.0, 44027.82, 394.74, 4553.82], [175, "2025-01-13", 0.0, 5670.66, 403.31, 5670.66], [176, "2025-01-14", 100.0, -32653.34, 396.36, 6982.66], [177, "2025-01-15", 0.0, 9144.53, 428.22, 9144.53], [178, "2025-01-16", 0.0, 9144.53, 413.82, 9144.53], [179, "2025-01-17", 0.0, 9144.53, 426.5, 9144.53], [180, "2025-01-21", 0.0, 9144.53, 424.07, 9144.53], [181, "2025-01-22", -100.0, 52411.53, 415.11, 10900.53], [182, "2025-01-23", -100.0, 52411.53, 412.38, 11173.53], [183, "2025-01-24", -100.0, 52411.53, 406.58, 11753.53], [184, "2025-01-27", 0.0, 11753.53, 397.15, 11753.53], [185, "2025-01-28", 100.0, -27736.47, 398.09, 12072.53], [186, "2025-01-29", 100.0, -27736.47, 389.1, 11173.53], [187, "2025-01-30", 100.0, -27736.47, 400.28, 12291.53], [188, "2025-01-31", 100.0, -27736.47, 404.6, 12723.53], [189, "2025-02-03", 0.0, 12723.53, 383.68, 12723.53], [190, "2025-02-04", 100.0, -25944.47, 392.21, 13276.53], [191, "2025-02-05", 100.0, -25944.47, 378.17, 11872.53], [192, "2025-02-06", 100.0, -25944.47, 374.32, 11487.53], [193, "2025-02-07", 100.0, -25944.47, 361.62, 10217.53], [194, "2025-02-10", 0.0, 10217.53, 350.73, 10217.53], [195, "2025-02-11", 100.0, -25422.47, 328.5, 7427.53], [196, "2025-02-12", 100.0, -25422.47, 336.51, 8228.53], [197, "2025-02-13", 100.0, -25422.47, 355.94, 10171.53], [198, "2025-02-14", 100.0, -25422.47, 355.84, 10161.53], [199, "2025-02-18", 0.0, 10161.53, 354.11, 10161.53], [200, "2025-02-19", 100.0, -25360.47, 360.56, 10695.53], [201, "2025-02-20", 100.0, -25360.47, 354.4, 10079.53], [202, "2025-02-21", 100.0, -25360.47, 337.8, 8419.53], [203, "2025-02-24", 0.0, 8419.53, 330.53, 8419.53], [204, "2025-02-25", -100.0, 42233.53, 302.8, 11953.53], [205, "2025-02-26", 0.0, 10791.87, 290.8, 10791.87], [206, "2025-02-27", 0.0, 10791.87, 281.95, 10791.87], [207, "2025-02-28", 0.0, 10791.87, 292.98, 10791.87], [208, "2025-03-03", 0.0, 10791.87, 284.65, 10791.87], [209, "2025-03-04", -100.0, 40823.87, 272.04, 13619.87], [210, "2025-03-05", 0.0, 13382.29, 279.1, 13382.29], [211, "2025-03-06", 0.0, 13382.29, 263.45, 13382.29], [212, "2025-03-07", 0.0, 13382.29, 262.67, 13382.29], [213, "2025-03-10", 0.0, 13382.29, 222.15, 13382.29], [214, "2025-03-11", 100.0, -11867.71, 230.58, 11190.29], [215, "2025-03-12", 100.0, -11867.71, 248.09, 12941.29], [216, "2025-03-13", 100.0, -11867.71, 240.68, 12200.29], [217, "2025-03-14", 100.0, -11867.71, 249.98, 13130.29], [218, "2025-03-17", 0.0, 13130.29, 238.01, 13130.29], [219, "2025-03-18", 100.0, -11370.71, 225.31, 11160.29], [220, "2025-03-19", 100.0, -11370.71, 235.86, 12215.29], [221, "2025-03-20", 100.0, -11370.71, 236.26, 12255.29], [222, "2025-03-21", 100.0, -11370.71, 248.71, 13500.29], [223, "2025-03-24", 0.0, 13500.29, 278.39, 13500.29], [224, "2025-03-25", -100.0, 39313.29, 288.14, 10499.29], [225, "2025-03-26", -100.0, 39313.29, 272.06, 12107.29], [226, "2025-03-27", -100.0, 39313.29, 273.13, 12000.29], [227, "2025-03-28", -100.0, 39313.29, 263.55, 12958.29], [228, "2025-03-31", 0.0, 12958.29, 259.16, 12958.29], [229, "2025-04-01", 100.0, -11982.71, 268.46, 14863.29], [230, "2025-04-02", 0.0, 15550.91, 282.76, 15550.91], [231, "2025-04-03", 0.0, 15550.91, 267.28, 15550.91], [232, "2025-04-04", 0.0, 15550.91, 239.43, 15550.91], [233, "2025-04-07", 0.0, 15550.91, 233.29, 15550.91], [234, "2025-04-08", 0.0, 18358.75, 221.86, 18358.75], [235, "2025-04-09", 0.0, 18358.75, 272.2, 18358.75], [236, "2025-04-10", 0.0, 18358.75, 252.4, 18358.75], [237, "2025-04-11", 0.0, 18358.75, 252.31, 18358.75], [238, "2025-04-14", 0.0, 18358.75, 252.35, 18358.75], [239, "2025-04-15", -100.0, 44188.75, 254.11, 18777.75], [240, "2025-04-16", -100.0, 44188.75, 241.55, 20033.75], [241, "2025-04-17", -100.0, 44188.75, 241.37, 20051.75], [242, "2025-04-21", 0.0, 20051.75, 227.5, 20051.75], [243, "2025-04-22", 100.0, -2975.25, 237.97, 20821.75], [244, "2025-04-23", 100.0, -2975.25, 250.74, 22098.75], [245, "2025-04-24", 0.0, 22312.34, 259.51, 22312.34], [246, "2025-04-25", 0.0, 22312.34, 284.95, 22312.34], [247, "2025-04-28", 0.0, 22312.34, 285.88, 22312.34], [248, "2025-04-29", -100.0, 51213.34, 292.03, 22010.34], [249, "2025-04-30", -100.0, 51213.34, 282.16, 22997.34]];

        // Define the dt_args
        let dt_args = {"layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "order": [], "warn_on_selected_rows_not_rendered": true};
        dt_args["data"] = data;

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<section id="navcharts-extra-not-necessary" class="level3">
<h3 class="anchored" data-anchor-id="navcharts-extra-not-necessary">NAV/Charts &amp; Extra (not necessary)</h3>
<div id="9998ee37" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list to store categories</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>position_category <span class="op">=</span> []</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Categorize positions manually</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pos <span class="kw">in</span> ledger[<span class="st">'position'</span>]:</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Long'</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> pos <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Short'</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Cash Only'</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Add category column to ledger</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'position_category'</span>] <span class="op">=</span> position_category</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for each category</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> {<span class="st">'Long'</span>: <span class="st">'green'</span>, <span class="st">'Short'</span>: <span class="st">'red'</span>, <span class="st">'Cash Only'</span>: <span class="st">'blue'</span>}</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> []</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign colors manually</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat <span class="kw">in</span> ledger[<span class="st">'position_category'</span>]:</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    colors.append(color_map[cat])</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot NAV over time</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>plt.scatter(ledger[<span class="st">'date'</span>], ledger[<span class="st">'mkt_value'</span>], c<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Net Asset Value (NAV)'</span>)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'NAV Over Time with Position Coloring, Standard Model'</span>)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually add legend</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat, color <span class="kw">in</span> color_map.items():</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    plt.scatter([], [], color<span class="op">=</span>color, label<span class="op">=</span>cat)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Ledger</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>filtered_historical <span class="op">=</span> historical_data_daily[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">!=</span> historical_data_daily[<span class="st">'trd_prd'</span>].iloc[<span class="dv">0</span>]]</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>new_ledger <span class="op">=</span> pd.DataFrame()</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'date'</span>] <span class="op">=</span> filtered_historical[<span class="st">'timestamp'</span>]</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'position'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'cash'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'mark'</span>] <span class="op">=</span> historical_data_daily[<span class="st">'close'</span>][<span class="dv">1</span>:]</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="co">#new_ledger['cash'] = 50000</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trd_prd <span class="kw">in</span> blotter.index:</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> blotter.loc[trd_prd][<span class="st">'prediction'</span>] <span class="op">==</span> <span class="dv">0</span>: <span class="co"># if the trade is predicted to fail, no trade</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># if in train set or predicted success, make the trade</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> blotter.loc[trd_prd, <span class="st">'qty'</span>]</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    entry_price <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'entry_price'</span>]</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    entry_timestamp <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'entry_timestamp'</span>]</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    exit_timestamp <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'exit_timestamp'</span>]</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    exit_price <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'exit_price'</span>]</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'position'</span>] <span class="op">+=</span> qty</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'position'</span>] <span class="op">-=</span> qty</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'cash'</span>] <span class="op">-=</span> qty <span class="op">*</span> entry_price</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'cash'</span>] <span class="op">+=</span> qty <span class="op">*</span> exit_price</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a><span class="co"># finally, calculate your strategy's end-of-day mark-to-market value</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> new_ledger[<span class="st">'position'</span>] <span class="op">*</span> new_ledger[<span class="st">'mark'</span>] <span class="op">+</span> new_ledger[<span class="st">'cash'</span>]</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_ledger)</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list to store categories</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>position_category <span class="op">=</span> []</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Categorize positions manually</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pos <span class="kw">in</span> new_ledger[<span class="st">'position'</span>]:</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Long'</span>)</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> pos <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Short'</span>)</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Cash Only'</span>)</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Add category column to new_ledger</span></span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'position_category'</span>] <span class="op">=</span> position_category</span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for each category</span></span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> {<span class="st">'Long'</span>: <span class="st">'green'</span>, <span class="st">'Short'</span>: <span class="st">'red'</span>, <span class="st">'Cash Only'</span>: <span class="st">'blue'</span>}</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> []</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign colors manually</span></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat <span class="kw">in</span> new_ledger[<span class="st">'position_category'</span>]:</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>    colors.append(color_map[cat])</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot NAV over time</span></span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>plt.scatter(new_ledger[<span class="st">'date'</span>], new_ledger[<span class="st">'mkt_value'</span>], c<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Net Asset Value (NAV)'</span>)</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'NAV Over Time with Position Coloring, Enhanced Model'</span>)</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually add legend</span></span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat, color <span class="kw">in</span> color_map.items():</span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>    plt.scatter([], [], color<span class="op">=</span>color, label<span class="op">=</span>cat)</span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return'</span>] <span class="op">=</span> ((blotter[<span class="st">'exit_price'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price'</span>]) <span class="op">/</span> blotter[<span class="st">'entry_price'</span>]) <span class="op">*</span> (blotter[<span class="st">'qty'</span>] <span class="op">/</span> <span class="bu">abs</span>(blotter[<span class="st">'qty'</span>])) <span class="co"># get returns irrespective of long/short</span></span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nExit Timestamps:")</span></span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a><span class="co">#print(blotter['exit_timestamp'])</span></span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch entry and exit prices from historical_data_hourly based on timestamps</span></span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'entry_price_underlying'</span>] <span class="op">=</span> blotter[<span class="st">'entry_timestamp'</span>].<span class="bu">apply</span>(</span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> ts: historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> ts, <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">=</span> blotter.<span class="bu">apply</span>(</span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: (</span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a>        historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> (</span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a>            historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="va">None</span>  <span class="co"># If neither dataset has the timestamp</span></span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a>    ), axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate return based on hourly data</span></span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return_underlying'</span>] <span class="op">=</span> (blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price_underlying'</span>]) <span class="op">/</span> blotter[<span class="st">'entry_price_underlying'</span>]<span class="op">*</span> (blotter[<span class="st">'qty'</span>] <span class="op">/</span> <span class="bu">abs</span>(blotter[<span class="st">'qty'</span>]))</span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return_underlying'</span>])</span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a>original_index <span class="op">=</span> x.index.copy()</span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a>x.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a>dropped_rows <span class="op">=</span> original_index.difference(x.index)</span>
<span id="cb20-138"><a href="#cb20-138" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return'</span>])</span>
<span id="cb20-139"><a href="#cb20-139" aria-hidden="true" tabindex="-1"></a>y.drop(index<span class="op">=</span>dropped_rows, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot of returns</span></span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a>plt.scatter(x, y, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">"Trades"</span>)</span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Underlying Return"</span>)</span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Strategy Return"</span>)</span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Strategy Return vs. Underlying Return, Standard Model"</span>)</span>
<span id="cb20-147"><a href="#cb20-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-148"><a href="#cb20-148" aria-hidden="true" tabindex="-1"></a><span class="co">#print(x,y)</span></span>
<span id="cb20-149"><a href="#cb20-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-150"><a href="#cb20-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a linear regression model to get alpha and beta</span></span>
<span id="cb20-151"><a href="#cb20-151" aria-hidden="true" tabindex="-1"></a>x_with_const <span class="op">=</span> sm.add_constant(x)  <span class="co"># Adds intercept for regression</span></span>
<span id="cb20-152"><a href="#cb20-152" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.OLS(y, x_with_const).fit()</span>
<span id="cb20-153"><a href="#cb20-153" aria-hidden="true" tabindex="-1"></a>alpha, beta <span class="op">=</span> model.params</span>
<span id="cb20-154"><a href="#cb20-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-155"><a href="#cb20-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot regression line</span></span>
<span id="cb20-156"><a href="#cb20-156" aria-hidden="true" tabindex="-1"></a>plt.plot(x, alpha <span class="op">+</span> beta <span class="op">*</span> x, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="ss">f"Regression Line (α=</span><span class="sc">{</span>alpha<span class="sc">:.4f}</span><span class="ss">, β=</span><span class="sc">{</span>beta<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb20-157"><a href="#cb20-157" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb20-158"><a href="#cb20-158" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-159"><a href="#cb20-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-160"><a href="#cb20-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Print alpha and beta values</span></span>
<span id="cb20-161"><a href="#cb20-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-162"><a href="#cb20-162" aria-hidden="true" tabindex="-1"></a>alpha, beta</span>
<span id="cb20-163"><a href="#cb20-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-164"><a href="#cb20-164" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return'</span>] <span class="op">=</span> ((blotter[<span class="st">'exit_price'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price'</span>]) <span class="op">/</span> blotter[<span class="st">'entry_price'</span>]) <span class="op">*</span> (blotter[<span class="st">'qty'</span>] <span class="op">/</span> <span class="bu">abs</span>(blotter[<span class="st">'qty'</span>])) <span class="op">*</span> blotter[<span class="st">'prediction'</span>]<span class="co"># get returns irrespective of long/short</span></span>
<span id="cb20-165"><a href="#cb20-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-166"><a href="#cb20-166" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nExit Timestamps:")</span></span>
<span id="cb20-167"><a href="#cb20-167" aria-hidden="true" tabindex="-1"></a><span class="co">#print(blotter['exit_timestamp'])</span></span>
<span id="cb20-168"><a href="#cb20-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-169"><a href="#cb20-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch entry and exit prices from historical_data_hourly based on timestamps</span></span>
<span id="cb20-170"><a href="#cb20-170" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'entry_price_underlying'</span>] <span class="op">=</span> blotter[<span class="st">'entry_timestamp'</span>].<span class="bu">apply</span>(</span>
<span id="cb20-171"><a href="#cb20-171" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> ts: historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> ts, <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-172"><a href="#cb20-172" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-173"><a href="#cb20-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-174"><a href="#cb20-174" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">=</span> blotter.<span class="bu">apply</span>(</span>
<span id="cb20-175"><a href="#cb20-175" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: (</span>
<span id="cb20-176"><a href="#cb20-176" aria-hidden="true" tabindex="-1"></a>        historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-177"><a href="#cb20-177" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb20-178"><a href="#cb20-178" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> (</span>
<span id="cb20-179"><a href="#cb20-179" aria-hidden="true" tabindex="-1"></a>            historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-180"><a href="#cb20-180" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb20-181"><a href="#cb20-181" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="va">None</span>  <span class="co"># If neither dataset has the timestamp</span></span>
<span id="cb20-182"><a href="#cb20-182" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-183"><a href="#cb20-183" aria-hidden="true" tabindex="-1"></a>    ), axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb20-184"><a href="#cb20-184" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-185"><a href="#cb20-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-186"><a href="#cb20-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate return based on hourly data</span></span>
<span id="cb20-187"><a href="#cb20-187" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return_underlying'</span>] <span class="op">=</span> (blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price_underlying'</span>]) <span class="op">/</span> blotter[<span class="st">'entry_price_underlying'</span>]<span class="op">*</span> (blotter[<span class="st">'qty'</span>] <span class="op">/</span> <span class="bu">abs</span>(blotter[<span class="st">'qty'</span>]))</span>
<span id="cb20-188"><a href="#cb20-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-189"><a href="#cb20-189" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return_underlying'</span>])</span>
<span id="cb20-190"><a href="#cb20-190" aria-hidden="true" tabindex="-1"></a>original_index <span class="op">=</span> x.index.copy()</span>
<span id="cb20-191"><a href="#cb20-191" aria-hidden="true" tabindex="-1"></a>x.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-192"><a href="#cb20-192" aria-hidden="true" tabindex="-1"></a>dropped_rows <span class="op">=</span> original_index.difference(x.index)</span>
<span id="cb20-193"><a href="#cb20-193" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return'</span>])</span>
<span id="cb20-194"><a href="#cb20-194" aria-hidden="true" tabindex="-1"></a>y.drop(index<span class="op">=</span>dropped_rows, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-195"><a href="#cb20-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-196"><a href="#cb20-196" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot of returns</span></span>
<span id="cb20-197"><a href="#cb20-197" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb20-198"><a href="#cb20-198" aria-hidden="true" tabindex="-1"></a>plt.scatter(x, y, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">"Trades"</span>)</span>
<span id="cb20-199"><a href="#cb20-199" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Underlying Return"</span>)</span>
<span id="cb20-200"><a href="#cb20-200" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Strategy Return"</span>)</span>
<span id="cb20-201"><a href="#cb20-201" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Strategy Return vs. Underlying Return, Enhanced Model"</span>)</span>
<span id="cb20-202"><a href="#cb20-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-203"><a href="#cb20-203" aria-hidden="true" tabindex="-1"></a><span class="co">#print(x,y)</span></span>
<span id="cb20-204"><a href="#cb20-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-205"><a href="#cb20-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a linear regression model to get alpha and beta</span></span>
<span id="cb20-206"><a href="#cb20-206" aria-hidden="true" tabindex="-1"></a>x_with_const <span class="op">=</span> sm.add_constant(x)  <span class="co"># Adds intercept for regression</span></span>
<span id="cb20-207"><a href="#cb20-207" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.OLS(y, x_with_const).fit()</span>
<span id="cb20-208"><a href="#cb20-208" aria-hidden="true" tabindex="-1"></a>alpha, beta <span class="op">=</span> model.params</span>
<span id="cb20-209"><a href="#cb20-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-210"><a href="#cb20-210" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot regression line</span></span>
<span id="cb20-211"><a href="#cb20-211" aria-hidden="true" tabindex="-1"></a>plt.plot(x, alpha <span class="op">+</span> beta <span class="op">*</span> x, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="ss">f"Regression Line (α=</span><span class="sc">{</span>alpha<span class="sc">:.4f}</span><span class="ss">, β=</span><span class="sc">{</span>beta<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb20-212"><a href="#cb20-212" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb20-213"><a href="#cb20-213" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-214"><a href="#cb20-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-215"><a href="#cb20-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Print alpha and beta values</span></span>
<span id="cb20-216"><a href="#cb20-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-217"><a href="#cb20-217" aria-hidden="true" tabindex="-1"></a>alpha, beta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>          date  position          cash    mark    mkt_value
8   2024-05-13       0.0      0.000000  171.89     0.000000
9   2024-05-14    -100.0  17000.000000  177.55  -755.000000
10  2024-05-15    -100.0  17000.000000  173.99  -399.000000
11  2024-05-16    -100.0  17000.000000  174.84  -484.000000
12  2024-05-17    -100.0  17000.000000  177.46  -746.000000
..         ...       ...           ...     ...          ...
245 2025-04-24       0.0   9498.077468  259.51  9498.077468
246 2025-04-25       0.0   9498.077468  284.95  9498.077468
247 2025-04-28       0.0   9498.077468  285.88  9498.077468
248 2025-04-29       0.0   9498.077468  292.03  9498.077468
249 2025-04-30       0.0   9498.077468  282.16  9498.077468

[242 rows x 5 columns]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>