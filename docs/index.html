<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>thesctrading</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-985aa47af68dae11cd4d235c71fb941e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-c1fac2584b48ed01fb6e278e36375074.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">thesctrading</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sc-trading-strategy-overview" id="toc-sc-trading-strategy-overview" class="nav-link active" data-scroll-target="#sc-trading-strategy-overview">S&amp;C Trading Strategy Overview</a>
  <ul class="collapse">
  <li><a href="#strategy-outline" id="toc-strategy-outline" class="nav-link" data-scroll-target="#strategy-outline">1. Strategy Outline</a></li>
  <li><a href="#exit-strategy" id="toc-exit-strategy" class="nav-link" data-scroll-target="#exit-strategy">2. Exit Strategy</a></li>
  <li><a href="#position-sizing-framework" id="toc-position-sizing-framework" class="nav-link" data-scroll-target="#position-sizing-framework">3. Position Sizing Framework</a></li>
  <li><a href="#data-requirements" id="toc-data-requirements" class="nav-link" data-scroll-target="#data-requirements">4. Data Requirements</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">5. Next Steps</a></li>
  <li><a href="#fred-data-software-developer-job-postings" id="toc-fred-data-software-developer-job-postings" class="nav-link" data-scroll-target="#fred-data-software-developer-job-postings">6. FRED Data: Software Developer Job Postings</a></li>
  </ul></li>
  <li><a href="#blotter-ledger-code" id="toc-blotter-ledger-code" class="nav-link" data-scroll-target="#blotter-ledger-code">Blotter &amp; Ledger Code</a>
  <ul class="collapse">
  <li><a href="#fetch-data" id="toc-fetch-data" class="nav-link" data-scroll-target="#fetch-data">Fetch data</a></li>
  <li><a href="#clean-data" id="toc-clean-data" class="nav-link" data-scroll-target="#clean-data">Clean Data</a></li>
  <li><a href="#print-dfs" id="toc-print-dfs" class="nav-link" data-scroll-target="#print-dfs">Print DFs</a></li>
  <li><a href="#vol" id="toc-vol" class="nav-link" data-scroll-target="#vol">Vol</a></li>
  <li><a href="#blotter-ledger-initialization" id="toc-blotter-ledger-initialization" class="nav-link" data-scroll-target="#blotter-ledger-initialization">Blotter &amp; Ledger Initialization</a></li>
  <li><a href="#blotter-ledger-loop" id="toc-blotter-ledger-loop" class="nav-link" data-scroll-target="#blotter-ledger-loop">Blotter &amp; Ledger Loop</a></li>
  <li><a href="#extra" id="toc-extra" class="nav-link" data-scroll-target="#extra">Extra</a></li>
  </ul></li>
  <li><a href="#outputting-interactive-blotter-ledger-final-hw-here" id="toc-outputting-interactive-blotter-ledger-final-hw-here" class="nav-link" data-scroll-target="#outputting-interactive-blotter-ledger-final-hw-here">Outputting Interactive Blotter &amp; Ledger (FINAL HW HERE)</a>
  <ul class="collapse">
  <li><a href="#navcharts-extra" id="toc-navcharts-extra" class="nav-link" data-scroll-target="#navcharts-extra">NAV/Charts &amp; Extra</a></li>
  <li><a href="#performance-statistics" id="toc-performance-statistics" class="nav-link" data-scroll-target="#performance-statistics">7. Performance Statistics</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">thesctrading</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sc-trading-strategy-overview" class="level2">
<h2 class="anchored" data-anchor-id="sc-trading-strategy-overview">S&amp;C Trading Strategy Overview</h2>
<section id="strategy-outline" class="level3">
<h3 class="anchored" data-anchor-id="strategy-outline">1. Strategy Outline</h3>
<p>Our team is implementing a buy low / sell high strategy focused on short-term momentum trading in TSLA stock. We aim to take advantage of periods of elevated volatility and momentum, holding positions for 10 trading days or less. We use the 10 day window to account for the fact that some of our data sources are weekly and may provide more signal over a longer trade horizon. Of course, if the system hits its limit point during the window, the position will close similar to our HW1 model.</p>
<p><em>note that we plan to use backward elimination ML method to determine most important features. We plan to trial a variety of alternative data features from FRED (detailed at the end of the website) as well as some competitor company technical factors. <strong>We also wish to include valuation metrics using the yfinance package.</strong></em></p>
<section id="example-trade-walkthrough" class="level4">
<h4 class="anchored" data-anchor-id="example-trade-walkthrough">Example Trade Walkthrough</h4>
<p>Pre-Trade Filter</p>
<ol type="1">
<li>Check if job postings for software roles increased week-over-week (as well as other FRED/alternative data including pairs performance)</li>
<li>Check if implied volatility (IV) percentile &gt; 40% and &lt; 90%</li>
<li>If both are true → proceed to trade evaluation</li>
</ol>
<hr>
<p>Buy Conditions</p>
<ol type="1">
<li>Price is above the 50-day SMA (or EMA) <em>note we may also include valuation metrics here to avoid extreme overvaluation given our long-only strategy</em></li>
<li>Gamma exposure is positive (or some other Greek we can calculate)</li>
</ol>
<hr>
</section>
</section>
<section id="exit-strategy" class="level3">
<h3 class="anchored" data-anchor-id="exit-strategy">2. Exit Strategy</h3>
<p>We use four exit triggers to manage risk and lock in profits:</p>
<ol type="1">
<li>If position is open for more than 10 trading days, exit regardless of performance</li>
<li>If IV percentile drops below 30%, exit</li>
<li>Exit if price reaches a profit target of 2x last week’s average true range (ATR)</li>
<li>Use a trailing stop loss of 1.5x ATR below the highest price reached since entry</li>
</ol>
<hr>
</section>
<section id="position-sizing-framework" class="level3">
<h3 class="anchored" data-anchor-id="position-sizing-framework">3. Position Sizing Framework</h3>
<p>Position size will adapt based on strength of indicators and perhaps on a regression of additional features not used to determine the weekly position strategy similar to the logistic regression model used in HW1. We envision a less binary model where sizing is continuous determined on a variety of features (allows us to take risk off but also keep risk on more granularly than the original model).</p>
<p>Conditions for each tier will be finalized after further backtesting.</p>
<hr>
</section>
<section id="data-requirements" class="level3">
<h3 class="anchored" data-anchor-id="data-requirements">4. Data Requirements</h3>
<p>We plan to collect and process:</p>
<ul>
<li>Price data and technical indicators (SMA, ATR, IV, Options contracts)</li>
<li>Job posting data &amp; other relevant metrics from FRED</li>
<li>Automotive industry data from FRED</li>
<li>Implied volatility percentile data (via IBKR)</li>
</ul>
<p>We may use the FRED API, yFinance, or custom scrapers to automate data gathering.</p>
<hr>
</section>
<section id="next-steps" class="level3">
<h3 class="anchored" data-anchor-id="next-steps">5. Next Steps</h3>
<ul>
<li>Gather full feature list and find good alt data and implement backward elimination model to decide useful features</li>
<li>Build &amp; backtest position sizing model</li>
<li>Backtest the strategy on historical TSLA data</li>
<li>Deploy the final version to https://thesctrading.com</li>
</ul>
</section>
<section id="fred-data-software-developer-job-postings" class="level3">
<h3 class="anchored" data-anchor-id="fred-data-software-developer-job-postings">6. FRED Data: Software Developer Job Postings</h3>
<p>The below is demonstrating our ability to use the FRED API to pull in features. This example is weekly software job postings. We plan to scour FRED to identify other features that may be useful. Other things may include potential regulatory items or things indicating sentiment on Elon as well as other automotive industry stats including production, CPI, etc. We plan to test a variety and perhaps identify the most powerful features through supervised feature selection methods. Likely <strong>backward selection</strong> where the model evaluates all the features and removes the least powerful/most noisy one by one.</p>
<div id="8cb60124" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fredapi <span class="im">import</span> Fred</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># trade_period function</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_trade_period(dt):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    iso_year, iso_week, _ <span class="op">=</span> dt.isocalendar()</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(<span class="ss">f"</span><span class="sc">{</span>iso_year<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>iso_week<span class="sc">:02d}</span><span class="ss">"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to FRED</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>fred <span class="op">=</span> Fred(api_key<span class="op">=</span><span class="st">"1c00931ee7dc4304c6bb68b72fb2d68f"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch data</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>series_id <span class="op">=</span> <span class="st">"IHLIDXUSTPSOFTDEVE"</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> fred.get_series(series_id)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to DataFrame</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data, columns<span class="op">=</span>[<span class="st">"Job Postings"</span>])</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>df.index.name <span class="op">=</span> <span class="st">"Date"</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.reset_index()</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"Date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"Date"</span>])</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"trd_prd"</span>] <span class="op">=</span> df[<span class="st">"Date"</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># collapse to one val per week and compare to prior week</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>weekly_jobs    <span class="op">=</span> df.groupby(<span class="st">"trd_prd"</span>)[<span class="st">"Job Postings"</span>].last().sort_index()</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>job_diff       <span class="op">=</span> weekly_jobs.diff()</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>job_increased  <span class="op">=</span> job_diff <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">#print(job_increased.head(10))</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Display last 5 rows as table</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>df.tail()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="144">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Job Postings</th>
<th data-quarto-table-cell-role="th">trd_prd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1906</td>
<td>2025-04-21</td>
<td>63.71</td>
<td>2025.17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1907</td>
<td>2025-04-22</td>
<td>63.71</td>
<td>2025.17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1908</td>
<td>2025-04-23</td>
<td>63.73</td>
<td>2025.17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1909</td>
<td>2025-04-24</td>
<td>63.67</td>
<td>2025.17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1910</td>
<td>2025-04-25</td>
<td>63.56</td>
<td>2025.17</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="7a1833dd" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the time series</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>plt.plot(df[<span class="st">"Date"</span>], df[<span class="st">"Job Postings"</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"US Software Developer Job Postings Index"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Index Value"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="blotter-ledger-code" class="level1">
<h1>Blotter &amp; Ledger Code</h1>
<div id="80093d31" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shinybroker <span class="im">as</span> sb</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="fetch-data" class="level3">
<h3 class="anchored" data-anchor-id="fetch-data">Fetch data</h3>
<div id="fce39f12" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>asset<span class="op">=</span> sb.Contract({</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'symbol'</span>: <span class="st">"TSLA"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'secType'</span>: <span class="st">"STK"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'exchange'</span>: <span class="st">"SMART"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'currency'</span>: <span class="st">"USD"</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>benchmark <span class="op">=</span> sb.Contract({</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'symbol'</span>: <span class="st">"SPX"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'secType'</span>: <span class="st">"IND"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'exchange'</span>: <span class="st">"CBOE"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'currency'</span>: <span class="st">"USD"</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>benchmark_fetch <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>benchmark,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    endDateTime<span class="op">=</span><span class="st">''</span>,          <span class="co"># now</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'1 Y'</span>,       <span class="co"># past year</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 day'</span>,  <span class="co"># daily bars</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    whatToShow<span class="op">=</span><span class="st">'TRADES'</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>benchmark <span class="op">=</span> benchmark_fetch[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co">#### Get hourly data to use for calculating vol</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>historical_data_hourly_fetch <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    endDateTime<span class="op">=</span><span class="st">''</span>,         <span class="co"># Let IBKR set the "now" time</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'1 Y'</span>,      <span class="co"># Past 1 year</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 hour'</span>, <span class="co"># Daily bars</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    whatToShow<span class="op">=</span><span class="st">'TRADES'</span>,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#date_format=1,          # String time zone date</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#keepUpToDate=False</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>historical_data_hourly <span class="op">=</span> historical_data_hourly_fetch[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co">#### Get daily data as well because it speeds up the code</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co">####   writing process.</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>historical_data_daily_fetch <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    endDateTime<span class="op">=</span><span class="st">''</span>,         <span class="co"># Let IBKR set the "now" time</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'1 Y'</span>,      <span class="co"># Past 1 year</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 day'</span>, <span class="co"># Daily bars</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    whatToShow<span class="op">=</span><span class="st">'TRADES'</span>,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">#date_format=1,          # String time zone date</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">#keepUpToDate=False</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>historical_data_daily <span class="op">=</span> historical_data_daily_fetch[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="co"># print("HDD", historical_data_daily)</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="co">#### Fetch your liquid trading hours for the asset</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="co">#### You'll need this later!</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>ares_deets <span class="op">=</span> sb.fetch_contract_details(</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>sb.Contract({</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">'symbol'</span>: <span class="st">"TSLA"</span>,</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">'secType'</span>: <span class="st">"STK"</span>,</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">'exchange'</span>: <span class="st">"SMART"</span>,</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">'currency'</span>: <span class="st">"USD"</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>liquid_hours <span class="op">=</span> ares_deets[<span class="st">'liquidHours'</span>]</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="co"># print(liquid_hours)</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="co">#liquid_hours = (ares_deets['liquidHours'][0])</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> safe_fetch_iv(contract, durationStr, barSizeSetting, label):</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        fetch <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>            contract<span class="op">=</span>contract,</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>            endDateTime<span class="op">=</span><span class="st">''</span>,</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>            durationStr<span class="op">=</span>durationStr,</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>            barSizeSetting<span class="op">=</span>barSizeSetting,</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>            whatToShow<span class="op">=</span><span class="st">'OPTION_IMPLIED_VOLATILITY'</span>,</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>            useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> fetch[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a><span class="co">#        print(f"{label} IV fetch failed: {e}")</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace your fetch calls with:</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a><span class="co">#iv_historical_data_hourly = safe_fetch_iv(</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a><span class="co">#    contract=asset,</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a><span class="co">#    durationStr='1 Y',</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a><span class="co">#    barSizeSetting='1 hour',</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a><span class="co">#    label="Hourly"</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a><span class="co">#)</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>iv_historical_data_daily <span class="op">=</span> safe_fetch_iv(</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'1 Y'</span>,</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 day'</span>,</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Daily"</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>historical_data_daily_fetch_SMA <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    endDateTime<span class="op">=</span><span class="st">''</span>,         <span class="co"># Let IBKR set the "now" time</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'2 Y'</span>,      <span class="co"># Past 1 year</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 day'</span>, <span class="co"># Daily bars</span></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>    whatToShow<span class="op">=</span><span class="st">'TRADES'</span>,</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>    useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">#date_format=1,          # String time zone date</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">#keepUpToDate=False</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA <span class="op">=</span> historical_data_daily_fetch_SMA[<span class="st">'hst_dta'</span>]<span class="co">#%% md</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="clean-data" class="level3">
<h3 class="anchored" data-anchor-id="clean-data">Clean Data</h3>
<div id="8d6c1a5e" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure 'date' is a datetime column</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(historical_data_daily_SMA[<span class="st">'timestamp'</span>])</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by date just to be safe</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA <span class="op">=</span> historical_data_daily_SMA.sort_values(<span class="st">'timestamp'</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate 20-day simple moving average</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA[<span class="st">'SMA_20'</span>] <span class="op">=</span> historical_data_daily_SMA[<span class="st">'close'</span>].rolling(window<span class="op">=</span><span class="dv">20</span>).mean()</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">#print(historical_data_daily_SMA['SMA_20'])</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">#### Prepare Data</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate trade period</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_trade_period(dt):</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    iso_year, iso_week, _ <span class="op">=</span> dt.isocalendar()</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(<span class="ss">f"</span><span class="sc">{</span>iso_year<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>iso_week<span class="sc">:02d}</span><span class="ss">"</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure 'date' column is in datetime format</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(historical_data_daily[<span class="st">'timestamp'</span>])</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(historical_data_hourly[<span class="st">'timestamp'</span>])</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>iv_historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(iv_historical_data_daily[<span class="st">'timestamp'</span>])</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">#iv_historical_data_hourly['timestamp'] = pd.to_datetime(iv_historical_data_hourly['timestamp'])</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">#liquid_hours['timestamp'] = pd.to_datetime(liquid_hours['timestamp'])</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply trade period calculation</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">=</span> historical_data_daily[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">=</span> historical_data_hourly[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>iv_historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">=</span> iv_historical_data_daily[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co">#iv_historical_data_hourly['trd_prd'] = iv_historical_data_hourly['timestamp'].apply(get_trade_period)</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA[<span class="st">'trd_prd'</span>] <span class="op">=</span> historical_data_daily_SMA[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co">#liquid_hours['trd_prd'] = liquid_hours['timestamp'].apply(get_trade_period)</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the first full five-trading-day week</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>weekly_counts <span class="op">=</span> historical_data_daily.groupby(<span class="st">'trd_prd'</span>)[<span class="st">'timestamp'</span>].count()</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>first_full_week <span class="op">=</span> weekly_counts[weekly_counts <span class="op">&gt;=</span> <span class="dv">5</span>].index.<span class="bu">min</span>()</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter historical_data_daily</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>historical_data_daily <span class="op">=</span> historical_data_daily[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">&gt;=</span> first_full_week]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="print-dfs" class="level3">
<h3 class="anchored" data-anchor-id="print-dfs">Print DFs</h3>
<div id="0311ccd0" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print dataframes</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Commented out these prints for now</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">print("Historical Data Daily:")</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">print(historical_data_daily)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">print("</span><span class="ch">\n</span><span class="co">Historical Data Hourly:")</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">print(historical_data_hourly)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">print("IV Historical Data Daily:")</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">print(iv_historical_data_daily)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">#print("</span><span class="ch">\n</span><span class="co"> IV Historical Data Hourly:")</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">#print(iv_historical_data_daily)</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">print("Historical SMA Data Daily:")</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">print(historical_data_daily_SMA)</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">#print("</span><span class="ch">\n</span><span class="co">Liquid Hours:")</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co">#print(liquid_hours)</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="149">
<pre><code>'\nprint("Historical Data Daily:")\nprint(historical_data_daily)\n\nprint("\nHistorical Data Hourly:")\nprint(historical_data_hourly)\n\nprint("IV Historical Data Daily:")\nprint(iv_historical_data_daily)\n\n#print("\n IV Historical Data Hourly:")\n#print(iv_historical_data_daily)\n\nprint("Historical SMA Data Daily:")\nprint(historical_data_daily_SMA)\n\n#print("\nLiquid Hours:")\n#print(liquid_hours)\n\n'</code></pre>
</div>
</div>
</section>
<section id="vol" class="level3">
<h3 class="anchored" data-anchor-id="vol">Vol</h3>
<div id="fbe02772" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calc Obs &amp; Exp Vol</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trade periods from daily historical data</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>trade_periods <span class="op">=</span> historical_data_daily[<span class="st">'trd_prd'</span>].unique()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate observed volatility using hourly data</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>hourly_log_returns <span class="op">=</span> np.log(historical_data_hourly[<span class="st">'close'</span>] <span class="op">/</span> historical_data_hourly[<span class="st">'close'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>hourly_vols <span class="op">=</span> hourly_log_returns.groupby(historical_data_hourly[<span class="st">'timestamp'</span>].dt.strftime(<span class="st">'%Y-%W'</span>)).std()</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert hourly vol to weekly vol (scale by sqrt(32.5))</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>weekly_vols <span class="op">=</span> hourly_vols <span class="op">*</span> np.sqrt(<span class="fl">32.5</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>vol_calcs <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>trade_periods, columns<span class="op">=</span>[<span class="st">'obs_vol'</span>, <span class="st">'exp_vol'</span>])</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>vol_calcs[<span class="st">'obs_vol'</span>] <span class="op">=</span> weekly_vols.values[:<span class="bu">len</span>(trade_periods)]</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Set expected vol (shifted obs_vol)</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>vol_calcs[<span class="st">'exp_vol'</span>] <span class="op">=</span> vol_calcs[<span class="st">'obs_vol'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># print("\nVolatility Calculations:")</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># print(vol_calcs)</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calc Obs &amp; Exp Vol</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trade periods from daily historical data</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>trade_periods <span class="op">=</span> historical_data_daily[<span class="st">'trd_prd'</span>].unique()</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate observed volatility using hourly data</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>hourly_log_returns <span class="op">=</span> np.log(historical_data_hourly[<span class="st">'close'</span>] <span class="op">/</span> historical_data_hourly[<span class="st">'close'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>hourly_vols <span class="op">=</span> hourly_log_returns.groupby(historical_data_hourly[<span class="st">'timestamp'</span>].dt.strftime(<span class="st">'%Y-%W'</span>)).std()</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert hourly vol to weekly vol (scale by sqrt(32.5))</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>weekly_vols <span class="op">=</span> hourly_vols <span class="op">*</span> np.sqrt(<span class="fl">32.5</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>smart_vol_calcs <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>trade_periods, columns<span class="op">=</span>[<span class="st">'obs_vol'</span>, <span class="st">'exp_vol'</span>])</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>smart_vol_calcs[<span class="st">'obs_vol'</span>] <span class="op">=</span> weekly_vols.values[:<span class="bu">len</span>(trade_periods)]</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Set expected vol (from options IV)</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trd_prd <span class="kw">in</span> smart_vol_calcs.index:</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    smart_vol_calcs.at[trd_prd, <span class="st">'exp_vol'</span>] <span class="op">=</span> iv_historical_data_daily.loc[</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        iv_historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'open'</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    ].iloc[<span class="dv">0</span>] <span class="op">*</span> np.sqrt(<span class="dv">1</span><span class="op">/</span><span class="dv">52</span>)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nVolatility Calculations:")</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="co">#print(smart_vol_calcs)</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>vol_calcs <span class="op">=</span> smart_vol_calcs</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="co">#vol_calcs = smart_vol_calcs # manually toggle active vol calc</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="blotter-ledger-initialization" class="level3">
<h3 class="anchored" data-anchor-id="blotter-ledger-initialization">Blotter &amp; Ledger Initialization</h3>
<div id="f31cf323" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trade periods from daily historical data</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>trade_periods <span class="op">=</span> historical_data_daily[<span class="st">'trd_prd'</span>].unique()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calc blotter</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>blotter <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>trade_periods[<span class="dv">1</span>:], columns<span class="op">=</span>[<span class="st">'entry_timestamp'</span>, <span class="st">'qty'</span>, <span class="st">'exit_timestamp'</span>, <span class="st">'entry_price'</span>, <span class="st">'exit_price'</span>, <span class="st">'success'</span>, <span class="st">'iv'</span>, <span class="st">'wap'</span>, <span class="st">'sma'</span>])</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>blotter[:] <span class="op">=</span> <span class="va">None</span>  <span class="co"># Set empty values</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nBlotter:")</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#print(blotter)</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Ledger</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>filtered_historical <span class="op">=</span> historical_data_daily[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">!=</span> historical_data_daily[<span class="st">'trd_prd'</span>].iloc[<span class="dv">0</span>]]</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>ledger <span class="op">=</span> pd.DataFrame()</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'date'</span>] <span class="op">=</span> filtered_historical[<span class="st">'timestamp'</span>]</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'position'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'cash'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'mark'</span>] <span class="op">=</span> historical_data_daily[<span class="st">'close'</span>][<span class="dv">1</span>:]</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co">#ledger['cash'] = 50000</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nLedger:")</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co">#print(ledger)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="blotter-ledger-loop" class="level3">
<h3 class="anchored" data-anchor-id="blotter-ledger-loop">Blotter &amp; Ledger Loop</h3>
<div id="96024971" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create function for IV percentile</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_iv_percentile_series(iv_df, window<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    iv_percentiles <span class="op">=</span> {}</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    iv_df_sorted <span class="op">=</span> iv_df.sort_values(<span class="st">"timestamp"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> iv_df_sorted.iterrows():</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        trd_prd <span class="op">=</span> row[<span class="st">'trd_prd'</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        curr_iv <span class="op">=</span> row[<span class="st">'open'</span>]</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        recent_ivs <span class="op">=</span> iv_df_sorted[iv_df_sorted[<span class="st">'timestamp'</span>] <span class="op">&lt;</span> row[<span class="st">'timestamp'</span>]].tail(window)[<span class="st">'open'</span>]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(recent_ivs) <span class="op">&gt;=</span> <span class="dv">10</span>:</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>            percentile <span class="op">=</span> (recent_ivs <span class="op">&lt;</span> curr_iv).mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>            iv_percentiles[trd_prd] <span class="op">=</span> percentile</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> iv_percentiles</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># calc percentiles for each trade period...</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># want to only trade if IV percentile is &gt;50% and &lt;90%</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>iv_percentiles_by_trdprd <span class="op">=</span> calc_iv_percentile_series(iv_historical_data_daily)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># shift dict to use previous iv percentile</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>prev_iv_percentiles <span class="op">=</span> {}</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>sorted_keys <span class="op">=</span> <span class="bu">sorted</span>(iv_percentiles_by_trdprd.keys())</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(sorted_keys)):</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    curr <span class="op">=</span> sorted_keys[i]</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    prev <span class="op">=</span> sorted_keys[i <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    prev_iv_percentiles[curr] <span class="op">=</span> iv_percentiles_by_trdprd[prev]</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Blotter &amp; Ledger Loop</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co"># This is where "backtesting" really occurs. We're calculating the blotter &amp;</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ledger that our trading system WOULD have produced.</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trd_prd <span class="kw">in</span> blotter.index:</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    entry_timestamp <span class="op">=</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'timestamp'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    entry_price <span class="op">=</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'open'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    prev_close <span class="op">=</span> historical_data_daily.loc[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">&lt;</span> trd_prd, <span class="st">'close'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    exp_vol <span class="op">=</span> vol_calcs.loc[trd_prd, <span class="st">'exp_vol'</span>]</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    iv <span class="op">=</span> iv_historical_data_daily.loc[iv_historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'wap'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    wap <span class="op">=</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'wap'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    sma <span class="op">=</span> historical_data_daily_SMA.loc[historical_data_daily_SMA[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'SMA_20'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    prev_iv <span class="op">=</span> prev_iv_percentiles.get(trd_prd, <span class="va">None</span>)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># INPUT PRE-TRADE FILTERS HERE</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">not</span> job_increased.get(trd_prd, <span class="va">False</span>)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">or</span> prev_iv <span class="kw">is</span> <span class="va">None</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">or</span> <span class="kw">not</span> (<span class="dv">40</span> <span class="op">&lt;</span> prev_iv <span class="op">&lt;</span> <span class="dv">90</span>)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> entry_price <span class="op">&gt;</span> prev_close:</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="op">-</span><span class="dv">100</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>        exit_price_strategy <span class="op">=</span> entry_price <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> exp_vol)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        exit_price_strategy <span class="op">=</span> entry_price <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> exp_vol)</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    period_data <span class="op">=</span> historical_data_hourly[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd]</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    max_high <span class="op">=</span> period_data[<span class="st">'high'</span>].<span class="bu">max</span>()</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    min_low <span class="op">=</span> period_data[<span class="st">'low'</span>].<span class="bu">min</span>()</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (qty <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> max_high <span class="op">&gt;=</span> exit_price_strategy) <span class="kw">or</span> (qty <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">and</span> min_low <span class="op">&lt;=</span> exit_price_strategy):</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> exit_price_strategy</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> qty <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>            exit_timestamp <span class="op">=</span> period_data.loc[period_data[<span class="st">'high'</span>] <span class="op">&gt;=</span> exit_price_strategy, <span class="st">'timestamp'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>            exit_high_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'high'</span>] <span class="op">&gt;=</span> exit_price_strategy, <span class="st">'high'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>            exit_low_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'high'</span>] <span class="op">&gt;=</span> exit_price_strategy, <span class="st">'low'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>            exit_timestamp <span class="op">=</span> period_data.loc[period_data[<span class="st">'low'</span>] <span class="op">&lt;=</span> exit_price_strategy, <span class="st">'timestamp'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>            exit_high_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'low'</span>] <span class="op">&lt;=</span> exit_price_strategy, <span class="st">'high'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>            exit_low_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'low'</span>] <span class="op">&lt;=</span> exit_price_strategy, <span class="st">'low'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(exit_low_price, exit_high_price, exit_price_strategy, exit_timestamp, qty)</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> qty <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> entry_price  <span class="co"># or set to None if preferred</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>        exit_timestamp <span class="op">=</span> entry_timestamp</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> historical_data_daily.loc[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'close'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>        <span class="co">#exit_timestamp = historical_data_daily.loc[historical_data_daily['trd_prd'] == trd_prd, 'timestamp'].iloc[-1]</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>        exit_timestamp <span class="op">=</span> pd.to_datetime(</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>        historical_data_daily.loc[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'timestamp'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]).replace(hour<span class="op">=</span><span class="dv">15</span>, minute<span class="op">=</span><span class="dv">0</span>, second<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>    blotter.loc[trd_prd] <span class="op">=</span> [entry_timestamp, qty, exit_timestamp, entry_price, exit_price, success, iv, wap, sma]</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'position'</span>] <span class="op">+=</span> qty</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'position'</span>] <span class="op">-=</span> qty</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'cash'</span>] <span class="op">-=</span> qty <span class="op">*</span> entry_price</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'cash'</span>] <span class="op">+=</span> qty <span class="op">*</span> exit_price</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a><span class="co"># finally, calculate your strategy's end-of-day mark-to-market value</span></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> ledger[<span class="st">'position'</span>] <span class="op">*</span> ledger[<span class="st">'mark'</span>] <span class="op">+</span> ledger[<span class="st">'cash'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="extra" class="level3">
<h3 class="anchored" data-anchor-id="extra">Extra</h3>
<div id="eb83a005" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> blotter[[<span class="st">'iv'</span>, <span class="st">'wap'</span>, <span class="st">'sma'</span>]]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> blotter[<span class="st">'success'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Split train/test</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y.value_counts())</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> LogisticRegression()</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># y_pred = model.predict(X_test) # 0.5 threshold</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> model.predict_proba(X_test)[:, <span class="dv">1</span>]</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> (probs <span class="op">&gt;</span> <span class="fl">0.3</span>).astype(<span class="bu">int</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>fill <span class="op">=</span> <span class="bu">len</span>(y_train)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>padded_y_pred <span class="op">=</span> np.concatenate(([<span class="fl">1.0</span>] <span class="op">*</span> fill, y_pred))</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'prediction'</span>] <span class="op">=</span> pd.Series(padded_y_pred, index<span class="op">=</span>blotter.index)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Results</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co"># REMOVING THESE TO CLEAN UP</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="co">#print("Coefficients:", model.coef_)</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co">#print("Intercept:", model.intercept_)</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co">#print(classification_report(y_test, y_pred))</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="co">#print("Blotter", blotter)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>success
0    44
1     7
Name: count, dtype: int64</code></pre>
</div>
</div>
</section>
</section>
<section id="outputting-interactive-blotter-ledger-final-hw-here" class="level1">
<h1>Outputting Interactive Blotter &amp; Ledger (FINAL HW HERE)</h1>
<div id="b2db8efc" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your final blotter DataFrame already populated at this point</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>blotter <span class="op">=</span> blotter.<span class="bu">round</span>(<span class="dv">3</span>)  <span class="co"># Optional: round for cleaner display</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="b4b7d8d3" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display blotter as interactive table</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itables <span class="im">import</span> show</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>show(blotter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<table id="itables_1d07b298_36aa_4fb5_86c7_1748844a1d56" class="display nowrap" data-quarto-disable-processing="true" style="table-layout:auto;width:auto;margin:auto;caption-side:bottom">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>entry_timestamp</th>
      <th>qty</th>
      <th>exit_timestamp</th>
      <th>entry_price</th>
      <th>exit_price</th>
      <th>success</th>
      <th>iv</th>
      <th>wap</th>
      <th>sma</th>
      <th>prediction</th>
    </tr>
  </thead><tbody><tr>
<td style="vertical-align:middle; text-align:left">
<a href="https://mwouts.github.io/itables/"><svg class="main-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="64" viewbox="0 0 500 400" style="font-family: 'Droid Sans', sans-serif;">
    <g style="fill:#d9d7fc">
        <path d="M100,400H500V357H100Z"></path>
        <path d="M100,300H400V257H100Z"></path>
        <path d="M0,200H400V157H0Z"></path>
        <path d="M100,100H500V57H100Z"></path>
        <path d="M100,350H500V307H100Z"></path>
        <path d="M100,250H400V207H100Z"></path>
        <path d="M0,150H400V107H0Z"></path>
        <path d="M100,50H500V7H100Z"></path>
    </g>
    <g style="fill:#1a1366;stroke:#1a1366;">
   <rect x="100" y="7" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="5s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="0" y="107" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="3.5s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="0;0;400" dur="3.5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="207" width="300" height="43">
    <animate attributename="width" values="0;300;0" dur="3s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="100;100;400" dur="3s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="307" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="4s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="4s" repeatcount="indefinite"></animate>
  </rect>
        <g style="fill:transparent;stroke-width:8; stroke-linejoin:round" rx="5">
            <g transform="translate(45 50) rotate(-45)">
                <circle r="33" cx="0" cy="0"></circle>
                <rect x="-8" y="32" width="16" height="30"></rect>
            </g>

            <g transform="translate(450 152)">
                <polyline points="-15,-20 -35,-20 -35,40 25,40 25,20"></polyline>
                <rect x="-15" y="-40" width="60" height="60"></rect>
            </g>

            <g transform="translate(50 352)">
                <polygon points="-35,-5 0,-40 35,-5"></polygon>
                <polygon points="-35,10 0,45 35,10"></polygon>
            </g>

            <g transform="translate(75 250)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>

            <g transform="translate(425 250) rotate(180)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>
        </g>
    </g>
</svg>
</a>
Loading ITables v2.3.0 from the internet...
(need <a href="https://mwouts.github.io/itables/troubleshooting.html">help</a>?)</td>
</tr></tbody>
</table>
<link href="https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.css" rel="stylesheet">
<script type="module">
    import {DataTable, jQuery as $} from 'https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.js';

    document.querySelectorAll("#itables_1d07b298_36aa_4fb5_86c7_1748844a1d56:not(.dataTable)").forEach(table => {
        if (!(table instanceof HTMLTableElement))
            return;

        // Define the table data
        const data = [[2024.2, "2024-05-13 09:30:00", "0", "2024-05-13 09:30:00", " 170.0", " 170.0", "False", " 0.429", " 172.588", " 168.2505", 1.0], [2024.21, "2024-05-20 09:30:00", "0", "2024-05-20 09:30:00", " 177.62", " 177.62", "False", " 0.43", " 175.238", " 174.6105", 1.0], [2024.22, "2024-05-28 09:30:00", "100", "2024-05-31 15:00:00", " 176.43", " 178.08", "False", " 0.449", " 174.397", " 177.466", 1.0], [2024.23, "2024-06-03 09:30:00", "0", "2024-06-03 09:30:00", " 178.13", " 178.13", "False", " 0.477", " 180.856", " 176.71", 1.0], [2024.24, "2024-06-10 09:30:00", "0", "2024-06-10 09:30:00", " 176.11", " 176.11", "False", " 0.506", " 177.165", " 176.7725", 1.0], [2024.25, "2024-06-17 09:30:00", "0", "2024-06-17 09:30:00", " 177.95", " 177.95", "False", " 0.48", " 180.164", " 177.7795", 1.0], [2024.26, "2024-06-24 09:30:00", "0", "2024-06-24 09:30:00", " 184.95", " 184.95", "False", " 0.525", " 187.008", " 178.6105", 1.0], [2024.27, "2024-07-01 09:30:00", "0", "2024-07-01 09:30:00", " 201.02", " 201.02", "False", " 0.571", " 204.955", " 183.602", 1.0], [2024.28, "2024-07-08 09:30:00", "0", "2024-07-08 09:30:00", " 247.74", " 247.74", "False", " 0.701", " 246.958", " 197.5075", 1.0], [2024.29, "2024-07-15 09:30:00", "0", "2024-07-15 09:30:00", " 256.02", " 256.02", "False", " 0.675", " 258.883", " 216.7975", 1.0], [2024.3, "2024-07-22 09:30:00", "0", "2024-07-22 09:30:00", " 244.22", " 244.22", "False", " 0.626", " 248.676", " 233.303", 1.0], [2024.31, "2024-07-29 09:30:00", "0", "2024-07-29 09:30:00", " 224.91", " 224.91", "False", " 0.504", " 228.68", " 241.949", 1.0], [2024.32, "2024-08-05 09:30:00", "0", "2024-08-05 09:30:00", " 185.15", " 185.15", "False", " 0.775", " 191.031", " 236.2555", 1.0], [2024.33, "2024-08-12 09:30:00", "100", "2024-08-15 10:00:00", " 199.02", " 212.432237", "True", " 0.504", " 197.01", " 222.3175", 1.0], [2024.34, "2024-08-19 09:30:00", "0", "2024-08-19 09:30:00", " 217.05", " 217.05", "False", " 0.518", " 217.117", " 213.177", 1.0], [2024.35, "2024-08-26 09:30:00", "100", "2024-08-30 15:00:00", " 218.76", " 214.11", "False", " 0.489", " 217.328", " 210.879", 1.0], [2024.36, "2024-09-03 09:30:00", "0", "2024-09-03 09:30:00", " 215.26", " 215.26", "False", " 0.522", " 216.047", " 209.2715", 1.0], [2024.37, "2024-09-09 09:30:00", "-100", "2024-09-13 15:00:00", " 216.03", " 230.29", "False", " 0.624", " 216.879", " 213.5385", 1.0], [2024.38, "2024-09-16 09:30:00", "0", "2024-09-16 09:30:00", " 229.3", " 229.3", "False", " 0.644", " 225.89", " 218.7495", 1.0], [2024.39, "2024-09-23 09:30:00", "0", "2024-09-23 09:30:00", " 242.61", " 242.61", "False", " 0.669", " 245.968", " 223.208", 1.0], [2024.4, "2024-09-30 09:30:00", "0", "2024-09-30 09:30:00", " 259.02", " 259.02", "False", " 0.763", " 262.508", " 235.16", 1.0], [2024.41, "2024-10-07 09:30:00", "0", "2024-10-07 09:30:00", " 249.0", " 249.0", "False", " 0.701", " 246.881", " 242.7315", 1.0], [2024.42, "2024-10-14 09:30:00", "0", "2024-10-14 09:30:00", " 220.13", " 220.13", "False", " 0.598", " 219.021", " 243.7365", 1.0], [2024.43, "2024-10-21 09:30:00", "100", "2024-10-24 09:30:00", " 218.91", " 234.838989", "True", " 0.549", " 217.696", " 239.4415", 1.0], [2024.44, "2024-10-28 09:30:00", "-100", "2024-11-01 12:00:00", " 269.95", " 248.961663", "True", " 0.567", " 268.218", " 236.2515", 1.0], [2024.45, "2024-11-04 09:30:00", "100", "2024-11-06 09:30:00", " 244.56", " 261.570463", "True", " 0.539", " 241.768", " 237.258", 1.0], [2024.46, "2024-11-11 09:30:00", "0", "2024-11-11 09:30:00", " 346.38", " 346.38", "False", " 0.732", " 345.854", " 254.599", 1.0], [2024.47, "2024-11-18 09:30:00", "-100", "2024-11-22 15:00:00", " 340.75", " 352.56", "False", " 0.679", " 341.486", " 281.0005", 1.0], [2024.48, "2024-11-25 09:30:00", "-100", "2024-11-27 10:00:00", " 360.56", " 330.320241", "True", " 0.63", " 356.733", " 305.7515", 1.0], [2024.49, "2024-12-02 09:30:00", "0", "2024-12-02 09:30:00", " 352.51", " 352.51", "False", " 0.543", " 355.734", " 323.625", 1.0], [2024.5, "2024-12-09 09:30:00", "0", "2024-12-09 09:30:00", " 397.8", " 397.8", "False", " 0.625", " 398.662", " 346.4705", 1.0], [2024.51, "2024-12-16 09:30:00", "-100", "2024-12-20 15:00:00", " 441.11", " 421.06", "False", " 0.708", " 441.734", " 371.5945", 1.0], [2024.52, "2024-12-23 09:30:00", "0", "2024-12-23 09:30:00", " 431.0", " 431.0", "False", " 0.688", " 426.689", " 396.037", 1.0], [2025.01, "2024-12-30 09:30:00", "0", "2024-12-30 09:30:00", " 419.4", " 419.4", "False", " 0.733", " 421.8", " 416.5675", 1.0], [2025.02, "2025-01-06 09:30:00", "0", "2025-01-06 09:30:00", " 423.22", " 423.22", "False", " 0.713", " 420.501", " 425.0015", 1.0], [2025.03, "2025-01-13 09:30:00", "100", "2025-01-14 09:30:00", " 383.24", " 417.978702", "True", " 0.677", " 385.577", " 424.1305", 1.0], [2025.04, "2025-01-21 09:30:00", "0", "2025-01-21 09:30:00", " 432.67", " 432.67", "False", " 0.708", " 417.007", " 416.712", 0.0], [2025.05, "2025-01-27 09:30:00", "0", "2025-01-27 09:30:00", " 394.9", " 394.9", "False", " 0.636", " 399.837", " 410.7675", 0.0], [2025.06, "2025-02-03 09:30:00", "0", "2025-02-03 09:30:00", " 386.68", " 386.68", "False", " 0.589", " 384.267", " 405.239", 0.0], [2025.07, "2025-02-10 09:30:00", "0", "2025-02-10 09:30:00", " 356.4", " 356.4", "False", " 0.516", " 353.953", " 397.815", 0.0], [2025.08, "2025-02-18 09:30:00", "0", "2025-02-18 09:30:00", " 355.22", " 355.22", "False", " 0.534", " 355.598", " 380.9495", 0.0], [2025.09, "2025-02-24 09:30:00", "0", "2025-02-24 09:30:00", " 338.14", " 338.14", "False", " 0.557", " 337.061", " 367.207", 0.0], [2025.1, "2025-03-03 09:30:00", "-100", "2025-03-04 09:30:00", " 300.32", " 274.415843", "True", " 0.702", " 298.757", " 340.405", 0.0], [2025.11, "2025-03-10 09:30:00", "0", "2025-03-10 09:30:00", " 252.5", " 252.5", "False", " 0.901", " 247.49", " 310.8755", 0.0], [2025.12, "2025-03-17 09:30:00", "0", "2025-03-17 09:30:00", " 245.01", " 245.01", "False", " 0.718", " 242.375", " 284.8665", 0.0], [2025.13, "2025-03-24 09:30:00", "0", "2025-03-24 09:30:00", " 258.13", " 258.13", "False", " 0.72", " 263.314", " 259.223", 0.0], [2025.14, "2025-03-31 09:30:00", "0", "2025-03-31 09:30:00", " 249.41", " 249.41", "False", " 0.831", " 246.706", " 254.366", 0.0], [2025.15, "2025-04-07 09:30:00", "0", "2025-04-07 09:30:00", " 223.8", " 223.8", "False", " 1.108", " 221.791", " 253.9565", 0.0], [2025.16, "2025-04-14 09:30:00", "0", "2025-04-14 09:30:00", " 258.3", " 258.3", "False", " 0.832", " 256.864", " 256.1455", 0.0], [2025.17, "2025-04-21 09:30:00", "0", "2025-04-21 09:30:00", " 230.27", " 230.27", "False", " 0.834", " 228.847", " 257.065", 0.0], [2025.18, "2025-04-28 09:30:00", "0", "2025-04-28 09:30:00", " 289.01", " 289.01", "False", " 0.676", " 290.517", " 254.254", 0.0]];

        // Define the dt_args
        let dt_args = {"layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "order": [], "warn_on_selected_rows_not_rendered": true};
        dt_args["data"] = data;

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<div id="2e4be763" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your final ledger DataFrame already populated at this point</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ledger <span class="op">=</span> ledger.<span class="bu">round</span>(<span class="dv">2</span>)  <span class="co"># Optional: clean output</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="689e4454" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display ledger as interactive table</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>show(ledger)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<table id="itables_a5198f08_3148_438c_867f_c31f3d8c89af" class="display nowrap" data-quarto-disable-processing="true" style="table-layout:auto;width:auto;margin:auto;caption-side:bottom">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>position</th>
      <th>cash</th>
      <th>mark</th>
      <th>mkt_value</th>
    </tr>
  </thead><tbody><tr>
<td style="vertical-align:middle; text-align:left">
<a href="https://mwouts.github.io/itables/"><svg class="main-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="64" viewbox="0 0 500 400" style="font-family: 'Droid Sans', sans-serif;">
    <g style="fill:#d9d7fc">
        <path d="M100,400H500V357H100Z"></path>
        <path d="M100,300H400V257H100Z"></path>
        <path d="M0,200H400V157H0Z"></path>
        <path d="M100,100H500V57H100Z"></path>
        <path d="M100,350H500V307H100Z"></path>
        <path d="M100,250H400V207H100Z"></path>
        <path d="M0,150H400V107H0Z"></path>
        <path d="M100,50H500V7H100Z"></path>
    </g>
    <g style="fill:#1a1366;stroke:#1a1366;">
   <rect x="100" y="7" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="5s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="0" y="107" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="3.5s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="0;0;400" dur="3.5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="207" width="300" height="43">
    <animate attributename="width" values="0;300;0" dur="3s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="100;100;400" dur="3s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="307" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="4s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="4s" repeatcount="indefinite"></animate>
  </rect>
        <g style="fill:transparent;stroke-width:8; stroke-linejoin:round" rx="5">
            <g transform="translate(45 50) rotate(-45)">
                <circle r="33" cx="0" cy="0"></circle>
                <rect x="-8" y="32" width="16" height="30"></rect>
            </g>

            <g transform="translate(450 152)">
                <polyline points="-15,-20 -35,-20 -35,40 25,40 25,20"></polyline>
                <rect x="-15" y="-40" width="60" height="60"></rect>
            </g>

            <g transform="translate(50 352)">
                <polygon points="-35,-5 0,-40 35,-5"></polygon>
                <polygon points="-35,10 0,45 35,10"></polygon>
            </g>

            <g transform="translate(75 250)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>

            <g transform="translate(425 250) rotate(180)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>
        </g>
    </g>
</svg>
</a>
Loading ITables v2.3.0 from the internet...
(need <a href="https://mwouts.github.io/itables/troubleshooting.html">help</a>?)</td>
</tr></tbody>
</table>
<link href="https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.css" rel="stylesheet">
<script type="module">
    import {DataTable, jQuery as $} from 'https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.js';

    document.querySelectorAll("#itables_a5198f08_3148_438c_867f_c31f3d8c89af:not(.dataTable)").forEach(table => {
        if (!(table instanceof HTMLTableElement))
            return;

        // Define the table data
        const data = [[8, "2024-05-13", 0.0, 0.0, 171.89, 0.0], [9, "2024-05-14", 0.0, 0.0, 177.55, 0.0], [10, "2024-05-15", 0.0, 0.0, 173.99, 0.0], [11, "2024-05-16", 0.0, 0.0, 174.84, 0.0], [12, "2024-05-17", 0.0, 0.0, 177.46, 0.0], [13, "2024-05-20", 0.0, 0.0, 174.95, 0.0], [14, "2024-05-21", 0.0, 0.0, 186.6, 0.0], [15, "2024-05-22", 0.0, 0.0, 180.11, 0.0], [16, "2024-05-23", 0.0, 0.0, 173.74, 0.0], [17, "2024-05-24", 0.0, 0.0, 179.24, 0.0], [18, "2024-05-28", 0.0, 0.0, 176.75, 0.0], [19, "2024-05-29", 100.0, -17643.0, 176.19, -24.0], [20, "2024-05-30", 100.0, -17643.0, 178.79, 236.0], [21, "2024-05-31", 100.0, -17643.0, 178.08, 165.0], [22, "2024-06-03", 0.0, 165.0, 176.29, 165.0], [23, "2024-06-04", 0.0, 165.0, 174.77, 165.0], [24, "2024-06-05", 0.0, 165.0, 175.0, 165.0], [25, "2024-06-06", 0.0, 165.0, 177.94, 165.0], [26, "2024-06-07", 0.0, 165.0, 177.48, 165.0], [27, "2024-06-10", 0.0, 165.0, 173.79, 165.0], [28, "2024-06-11", 0.0, 165.0, 170.66, 165.0], [29, "2024-06-12", 0.0, 165.0, 177.29, 165.0], [30, "2024-06-13", 0.0, 165.0, 182.47, 165.0], [31, "2024-06-14", 0.0, 165.0, 178.01, 165.0], [32, "2024-06-17", 0.0, 165.0, 187.44, 165.0], [33, "2024-06-18", 0.0, 165.0, 184.86, 165.0], [34, "2024-06-20", 0.0, 165.0, 181.57, 165.0], [35, "2024-06-21", 0.0, 165.0, 183.01, 165.0], [36, "2024-06-24", 0.0, 165.0, 182.58, 165.0], [37, "2024-06-25", 0.0, 165.0, 187.35, 165.0], [38, "2024-06-26", 0.0, 165.0, 196.37, 165.0], [39, "2024-06-27", 0.0, 165.0, 197.42, 165.0], [40, "2024-06-28", 0.0, 165.0, 197.88, 165.0], [41, "2024-07-01", 0.0, 165.0, 209.86, 165.0], [42, "2024-07-02", 0.0, 165.0, 231.26, 165.0], [43, "2024-07-03", 0.0, 165.0, 246.39, 165.0], [44, "2024-07-05", 0.0, 165.0, 251.52, 165.0], [45, "2024-07-08", 0.0, 165.0, 252.94, 165.0], [46, "2024-07-09", 0.0, 165.0, 262.33, 165.0], [47, "2024-07-10", 0.0, 165.0, 263.26, 165.0], [48, "2024-07-11", 0.0, 165.0, 241.03, 165.0], [49, "2024-07-12", 0.0, 165.0, 248.23, 165.0], [50, "2024-07-15", 0.0, 165.0, 252.64, 165.0], [51, "2024-07-16", 0.0, 165.0, 256.56, 165.0], [52, "2024-07-17", 0.0, 165.0, 248.5, 165.0], [53, "2024-07-18", 0.0, 165.0, 249.23, 165.0], [54, "2024-07-19", 0.0, 165.0, 239.2, 165.0], [55, "2024-07-22", 0.0, 165.0, 251.51, 165.0], [56, "2024-07-23", 0.0, 165.0, 246.38, 165.0], [57, "2024-07-24", 0.0, 165.0, 215.99, 165.0], [58, "2024-07-25", 0.0, 165.0, 220.25, 165.0], [59, "2024-07-26", 0.0, 165.0, 219.8, 165.0], [60, "2024-07-29", 0.0, 165.0, 232.1, 165.0], [61, "2024-07-30", 0.0, 165.0, 222.62, 165.0], [62, "2024-07-31", 0.0, 165.0, 232.07, 165.0], [63, "2024-08-01", 0.0, 165.0, 216.86, 165.0], [64, "2024-08-02", 0.0, 165.0, 207.67, 165.0], [65, "2024-08-05", 0.0, 165.0, 198.88, 165.0], [66, "2024-08-06", 0.0, 165.0, 200.64, 165.0], [67, "2024-08-07", 0.0, 165.0, 191.76, 165.0], [68, "2024-08-08", 0.0, 165.0, 198.84, 165.0], [69, "2024-08-09", 0.0, 165.0, 200.0, 165.0], [70, "2024-08-12", 0.0, 165.0, 197.49, 165.0], [71, "2024-08-13", 100.0, -19737.0, 207.83, 1046.0], [72, "2024-08-14", 100.0, -19737.0, 201.38, 401.0], [73, "2024-08-15", 100.0, -19737.0, 214.14, 1677.0], [74, "2024-08-16", 0.0, 1506.22, 216.12, 1506.22], [75, "2024-08-19", 0.0, 1506.22, 222.72, 1506.22], [76, "2024-08-20", 0.0, 1506.22, 221.1, 1506.22], [77, "2024-08-21", 0.0, 1506.22, 223.27, 1506.22], [78, "2024-08-22", 0.0, 1506.22, 210.66, 1506.22], [79, "2024-08-23", 0.0, 1506.22, 220.32, 1506.22], [80, "2024-08-26", 0.0, 1506.22, 213.21, 1506.22], [81, "2024-08-27", 100.0, -20369.78, 209.21, 551.22], [82, "2024-08-28", 100.0, -20369.78, 205.75, 205.22], [83, "2024-08-29", 100.0, -20369.78, 206.28, 258.22], [84, "2024-08-30", 100.0, -20369.78, 214.11, 1041.22], [85, "2024-09-03", 0.0, 1041.22, 210.6, 1041.22], [86, "2024-09-04", 0.0, 1041.22, 219.41, 1041.22], [87, "2024-09-05", 0.0, 1041.22, 230.17, 1041.22], [88, "2024-09-06", 0.0, 1041.22, 210.73, 1041.22], [89, "2024-09-09", 0.0, 1041.22, 216.27, 1041.22], [90, "2024-09-10", -100.0, 22644.22, 226.17, 27.22], [91, "2024-09-11", -100.0, 22644.22, 228.13, -168.78], [92, "2024-09-12", -100.0, 22644.22, 229.81, -336.78], [93, "2024-09-13", -100.0, 22644.22, 230.29, -384.78], [94, "2024-09-16", 0.0, -384.78, 226.78, -384.78], [95, "2024-09-17", 0.0, -384.78, 227.87, -384.78], [96, "2024-09-18", 0.0, -384.78, 227.2, -384.78], [97, "2024-09-19", 0.0, -384.78, 243.92, -384.78], [98, "2024-09-20", 0.0, -384.78, 238.25, -384.78], [99, "2024-09-23", 0.0, -384.78, 250.0, -384.78], [100, "2024-09-24", 0.0, -384.78, 254.27, -384.78], [101, "2024-09-25", 0.0, -384.78, 257.02, -384.78], [102, "2024-09-26", 0.0, -384.78, 254.22, -384.78], [103, "2024-09-27", 0.0, -384.78, 260.46, -384.78], [104, "2024-09-30", 0.0, -384.78, 261.63, -384.78], [105, "2024-10-01", 0.0, -384.78, 258.02, -384.78], [106, "2024-10-02", 0.0, -384.78, 249.02, -384.78], [107, "2024-10-03", 0.0, -384.78, 240.66, -384.78], [108, "2024-10-04", 0.0, -384.78, 250.08, -384.78], [109, "2024-10-07", 0.0, -384.78, 240.83, -384.78], [110, "2024-10-08", 0.0, -384.78, 244.5, -384.78], [111, "2024-10-09", 0.0, -384.78, 241.05, -384.78], [112, "2024-10-10", 0.0, -384.78, 238.77, -384.78], [113, "2024-10-11", 0.0, -384.78, 217.8, -384.78], [114, "2024-10-14", 0.0, -384.78, 219.16, -384.78], [115, "2024-10-15", 0.0, -384.78, 219.57, -384.78], [116, "2024-10-16", 0.0, -384.78, 221.33, -384.78], [117, "2024-10-17", 0.0, -384.78, 220.89, -384.78], [118, "2024-10-18", 0.0, -384.78, 220.7, -384.78], [119, "2024-10-21", 0.0, -384.78, 218.85, -384.78], [120, "2024-10-22", 100.0, -22275.78, 217.97, -478.78], [121, "2024-10-23", 100.0, -22275.78, 213.65, -910.78], [122, "2024-10-24", 100.0, -22275.78, 260.48, 3772.22], [123, "2024-10-25", 0.0, 1208.12, 269.19, 1208.12], [124, "2024-10-28", 0.0, 1208.12, 262.51, 1208.12], [125, "2024-10-29", -100.0, 28203.12, 259.52, 2251.12], [126, "2024-10-30", -100.0, 28203.12, 257.55, 2448.12], [127, "2024-10-31", -100.0, 28203.12, 249.85, 3218.12], [128, "2024-11-01", -100.0, 28203.12, 248.98, 3305.12], [129, "2024-11-04", 0.0, 3306.96, 242.84, 3306.96], [130, "2024-11-05", 100.0, -21149.04, 251.44, 3994.96], [131, "2024-11-06", 100.0, -21149.04, 288.53, 7703.96], [132, "2024-11-07", 0.0, 5008.0, 296.91, 5008.0], [133, "2024-11-08", 0.0, 5008.0, 321.22, 5008.0], [134, "2024-11-11", 0.0, 5008.0, 350.0, 5008.0], [135, "2024-11-12", 0.0, 5008.0, 328.49, 5008.0], [136, "2024-11-13", 0.0, 5008.0, 330.24, 5008.0], [137, "2024-11-14", 0.0, 5008.0, 311.18, 5008.0], [138, "2024-11-15", 0.0, 5008.0, 320.72, 5008.0], [139, "2024-11-18", 0.0, 5008.0, 338.74, 5008.0], [140, "2024-11-19", -100.0, 39083.0, 346.0, 4483.0], [141, "2024-11-20", -100.0, 39083.0, 342.03, 4880.0], [142, "2024-11-21", -100.0, 39083.0, 339.64, 5119.0], [143, "2024-11-22", -100.0, 39083.0, 352.56, 3827.0], [144, "2024-11-25", 0.0, 3827.0, 338.59, 3827.0], [145, "2024-11-26", -100.0, 39883.0, 338.23, 6060.0], [146, "2024-11-27", -100.0, 39883.0, 332.89, 6594.0], [147, "2024-11-29", 0.0, 6850.98, 345.16, 6850.98], [148, "2024-12-02", 0.0, 6850.98, 357.09, 6850.98], [149, "2024-12-03", 0.0, 6850.98, 351.42, 6850.98], [150, "2024-12-04", 0.0, 6850.98, 357.93, 6850.98], [151, "2024-12-05", 0.0, 6850.98, 369.49, 6850.98], [152, "2024-12-06", 0.0, 6850.98, 389.22, 6850.98], [153, "2024-12-09", 0.0, 6850.98, 389.79, 6850.98], [154, "2024-12-10", 0.0, 6850.98, 400.99, 6850.98], [155, "2024-12-11", 0.0, 6850.98, 424.77, 6850.98], [156, "2024-12-12", 0.0, 6850.98, 418.1, 6850.98], [157, "2024-12-13", 0.0, 6850.98, 436.23, 6850.98], [158, "2024-12-16", 0.0, 6850.98, 463.02, 6850.98], [159, "2024-12-17", -100.0, 50961.98, 479.86, 2975.98], [160, "2024-12-18", -100.0, 50961.98, 440.13, 6948.98], [161, "2024-12-19", -100.0, 50961.98, 436.17, 7344.98], [162, "2024-12-20", -100.0, 50961.98, 421.06, 8855.98], [163, "2024-12-23", 0.0, 8855.98, 430.6, 8855.98], [164, "2024-12-24", 0.0, 8855.98, 462.28, 8855.98], [165, "2024-12-26", 0.0, 8855.98, 454.13, 8855.98], [166, "2024-12-27", 0.0, 8855.98, 431.66, 8855.98], [167, "2024-12-30", 0.0, 8855.98, 417.41, 8855.98], [168, "2024-12-31", 0.0, 8855.98, 403.84, 8855.98], [169, "2025-01-02", 0.0, 8855.98, 379.28, 8855.98], [170, "2025-01-03", 0.0, 8855.98, 410.44, 8855.98], [171, "2025-01-06", 0.0, 8855.98, 411.05, 8855.98], [172, "2025-01-07", 0.0, 8855.98, 394.36, 8855.98], [173, "2025-01-08", 0.0, 8855.98, 394.94, 8855.98], [174, "2025-01-10", 0.0, 8855.98, 394.74, 8855.98], [175, "2025-01-13", 0.0, 8855.98, 403.31, 8855.98], [176, "2025-01-14", 100.0, -29468.02, 396.36, 10167.98], [177, "2025-01-15", 0.0, 12329.85, 428.22, 12329.85], [178, "2025-01-16", 0.0, 12329.85, 413.82, 12329.85], [179, "2025-01-17", 0.0, 12329.85, 426.5, 12329.85], [180, "2025-01-21", 0.0, 12329.85, 424.07, 12329.85], [181, "2025-01-22", 0.0, 12329.85, 415.11, 12329.85], [182, "2025-01-23", 0.0, 12329.85, 412.38, 12329.85], [183, "2025-01-24", 0.0, 12329.85, 406.58, 12329.85], [184, "2025-01-27", 0.0, 12329.85, 397.15, 12329.85], [185, "2025-01-28", 0.0, 12329.85, 398.09, 12329.85], [186, "2025-01-29", 0.0, 12329.85, 389.1, 12329.85], [187, "2025-01-30", 0.0, 12329.85, 400.28, 12329.85], [188, "2025-01-31", 0.0, 12329.85, 404.6, 12329.85], [189, "2025-02-03", 0.0, 12329.85, 383.68, 12329.85], [190, "2025-02-04", 0.0, 12329.85, 392.21, 12329.85], [191, "2025-02-05", 0.0, 12329.85, 378.17, 12329.85], [192, "2025-02-06", 0.0, 12329.85, 374.32, 12329.85], [193, "2025-02-07", 0.0, 12329.85, 361.62, 12329.85], [194, "2025-02-10", 0.0, 12329.85, 350.73, 12329.85], [195, "2025-02-11", 0.0, 12329.85, 328.5, 12329.85], [196, "2025-02-12", 0.0, 12329.85, 336.51, 12329.85], [197, "2025-02-13", 0.0, 12329.85, 355.94, 12329.85], [198, "2025-02-14", 0.0, 12329.85, 355.84, 12329.85], [199, "2025-02-18", 0.0, 12329.85, 354.11, 12329.85], [200, "2025-02-19", 0.0, 12329.85, 360.56, 12329.85], [201, "2025-02-20", 0.0, 12329.85, 354.4, 12329.85], [202, "2025-02-21", 0.0, 12329.85, 337.8, 12329.85], [203, "2025-02-24", 0.0, 12329.85, 330.53, 12329.85], [204, "2025-02-25", 0.0, 12329.85, 302.8, 12329.85], [205, "2025-02-26", 0.0, 12329.85, 290.8, 12329.85], [206, "2025-02-27", 0.0, 12329.85, 281.95, 12329.85], [207, "2025-02-28", 0.0, 12329.85, 292.98, 12329.85], [208, "2025-03-03", 0.0, 12329.85, 284.65, 12329.85], [209, "2025-03-04", -100.0, 42361.85, 272.04, 15157.85], [210, "2025-03-05", 0.0, 14920.26, 279.1, 14920.26], [211, "2025-03-06", 0.0, 14920.26, 263.45, 14920.26], [212, "2025-03-07", 0.0, 14920.26, 262.67, 14920.26], [213, "2025-03-10", 0.0, 14920.26, 222.15, 14920.26], [214, "2025-03-11", 0.0, 14920.26, 230.58, 14920.26], [215, "2025-03-12", 0.0, 14920.26, 248.09, 14920.26], [216, "2025-03-13", 0.0, 14920.26, 240.68, 14920.26], [217, "2025-03-14", 0.0, 14920.26, 249.98, 14920.26], [218, "2025-03-17", 0.0, 14920.26, 238.01, 14920.26], [219, "2025-03-18", 0.0, 14920.26, 225.31, 14920.26], [220, "2025-03-19", 0.0, 14920.26, 235.86, 14920.26], [221, "2025-03-20", 0.0, 14920.26, 236.26, 14920.26], [222, "2025-03-21", 0.0, 14920.26, 248.71, 14920.26], [223, "2025-03-24", 0.0, 14920.26, 278.39, 14920.26], [224, "2025-03-25", 0.0, 14920.26, 288.14, 14920.26], [225, "2025-03-26", 0.0, 14920.26, 272.06, 14920.26], [226, "2025-03-27", 0.0, 14920.26, 273.13, 14920.26], [227, "2025-03-28", 0.0, 14920.26, 263.55, 14920.26], [228, "2025-03-31", 0.0, 14920.26, 259.16, 14920.26], [229, "2025-04-01", 0.0, 14920.26, 268.46, 14920.26], [230, "2025-04-02", 0.0, 14920.26, 282.76, 14920.26], [231, "2025-04-03", 0.0, 14920.26, 267.28, 14920.26], [232, "2025-04-04", 0.0, 14920.26, 239.43, 14920.26], [233, "2025-04-07", 0.0, 14920.26, 233.29, 14920.26], [234, "2025-04-08", 0.0, 14920.26, 221.86, 14920.26], [235, "2025-04-09", 0.0, 14920.26, 272.2, 14920.26], [236, "2025-04-10", 0.0, 14920.26, 252.4, 14920.26], [237, "2025-04-11", 0.0, 14920.26, 252.31, 14920.26], [238, "2025-04-14", 0.0, 14920.26, 252.35, 14920.26], [239, "2025-04-15", 0.0, 14920.26, 254.11, 14920.26], [240, "2025-04-16", 0.0, 14920.26, 241.55, 14920.26], [241, "2025-04-17", 0.0, 14920.26, 241.37, 14920.26], [242, "2025-04-21", 0.0, 14920.26, 227.5, 14920.26], [243, "2025-04-22", 0.0, 14920.26, 237.97, 14920.26], [244, "2025-04-23", 0.0, 14920.26, 250.74, 14920.26], [245, "2025-04-24", 0.0, 14920.26, 259.51, 14920.26], [246, "2025-04-25", 0.0, 14920.26, 284.95, 14920.26], [247, "2025-04-28", 0.0, 14920.26, 285.88, 14920.26], [248, "2025-04-29", 0.0, 14920.26, 292.03, 14920.26], [249, "2025-04-30", 0.0, 14920.26, 282.16, 14920.26]];

        // Define the dt_args
        let dt_args = {"layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "order": [], "warn_on_selected_rows_not_rendered": true};
        dt_args["data"] = data;

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<section id="navcharts-extra" class="level3">
<h3 class="anchored" data-anchor-id="navcharts-extra">NAV/Charts &amp; Extra</h3>
<div id="cb9665d8" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list to store categories</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>position_category <span class="op">=</span> []</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Categorize positions manually</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pos <span class="kw">in</span> ledger[<span class="st">'position'</span>]:</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Long'</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> pos <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Short'</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Cash Only'</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Add category column to ledger</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'position_category'</span>] <span class="op">=</span> position_category</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for each category</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> {<span class="st">'Long'</span>: <span class="st">'green'</span>, <span class="st">'Short'</span>: <span class="st">'red'</span>, <span class="st">'Cash Only'</span>: <span class="st">'blue'</span>}</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> []</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign colors manually</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat <span class="kw">in</span> ledger[<span class="st">'position_category'</span>]:</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    colors.append(color_map[cat])</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot NAV over time</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>plt.scatter(ledger[<span class="st">'date'</span>], ledger[<span class="st">'mkt_value'</span>], c<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Net Asset Value (NAV)'</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'NAV Over Time with Position Coloring, Standard Model'</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually add legend</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat, color <span class="kw">in</span> color_map.items():</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    plt.scatter([], [], color<span class="op">=</span>color, label<span class="op">=</span>cat)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Ledger</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>filtered_historical <span class="op">=</span> historical_data_daily[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">!=</span> historical_data_daily[<span class="st">'trd_prd'</span>].iloc[<span class="dv">0</span>]]</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>new_ledger <span class="op">=</span> pd.DataFrame()</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'date'</span>] <span class="op">=</span> filtered_historical[<span class="st">'timestamp'</span>]</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'position'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'cash'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'mark'</span>] <span class="op">=</span> historical_data_daily[<span class="st">'close'</span>][<span class="dv">1</span>:]</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="co">#new_ledger['cash'] = 50000</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trd_prd <span class="kw">in</span> blotter.index:</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> blotter.loc[trd_prd][<span class="st">'prediction'</span>] <span class="op">==</span> <span class="dv">0</span>: <span class="co"># if the trade is predicted to fail, no trade</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># if in train set or predicted success, make the trade</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> blotter.loc[trd_prd, <span class="st">'qty'</span>]</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>    entry_price <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'entry_price'</span>]</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    entry_timestamp <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'entry_timestamp'</span>]</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>    exit_timestamp <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'exit_timestamp'</span>]</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    exit_price <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'exit_price'</span>]</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'position'</span>] <span class="op">+=</span> qty</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'position'</span>] <span class="op">-=</span> qty</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'cash'</span>] <span class="op">-=</span> qty <span class="op">*</span> entry_price</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'cash'</span>] <span class="op">+=</span> qty <span class="op">*</span> exit_price</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a><span class="co"># finally, calculate your strategy's end-of-day mark-to-market value</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> new_ledger[<span class="st">'position'</span>] <span class="op">*</span> new_ledger[<span class="st">'mark'</span>] <span class="op">+</span> new_ledger[<span class="st">'cash'</span>]</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_ledger)</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list to store categories</span></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>position_category <span class="op">=</span> []</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Categorize positions manually</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pos <span class="kw">in</span> new_ledger[<span class="st">'position'</span>]:</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Long'</span>)</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> pos <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Short'</span>)</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Cash Only'</span>)</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Add category column to new_ledger</span></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'position_category'</span>] <span class="op">=</span> position_category</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for each category</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> {<span class="st">'Long'</span>: <span class="st">'green'</span>, <span class="st">'Short'</span>: <span class="st">'red'</span>, <span class="st">'Cash Only'</span>: <span class="st">'blue'</span>}</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> []</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign colors manually</span></span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat <span class="kw">in</span> new_ledger[<span class="st">'position_category'</span>]:</span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>    colors.append(color_map[cat])</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot NAV over time</span></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>plt.scatter(new_ledger[<span class="st">'date'</span>], new_ledger[<span class="st">'mkt_value'</span>], c<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Net Asset Value (NAV)'</span>)</span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'NAV Over Time with Position Coloring, Enhanced Model'</span>)</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually add legend</span></span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat, color <span class="kw">in</span> color_map.items():</span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>    plt.scatter([], [], color<span class="op">=</span>color, label<span class="op">=</span>cat)</span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return'</span>] <span class="op">=</span> (((blotter[<span class="st">'exit_price'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price'</span>]) <span class="op">/</span> blotter[<span class="st">'entry_price'</span>]) )<span class="op">*</span> np.sign(blotter[<span class="st">'qty'</span>])<span class="co"># get returns irrespective of long/short</span></span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nExit Timestamps:")</span></span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a><span class="co">#print(blotter['exit_timestamp'])</span></span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch entry and exit prices from historical_data_hourly based on timestamps</span></span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'entry_price_underlying'</span>] <span class="op">=</span> blotter[<span class="st">'entry_timestamp'</span>].<span class="bu">apply</span>(</span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> ts: historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> ts, <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">=</span> blotter.<span class="bu">apply</span>(</span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: (</span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a>        historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> (</span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>            historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="va">None</span>  <span class="co"># If neither dataset has the timestamp</span></span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a>    ), axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate return based on hourly data</span></span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return_underlying'</span>] <span class="op">=</span> (</span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a>    (blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price_underlying'</span>])<span class="op">/</span> blotter[<span class="st">'entry_price_underlying'</span>]) <span class="op">*</span> np.sign(blotter[<span class="st">'qty'</span>])</span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return_underlying'</span>])</span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a>original_index <span class="op">=</span> x.index.copy()</span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a>x.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a>dropped_rows <span class="op">=</span> original_index.difference(x.index)</span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return'</span>])</span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a>y.drop(index<span class="op">=</span>dropped_rows, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot of returns</span></span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a>plt.scatter(x, y, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">"Trades"</span>)</span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Underlying Return"</span>)</span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Strategy Return"</span>)</span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Strategy Return vs. Underlying Return, Standard Model"</span>)</span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a><span class="co">#print(x,y)</span></span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a linear regression model to get alpha and beta</span></span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a>x_with_const <span class="op">=</span> sm.add_constant(x)  <span class="co"># Adds intercept for regression</span></span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.OLS(y, x_with_const).fit()</span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a>alpha, beta <span class="op">=</span> model.params</span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot regression line</span></span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a>plt.plot(x, alpha <span class="op">+</span> beta <span class="op">*</span> x, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="ss">f"Regression Line (α=</span><span class="sc">{</span>alpha<span class="sc">:.4f}</span><span class="ss">, β=</span><span class="sc">{</span>beta<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Print alpha and beta values</span></span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a>alpha, beta</span>
<span id="cb17-166"><a href="#cb17-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-167"><a href="#cb17-167" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return'</span>] <span class="op">=</span> ((blotter[<span class="st">'exit_price'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price'</span>]) <span class="op">/</span> blotter[<span class="st">'entry_price'</span>]) <span class="op">*</span> np.sign(blotter[<span class="st">'qty'</span>])</span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nExit Timestamps:")</span></span>
<span id="cb17-170"><a href="#cb17-170" aria-hidden="true" tabindex="-1"></a><span class="co">#print(blotter['exit_timestamp'])</span></span>
<span id="cb17-171"><a href="#cb17-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-172"><a href="#cb17-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch entry and exit prices from historical_data_hourly based on timestamps</span></span>
<span id="cb17-173"><a href="#cb17-173" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'entry_price_underlying'</span>] <span class="op">=</span> blotter[<span class="st">'entry_timestamp'</span>].<span class="bu">apply</span>(</span>
<span id="cb17-174"><a href="#cb17-174" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> ts: historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> ts, <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb17-175"><a href="#cb17-175" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-176"><a href="#cb17-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-177"><a href="#cb17-177" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">=</span> blotter.<span class="bu">apply</span>(</span>
<span id="cb17-178"><a href="#cb17-178" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: (</span>
<span id="cb17-179"><a href="#cb17-179" aria-hidden="true" tabindex="-1"></a>        historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb17-180"><a href="#cb17-180" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb17-181"><a href="#cb17-181" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> (</span>
<span id="cb17-182"><a href="#cb17-182" aria-hidden="true" tabindex="-1"></a>            historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb17-183"><a href="#cb17-183" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb17-184"><a href="#cb17-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="va">None</span>  <span class="co"># If neither dataset has the timestamp</span></span>
<span id="cb17-185"><a href="#cb17-185" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-186"><a href="#cb17-186" aria-hidden="true" tabindex="-1"></a>    ), axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb17-187"><a href="#cb17-187" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-188"><a href="#cb17-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-189"><a href="#cb17-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate return based on hourly data</span></span>
<span id="cb17-190"><a href="#cb17-190" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return_underlying'</span>] <span class="op">=</span> ((blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price_underlying'</span>]) <span class="op">/</span> blotter[<span class="st">'entry_price_underlying'</span>])<span class="op">*</span> np.sign(blotter[<span class="st">'qty'</span>])</span>
<span id="cb17-191"><a href="#cb17-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-192"><a href="#cb17-192" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return_underlying'</span>])</span>
<span id="cb17-193"><a href="#cb17-193" aria-hidden="true" tabindex="-1"></a>original_index <span class="op">=</span> x.index.copy()</span>
<span id="cb17-194"><a href="#cb17-194" aria-hidden="true" tabindex="-1"></a>x.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-195"><a href="#cb17-195" aria-hidden="true" tabindex="-1"></a>dropped_rows <span class="op">=</span> original_index.difference(x.index)</span>
<span id="cb17-196"><a href="#cb17-196" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return'</span>])</span>
<span id="cb17-197"><a href="#cb17-197" aria-hidden="true" tabindex="-1"></a>y.drop(index<span class="op">=</span>dropped_rows, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-198"><a href="#cb17-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-199"><a href="#cb17-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot of returns</span></span>
<span id="cb17-200"><a href="#cb17-200" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb17-201"><a href="#cb17-201" aria-hidden="true" tabindex="-1"></a>plt.scatter(x, y, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">"Trades"</span>)</span>
<span id="cb17-202"><a href="#cb17-202" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Underlying Return"</span>)</span>
<span id="cb17-203"><a href="#cb17-203" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Strategy Return"</span>)</span>
<span id="cb17-204"><a href="#cb17-204" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Strategy Return vs. Underlying Return, Enhanced Model"</span>)</span>
<span id="cb17-205"><a href="#cb17-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-206"><a href="#cb17-206" aria-hidden="true" tabindex="-1"></a><span class="co">#print(x,y)</span></span>
<span id="cb17-207"><a href="#cb17-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-208"><a href="#cb17-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a linear regression model to get alpha and beta</span></span>
<span id="cb17-209"><a href="#cb17-209" aria-hidden="true" tabindex="-1"></a>x_with_const <span class="op">=</span> sm.add_constant(x)  <span class="co"># Adds intercept for regression</span></span>
<span id="cb17-210"><a href="#cb17-210" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.OLS(y, x_with_const).fit()</span>
<span id="cb17-211"><a href="#cb17-211" aria-hidden="true" tabindex="-1"></a>alpha, beta <span class="op">=</span> model.params</span>
<span id="cb17-212"><a href="#cb17-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-213"><a href="#cb17-213" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot regression line</span></span>
<span id="cb17-214"><a href="#cb17-214" aria-hidden="true" tabindex="-1"></a>plt.plot(x, alpha <span class="op">+</span> beta <span class="op">*</span> x, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="ss">f"Regression Line (α=</span><span class="sc">{</span>alpha<span class="sc">:.4f}</span><span class="ss">, β=</span><span class="sc">{</span>beta<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb17-215"><a href="#cb17-215" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb17-216"><a href="#cb17-216" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb17-217"><a href="#cb17-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-218"><a href="#cb17-218" aria-hidden="true" tabindex="-1"></a><span class="co"># Print alpha and beta values</span></span>
<span id="cb17-219"><a href="#cb17-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-220"><a href="#cb17-220" aria-hidden="true" tabindex="-1"></a>alpha, beta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>          date  position         cash    mark    mkt_value
8   2024-05-13       0.0      0.00000  171.89      0.00000
9   2024-05-14       0.0      0.00000  177.55      0.00000
10  2024-05-15       0.0      0.00000  173.99      0.00000
11  2024-05-16       0.0      0.00000  174.84      0.00000
12  2024-05-17       0.0      0.00000  177.46      0.00000
..         ...       ...          ...     ...          ...
245 2025-04-24       0.0  12329.84868  259.51  12329.84868
246 2025-04-25       0.0  12329.84868  284.95  12329.84868
247 2025-04-28       0.0  12329.84868  285.88  12329.84868
248 2025-04-29       0.0  12329.84868  292.03  12329.84868
249 2025-04-30       0.0  12329.84868  282.16  12329.84868

[242 rows x 5 columns]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="performance-statistics" class="level2">
<h2 class="anchored" data-anchor-id="performance-statistics">7. Performance Statistics</h2>
<p>At a high level, we compute: - <strong>Alpha &amp; Beta</strong> (vs SPX benchmark) - <strong>Annualized Volatility</strong> of strategy returns - <strong>Geometric Mean Rate of Return</strong> (annualized) - <strong>Sharpe Ratio</strong> (assuming zero risk‐free rate) - <strong>Average return per trade</strong> - <strong>Average number of trades per year</strong></p>
<div id="d3d22db8" class="cell" data-message="false" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> gmean</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itables <span class="im">import</span> show</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) make sure benchmark returns are up to date</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>benchmark[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(benchmark[<span class="st">'timestamp'</span>])</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>benchmark[<span class="st">'trd_prd'</span>] <span class="op">=</span> benchmark[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>period_spx <span class="op">=</span> (</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    benchmark</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">'timestamp'</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'trd_prd'</span>)[<span class="st">'close'</span>]</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    .agg(first<span class="op">=</span><span class="st">'first'</span>, last<span class="op">=</span><span class="st">'last'</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>period_spx[<span class="st">'return'</span>] <span class="op">=</span> period_spx[<span class="st">'last'</span>] <span class="op">/</span> period_spx[<span class="st">'first'</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) extract our strategy's per‐period returns</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>strat_ret <span class="op">=</span> blotter[<span class="st">'return'</span>].astype(<span class="bu">float</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) align and drop any NaNs</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>bench_ret <span class="op">=</span> period_spx[<span class="st">'return'</span>].reindex(strat_ret.index)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.concat([strat_ret, bench_ret], axis<span class="op">=</span><span class="dv">1</span>, keys<span class="op">=</span>[<span class="st">'strat'</span>,<span class="st">'bench'</span>]).dropna()</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) regress strat on bench to get alpha/beta</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> df[<span class="st">'strat'</span>]</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> sm.add_constant(df[<span class="st">'bench'</span>])</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.OLS(Y, X).fit()</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>alpha, beta <span class="op">=</span> model.params[<span class="st">'const'</span>], model.params[<span class="st">'bench'</span>]</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) annualized volatility (weekly data → √52)</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>ann_vol <span class="op">=</span> strat_ret.std() <span class="op">*</span> np.sqrt(<span class="dv">52</span>)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) geometric mean return (annualized)</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="co">#    drop zero‐return periods to avoid gmean(1.0) bias</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>gm <span class="op">=</span> gmean(<span class="dv">1</span> <span class="op">+</span> strat_ret[strat_ret <span class="op">!=</span> <span class="dv">0</span>]) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>geo_ann <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> gm)<span class="op">**</span><span class="dv">52</span> <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 7) Sharpe ratio (zero RF)</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>sharpe <span class="op">=</span> strat_ret.mean() <span class="op">/</span> strat_ret.std() <span class="op">*</span> np.sqrt(<span class="dv">52</span>)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 8) average return per trade</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>avg_ret_trade <span class="op">=</span> strat_ret.mean()</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 9) average number of trades per year</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>n_trades <span class="op">=</span> (strat_ret <span class="op">!=</span> <span class="dv">0</span>).<span class="bu">sum</span>()</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>years <span class="op">=</span> <span class="bu">len</span>(strat_ret) <span class="op">/</span> <span class="dv">52</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>trades_per_year <span class="op">=</span> n_trades <span class="op">/</span> years</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 10) assemble into a Series and show</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>stats <span class="op">=</span> pd.Series({</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Alpha'</span>: alpha,</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Beta'</span>: beta,</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Volatility'</span>: ann_vol,</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Geometric Mean Return'</span>: geo_ann,</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe,</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Avg Return/Trade'</span>: avg_ret_trade,</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Trades/Year'</span>: trades_per_year</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>show(stats.to_frame(<span class="st">'Value'</span>).<span class="bu">round</span>(<span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<table id="itables_3e733c9a_e2f9_44d1_8363_7c9da78f208e" class="display nowrap" data-quarto-disable-processing="true" style="table-layout:auto;width:auto;margin:auto;caption-side:bottom">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Value</th>
    </tr>
  </thead><tbody><tr>
<td style="vertical-align:middle; text-align:left">
<a href="https://mwouts.github.io/itables/"><svg class="main-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="64" viewbox="0 0 500 400" style="font-family: 'Droid Sans', sans-serif;">
    <g style="fill:#d9d7fc">
        <path d="M100,400H500V357H100Z"></path>
        <path d="M100,300H400V257H100Z"></path>
        <path d="M0,200H400V157H0Z"></path>
        <path d="M100,100H500V57H100Z"></path>
        <path d="M100,350H500V307H100Z"></path>
        <path d="M100,250H400V207H100Z"></path>
        <path d="M0,150H400V107H0Z"></path>
        <path d="M100,50H500V7H100Z"></path>
    </g>
    <g style="fill:#1a1366;stroke:#1a1366;">
   <rect x="100" y="7" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="5s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="0" y="107" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="3.5s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="0;0;400" dur="3.5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="207" width="300" height="43">
    <animate attributename="width" values="0;300;0" dur="3s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="100;100;400" dur="3s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="307" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="4s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="4s" repeatcount="indefinite"></animate>
  </rect>
        <g style="fill:transparent;stroke-width:8; stroke-linejoin:round" rx="5">
            <g transform="translate(45 50) rotate(-45)">
                <circle r="33" cx="0" cy="0"></circle>
                <rect x="-8" y="32" width="16" height="30"></rect>
            </g>

            <g transform="translate(450 152)">
                <polyline points="-15,-20 -35,-20 -35,40 25,40 25,20"></polyline>
                <rect x="-15" y="-40" width="60" height="60"></rect>
            </g>

            <g transform="translate(50 352)">
                <polygon points="-35,-5 0,-40 35,-5"></polygon>
                <polygon points="-35,10 0,45 35,10"></polygon>
            </g>

            <g transform="translate(75 250)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>

            <g transform="translate(425 250) rotate(180)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>
        </g>
    </g>
</svg>
</a>
Loading ITables v2.3.0 from the internet...
(need <a href="https://mwouts.github.io/itables/troubleshooting.html">help</a>?)</td>
</tr></tbody>
</table>
<link href="https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.css" rel="stylesheet">
<script type="module">
    import {DataTable, jQuery as $} from 'https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.js';

    document.querySelectorAll("#itables_3e733c9a_e2f9_44d1_8363_7c9da78f208e:not(.dataTable)").forEach(table => {
        if (!(table instanceof HTMLTableElement))
            return;

        // Define the table data
        const data = [["Alpha", 0.0093], ["Beta", 0.0496], ["Annualized Volatility", 0.2212], ["Geometric Mean Return", 6.2241], ["Sharpe Ratio", 2.218], ["Avg Return/Trade", 0.0094], ["Trades/Year", 12.2353]];

        // Define the dt_args
        let dt_args = {"layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "order": [], "warn_on_selected_rows_not_rendered": true};
        dt_args["data"] = data;

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>