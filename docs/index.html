<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>thesctrading</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-985aa47af68dae11cd4d235c71fb941e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-c1fac2584b48ed01fb6e278e36375074.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">thesctrading</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sc-trading-strategy-overview" id="toc-sc-trading-strategy-overview" class="nav-link active" data-scroll-target="#sc-trading-strategy-overview">S&amp;C Trading Strategy Overview</a>
  <ul class="collapse">
  <li><a href="#strategy-outline" id="toc-strategy-outline" class="nav-link" data-scroll-target="#strategy-outline">1. Strategy Outline</a></li>
  <li><a href="#exit-strategy" id="toc-exit-strategy" class="nav-link" data-scroll-target="#exit-strategy">2. Exit Strategy</a></li>
  <li><a href="#position-sizing-framework" id="toc-position-sizing-framework" class="nav-link" data-scroll-target="#position-sizing-framework">3. Position Sizing Framework</a></li>
  <li><a href="#data-requirements" id="toc-data-requirements" class="nav-link" data-scroll-target="#data-requirements">4. Data Requirements</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">5. Next Steps</a></li>
  <li><a href="#fred-data-software-developer-job-postings" id="toc-fred-data-software-developer-job-postings" class="nav-link" data-scroll-target="#fred-data-software-developer-job-postings">6. FRED Data: Software Developer Job Postings</a></li>
  </ul></li>
  <li><a href="#blotter-ledger-code" id="toc-blotter-ledger-code" class="nav-link" data-scroll-target="#blotter-ledger-code">Blotter &amp; Ledger Code</a>
  <ul class="collapse">
  <li><a href="#fetch-data" id="toc-fetch-data" class="nav-link" data-scroll-target="#fetch-data">Fetch data</a></li>
  <li><a href="#clean-data" id="toc-clean-data" class="nav-link" data-scroll-target="#clean-data">Clean Data</a></li>
  <li><a href="#print-dfs" id="toc-print-dfs" class="nav-link" data-scroll-target="#print-dfs">Print DFs</a></li>
  <li><a href="#vol" id="toc-vol" class="nav-link" data-scroll-target="#vol">Vol</a></li>
  <li><a href="#blotter-ledger" id="toc-blotter-ledger" class="nav-link" data-scroll-target="#blotter-ledger">Blotter &amp; Ledger</a></li>
  <li><a href="#extra" id="toc-extra" class="nav-link" data-scroll-target="#extra">Extra</a></li>
  </ul></li>
  <li><a href="#outputting-interactive-blotter-ledger-final-hw-here" id="toc-outputting-interactive-blotter-ledger-final-hw-here" class="nav-link" data-scroll-target="#outputting-interactive-blotter-ledger-final-hw-here">Outputting Interactive Blotter &amp; Ledger (FINAL HW HERE)</a>
  <ul class="collapse">
  <li><a href="#navcharts-extra-not-necessary" id="toc-navcharts-extra-not-necessary" class="nav-link" data-scroll-target="#navcharts-extra-not-necessary">NAV/Charts &amp; Extra (not necessary)</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">thesctrading</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sc-trading-strategy-overview" class="level2">
<h2 class="anchored" data-anchor-id="sc-trading-strategy-overview">S&amp;C Trading Strategy Overview</h2>
<section id="strategy-outline" class="level3">
<h3 class="anchored" data-anchor-id="strategy-outline">1. Strategy Outline</h3>
<p>Our team is implementing a buy low / sell high strategy focused on short-term momentum trading in TSLA stock. We aim to take advantage of periods of elevated volatility and momentum, holding positions for 10 trading days or less. We use the 10 day window to account for the fact that some of our data sources are weekly and may provide more signal over a longer trade horizon. Of course, if the system hits its limit point during the window, the position will close similar to our HW1 model.</p>
<p><em>note that we plan to use backward elimination ML method to determine most important features. We plan to trial a variety of alternative data features from FRED (detailed at the end of the website) as well as some competitor company technical factors. <strong>We also wish to include valuation metrics using the yfinance package.</strong></em></p>
<section id="example-trade-walkthrough" class="level4">
<h4 class="anchored" data-anchor-id="example-trade-walkthrough">Example Trade Walkthrough</h4>
<p>Pre-Trade Filter</p>
<ol type="1">
<li>Check if job postings for software roles increased week-over-week (as well as other FRED/alternative data including pairs performance)</li>
<li>Check if implied volatility (IV) percentile &gt; 50% and &lt; 90%</li>
<li>If both are true → proceed to trade evaluation</li>
</ol>
<hr>
<p>Buy Conditions</p>
<ol type="1">
<li>Price is above the 50-day SMA (or EMA) <em>note we may also include valuation metrics here to avoid extreme overvaluation given our long-only strategy</em></li>
<li>Gamma exposure is positive (or some other Greek we can calculate)</li>
</ol>
<hr>
</section>
</section>
<section id="exit-strategy" class="level3">
<h3 class="anchored" data-anchor-id="exit-strategy">2. Exit Strategy</h3>
<p>We use four exit triggers to manage risk and lock in profits:</p>
<ol type="1">
<li>If position is open for more than 10 trading days, exit regardless of performance</li>
<li>If IV percentile drops below 30%, exit</li>
<li>Exit if price reaches a profit target of 2x last week’s average true range (ATR)</li>
<li>Use a trailing stop loss of 1.5x ATR below the highest price reached since entry</li>
</ol>
<hr>
</section>
<section id="position-sizing-framework" class="level3">
<h3 class="anchored" data-anchor-id="position-sizing-framework">3. Position Sizing Framework</h3>
<p>Position size will adapt based on strength of indicators and perhaps on a regression of additional features not used to determine the weekly position strategy similar to the logistic regression model used in HW1. We envision a less binary model where sizing is continuous determined on a variety of features (allows us to take risk off but also keep risk on more granularly than the original model).</p>
<p>Conditions for each tier will be finalized after further backtesting.</p>
<hr>
</section>
<section id="data-requirements" class="level3">
<h3 class="anchored" data-anchor-id="data-requirements">4. Data Requirements</h3>
<p>We plan to collect and process:</p>
<ul>
<li>Price data and technical indicators (SMA, ATR, IV, Options contracts)</li>
<li>Job posting data &amp; other relevant metrics from FRED</li>
<li>Automotive industry data from FRED</li>
<li>Implied volatility percentile data (via IBKR)</li>
</ul>
<p>We may use the FRED API, yFinance, or custom scrapers to automate data gathering.</p>
<hr>
</section>
<section id="next-steps" class="level3">
<h3 class="anchored" data-anchor-id="next-steps">5. Next Steps</h3>
<ul>
<li>Gather full feature list and find good alt data and implement backward elimination model to decide useful features</li>
<li>Build &amp; backtest position sizing model</li>
<li>Backtest the strategy on historical TSLA data</li>
<li>Deploy the final version to https://thesctrading.com</li>
</ul>
</section>
<section id="fred-data-software-developer-job-postings" class="level3">
<h3 class="anchored" data-anchor-id="fred-data-software-developer-job-postings">6. FRED Data: Software Developer Job Postings</h3>
<p>The below is demonstrating our ability to use the FRED API to pull in features. This example is weekly software job postings. We plan to scour FRED to identify other features that may be useful. Other things may include potential regulatory items or things indicating sentiment on Elon as well as other automotive industry stats including production, CPI, etc. We plan to test a variety and perhaps identify the most powerful features through supervised feature selection methods. Likely <strong>backward selection</strong> where the model evaluates all the features and removes the least powerful/most noisy one by one.</p>
<div id="cea51292" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fredapi <span class="im">import</span> Fred</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to FRED</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>fred <span class="op">=</span> Fred(api_key<span class="op">=</span><span class="st">"1c00931ee7dc4304c6bb68b72fb2d68f"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch data</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>series_id <span class="op">=</span> <span class="st">"IHLIDXUSTPSOFTDEVE"</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> fred.get_series(series_id)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to DataFrame</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data, columns<span class="op">=</span>[<span class="st">"Job Postings"</span>])</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>df.index.name <span class="op">=</span> <span class="st">"Date"</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.reset_index()</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Display last 5 rows as table</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>df.tail()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Job Postings</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1899</td>
<td>2025-04-14</td>
<td>64.17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1900</td>
<td>2025-04-15</td>
<td>64.04</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1901</td>
<td>2025-04-16</td>
<td>63.84</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1902</td>
<td>2025-04-17</td>
<td>63.81</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1903</td>
<td>2025-04-18</td>
<td>63.77</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="a4d5a357" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the time series</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>plt.plot(df[<span class="st">"Date"</span>], df[<span class="st">"Job Postings"</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"US Software Developer Job Postings Index"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Index Value"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="blotter-ledger-code" class="level1">
<h1>Blotter &amp; Ledger Code</h1>
<div id="6955e261" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shinybroker <span class="im">as</span> sb</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="fetch-data" class="level3">
<h3 class="anchored" data-anchor-id="fetch-data">Fetch data</h3>
<div id="88d4e5d3" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>asset<span class="op">=</span> sb.Contract({</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'symbol'</span>: <span class="st">"ARES"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'secType'</span>: <span class="st">"STK"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'exchange'</span>: <span class="st">"SMART"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'currency'</span>: <span class="st">"USD"</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>benchmark <span class="op">=</span> sb.Contract({</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'symbol'</span>: <span class="st">"SPX"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'secType'</span>: <span class="st">"IND"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'exchange'</span>: <span class="st">"CBOE"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'currency'</span>: <span class="st">"USD"</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#### Get hourly data to use for calculating vol</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>historical_data_hourly_fetch <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    endDateTime<span class="op">=</span><span class="st">''</span>,         <span class="co"># Let IBKR set the "now" time</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'1 Y'</span>,      <span class="co"># Past 1 year</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 hour'</span>, <span class="co"># Daily bars</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    whatToShow<span class="op">=</span><span class="st">'TRADES'</span>,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#date_format=1,          # String time zone date</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#keepUpToDate=False</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>historical_data_hourly <span class="op">=</span> historical_data_hourly_fetch[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co">#### Get daily data as well because it speeds up the code</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co">####   writing process.</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>historical_data_daily_fetch <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    endDateTime<span class="op">=</span><span class="st">''</span>,         <span class="co"># Let IBKR set the "now" time</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'1 Y'</span>,      <span class="co"># Past 1 year</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 day'</span>, <span class="co"># Daily bars</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    whatToShow<span class="op">=</span><span class="st">'TRADES'</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">#date_format=1,          # String time zone date</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">#keepUpToDate=False</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>historical_data_daily <span class="op">=</span> historical_data_daily_fetch[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="co"># print("HDD", historical_data_daily)</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co">#### Fetch your liquid trading hours for the asset</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="co">#### You'll need this later!</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>ares_deets <span class="op">=</span> sb.fetch_contract_details(</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>sb.Contract({</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'symbol'</span>: <span class="st">"ARES"</span>,</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'secType'</span>: <span class="st">"STK"</span>,</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'exchange'</span>: <span class="st">"SMART"</span>,</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'currency'</span>: <span class="st">"USD"</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>liquid_hours <span class="op">=</span> ares_deets[<span class="st">'liquidHours'</span>]</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="co"># print(liquid_hours)</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co">#liquid_hours = (ares_deets['liquidHours'][0])</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> safe_fetch_iv(contract, durationStr, barSizeSetting, label):</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        fetch <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>            contract<span class="op">=</span>contract,</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>            endDateTime<span class="op">=</span><span class="st">''</span>,</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>            durationStr<span class="op">=</span>durationStr,</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>            barSizeSetting<span class="op">=</span>barSizeSetting,</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>            whatToShow<span class="op">=</span><span class="st">'OPTION_IMPLIED_VOLATILITY'</span>,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>            useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> fetch[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> IV data fetched. Rows: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> IV fetch failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace your fetch calls with:</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a><span class="co">#iv_historical_data_hourly = safe_fetch_iv(</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a><span class="co">#    contract=asset,</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a><span class="co">#    durationStr='1 Y',</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a><span class="co">#    barSizeSetting='1 hour',</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a><span class="co">#    label="Hourly"</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a><span class="co">#)</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>iv_historical_data_daily <span class="op">=</span> safe_fetch_iv(</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'1 Y'</span>,</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 day'</span>,</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Daily"</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: preview what was fetched</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a><span class="co"># print(iv_historical_data_daily.head())</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>historical_data_daily_fetch_SMA <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    contract<span class="op">=</span>asset,</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    endDateTime<span class="op">=</span><span class="st">''</span>,         <span class="co"># Let IBKR set the "now" time</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    durationStr<span class="op">=</span><span class="st">'2 Y'</span>,      <span class="co"># Past 1 year</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>    barSizeSetting<span class="op">=</span><span class="st">'1 day'</span>, <span class="co"># Daily bars</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    whatToShow<span class="op">=</span><span class="st">'TRADES'</span>,</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>    useRTH<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">#date_format=1,          # String time zone date</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">#keepUpToDate=False</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA <span class="op">=</span> historical_data_daily_fetch_SMA[<span class="st">'hst_dta'</span>]<span class="co">#%% md</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Daily IV data fetched. Rows: 250</code></pre>
</div>
</div>
</section>
<section id="clean-data" class="level3">
<h3 class="anchored" data-anchor-id="clean-data">Clean Data</h3>
<div id="4f88e051" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure 'date' is a datetime column</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(historical_data_daily_SMA[<span class="st">'timestamp'</span>])</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by date just to be safe</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA <span class="op">=</span> historical_data_daily_SMA.sort_values(<span class="st">'timestamp'</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate 20-day simple moving average</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA[<span class="st">'SMA_20'</span>] <span class="op">=</span> historical_data_daily_SMA[<span class="st">'close'</span>].rolling(window<span class="op">=</span><span class="dv">20</span>).mean()</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(historical_data_daily_SMA[<span class="st">'SMA_20'</span>])</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">#### Prepare Data</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate trade period</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_trade_period(dt):</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    iso_year, iso_week, _ <span class="op">=</span> dt.isocalendar()</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(<span class="ss">f"</span><span class="sc">{</span>iso_year<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>iso_week<span class="sc">:02d}</span><span class="ss">"</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure 'date' column is in datetime format</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(historical_data_daily[<span class="st">'timestamp'</span>])</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(historical_data_hourly[<span class="st">'timestamp'</span>])</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>iv_historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(iv_historical_data_daily[<span class="st">'timestamp'</span>])</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co">#iv_historical_data_hourly['timestamp'] = pd.to_datetime(iv_historical_data_hourly['timestamp'])</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co">#liquid_hours['timestamp'] = pd.to_datetime(liquid_hours['timestamp'])</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply trade period calculation</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">=</span> historical_data_daily[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">=</span> historical_data_hourly[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>iv_historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">=</span> iv_historical_data_daily[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co">#iv_historical_data_hourly['trd_prd'] = iv_historical_data_hourly['timestamp'].apply(get_trade_period)</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>historical_data_daily_SMA[<span class="st">'trd_prd'</span>] <span class="op">=</span> historical_data_daily_SMA[<span class="st">'timestamp'</span>].<span class="bu">apply</span>(get_trade_period)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co">#liquid_hours['trd_prd'] = liquid_hours['timestamp'].apply(get_trade_period)</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the first full five-trading-day week</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>weekly_counts <span class="op">=</span> historical_data_daily.groupby(<span class="st">'trd_prd'</span>)[<span class="st">'timestamp'</span>].count()</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>first_full_week <span class="op">=</span> weekly_counts[weekly_counts <span class="op">&gt;=</span> <span class="dv">5</span>].index.<span class="bu">min</span>()</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter historical_data_daily</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>historical_data_daily <span class="op">=</span> historical_data_daily[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">&gt;=</span> first_full_week]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>0          NaN
1          NaN
2          NaN
3          NaN
4          NaN
        ...   
496    139.728
497    140.002
498    140.426
499    140.735
500    140.737
Name: SMA_20, Length: 501, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="print-dfs" class="level3">
<h3 class="anchored" data-anchor-id="print-dfs">Print DFs</h3>
<div id="08142a0d" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print dataframes</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Historical Data Daily:"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(historical_data_daily)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Historical Data Hourly:"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(historical_data_hourly)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"IV Historical Data Daily:"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(iv_historical_data_daily)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\n IV Historical Data Hourly:")</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">#print(iv_historical_data_daily)</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Historical SMA Data Daily:"</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(historical_data_daily_SMA)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Liquid Hours:"</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(liquid_hours)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Historical Data Daily:
     timestamp    open    high     low   close  volume      wap  barCount  \
3   2024-05-06  132.31  136.22  132.28  136.17  931552  134.566      4521   
4   2024-05-07  137.03  140.35  136.54  137.29  854703  138.385      5278   
5   2024-05-08  136.25  138.75  135.46  138.67  408812  137.935      2941   
6   2024-05-09  138.34  143.13  138.34  142.44  940456  142.102      6212   
7   2024-05-10  143.69  144.35  141.60  142.27  422158  142.562      2688   
..         ...     ...     ...     ...     ...     ...      ...       ...   
245 2025-04-24  146.35  153.92  145.15  152.97  739281  151.828      5002   
246 2025-04-25  151.93  154.41  150.82  153.88  639964  153.333      4120   
247 2025-04-28  153.94  156.54  151.93  153.38  824638  153.635      5268   
248 2025-04-29  153.00  153.68  150.82  152.79  477799  152.673      3390   
249 2025-04-30  148.81  150.70  146.18  149.48  321291  148.582      1756   

     trd_prd  
3    2024.19  
4    2024.19  
5    2024.19  
6    2024.19  
7    2024.19  
..       ...  
245  2025.17  
246  2025.17  
247  2025.18  
248  2025.18  
249  2025.18  

[247 rows x 9 columns]

Historical Data Hourly:
               timestamp    open    high     low   close  volume      wap  \
0    2024-05-01 09:30:00  132.88  133.27  131.57  132.11   35410  132.256   
1    2024-05-01 10:00:00  132.26  133.58  132.21  132.93  145326  132.939   
2    2024-05-01 11:00:00  132.95  132.99  131.90  132.18   70533  132.445   
3    2024-05-01 12:00:00  132.18  132.51  131.74  132.15   54395  132.108   
4    2024-05-01 13:00:00  132.15  132.44  131.53  132.42   70340  131.964   
...                  ...     ...     ...     ...     ...     ...      ...   
1733 2025-04-29 15:00:00  152.61  153.14  152.37  152.72  193788  152.795   
1734 2025-04-30 09:30:00  148.81  149.80  146.18  146.46   45424  147.802   
1735 2025-04-30 10:00:00  146.63  148.88  146.39  148.66  168982  148.252   
1736 2025-04-30 11:00:00  148.67  150.12  148.67  150.03   95532  149.355   
1737 2025-04-30 12:00:00  150.28  150.70  149.19  149.48   11353  150.097   

      barCount  trd_prd  
0          156  2024.18  
1          790  2024.18  
2          528  2024.18  
3          387  2024.18  
4          438  2024.18  
...        ...      ...  
1733      1442  2025.18  
1734       237  2025.18  
1735       778  2025.18  
1736       654  2025.18  
1737        87  2025.18  

[1738 rows x 9 columns]
IV Historical Data Daily:
     timestamp      open      high       low     close  volume    wap  \
0   2024-05-01  0.310617  0.337032  0.290694  0.307918       1  0.337   
1   2024-05-02  0.296456  0.317855  0.251341  0.276788       1  0.318   
2   2024-05-03  0.283535  0.283535  0.239022  0.256929       1  0.284   
3   2024-05-06  0.258627  0.291964  0.237848  0.245769       1  0.292   
4   2024-05-07  0.248674  0.254627  0.233101  0.237181       1  0.255   
..         ...       ...       ...       ...       ...     ...    ...   
245 2025-04-24  0.482426  0.497269  0.435708  0.446375       1  0.497   
246 2025-04-25  0.453360  0.502476  0.453360  0.460440       1  0.502   
247 2025-04-28  0.447153  0.469917  0.416912  0.442311       1  0.470   
248 2025-04-29  0.433961  0.470314  0.433961  0.461631       1  0.470   
249 2025-04-30  0.448566  0.481013  0.401149  0.410340       1  0.481   

     barCount  trd_prd  
0           0  2024.18  
1           0  2024.18  
2           0  2024.18  
3           0  2024.19  
4           0  2024.19  
..        ...      ...  
245         0  2025.17  
246         0  2025.17  
247         0  2025.18  
248         0  2025.18  
249         0  2025.18  

[250 rows x 9 columns]
Historical SMA Data Daily:
     timestamp    open    high     low   close   volume      wap  barCount  \
0   2023-05-02   84.81   84.90   81.63   82.46  1130134   82.666      8112   
1   2023-05-03   82.17   83.75   81.84   82.09   487278   82.595      3801   
2   2023-05-04   82.01   82.01   77.97   79.53   993988   79.411      6526   
3   2023-05-05   80.77   82.16   80.42   81.95   576112   81.691      3728   
4   2023-05-08   82.20   83.86   81.60   81.96   584637   82.383      4334   
..         ...     ...     ...     ...     ...      ...      ...       ...   
496 2025-04-24  146.35  153.92  145.15  152.97   739281  151.828      5002   
497 2025-04-25  151.93  154.41  150.82  153.88   639964  153.333      4120   
498 2025-04-28  153.94  156.54  151.93  153.38   824638  153.635      5268   
499 2025-04-29  153.00  153.68  150.82  152.79   477799  152.673      3390   
500 2025-04-30  148.81  150.70  146.18  149.48   321291  148.582      1756   

      SMA_20  trd_prd  
0        NaN  2023.18  
1        NaN  2023.18  
2        NaN  2023.18  
3        NaN  2023.18  
4        NaN  2023.19  
..       ...      ...  
496  139.728  2025.17  
497  140.002  2025.17  
498  140.426  2025.18  
499  140.735  2025.18  
500  140.737  2025.18  

[501 rows x 10 columns]

Liquid Hours:
0               start_time  end_time  closed
2025-0...
Name: liquidHours, dtype: object</code></pre>
</div>
</div>
</section>
<section id="vol" class="level3">
<h3 class="anchored" data-anchor-id="vol">Vol</h3>
<div id="32b39fdd" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calc Obs &amp; Exp Vol</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trade periods from daily historical data</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>trade_periods <span class="op">=</span> historical_data_daily[<span class="st">'trd_prd'</span>].unique()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate observed volatility using hourly data</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>hourly_log_returns <span class="op">=</span> np.log(historical_data_hourly[<span class="st">'close'</span>] <span class="op">/</span> historical_data_hourly[<span class="st">'close'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>hourly_vols <span class="op">=</span> hourly_log_returns.groupby(historical_data_hourly[<span class="st">'timestamp'</span>].dt.strftime(<span class="st">'%Y-%W'</span>)).std()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert hourly vol to weekly vol (scale by sqrt(32.5))</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>weekly_vols <span class="op">=</span> hourly_vols <span class="op">*</span> np.sqrt(<span class="fl">32.5</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>vol_calcs <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>trade_periods, columns<span class="op">=</span>[<span class="st">'obs_vol'</span>, <span class="st">'exp_vol'</span>])</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>vol_calcs[<span class="st">'obs_vol'</span>] <span class="op">=</span> weekly_vols.values[:<span class="bu">len</span>(trade_periods)]</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Set expected vol (shifted obs_vol)</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>vol_calcs[<span class="st">'exp_vol'</span>] <span class="op">=</span> vol_calcs[<span class="st">'obs_vol'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co"># print("\nVolatility Calculations:")</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># print(vol_calcs)</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calc Obs &amp; Exp Vol</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trade periods from daily historical data</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>trade_periods <span class="op">=</span> historical_data_daily[<span class="st">'trd_prd'</span>].unique()</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate observed volatility using hourly data</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>hourly_log_returns <span class="op">=</span> np.log(historical_data_hourly[<span class="st">'close'</span>] <span class="op">/</span> historical_data_hourly[<span class="st">'close'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>hourly_vols <span class="op">=</span> hourly_log_returns.groupby(historical_data_hourly[<span class="st">'timestamp'</span>].dt.strftime(<span class="st">'%Y-%W'</span>)).std()</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert hourly vol to weekly vol (scale by sqrt(32.5))</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>weekly_vols <span class="op">=</span> hourly_vols <span class="op">*</span> np.sqrt(<span class="fl">32.5</span>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>smart_vol_calcs <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>trade_periods, columns<span class="op">=</span>[<span class="st">'obs_vol'</span>, <span class="st">'exp_vol'</span>])</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>smart_vol_calcs[<span class="st">'obs_vol'</span>] <span class="op">=</span> weekly_vols.values[:<span class="bu">len</span>(trade_periods)]</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Set expected vol (from options IV)</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trd_prd <span class="kw">in</span> smart_vol_calcs.index:</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    smart_vol_calcs.at[trd_prd, <span class="st">'exp_vol'</span>] <span class="op">=</span> iv_historical_data_daily.loc[</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>        iv_historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'open'</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    ].iloc[<span class="dv">0</span>] <span class="op">*</span> np.sqrt(<span class="dv">1</span><span class="op">/</span><span class="dv">52</span>)</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Volatility Calculations:"</span>)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(smart_vol_calcs)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>vol_calcs <span class="op">=</span> smart_vol_calcs</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a><span class="co">#vol_calcs = smart_vol_calcs # manually toggle active vol calc</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Volatility Calculations:
          obs_vol   exp_vol
2024.19  0.075695  0.035865
2024.20  0.041709   0.03117
2024.21  0.030747  0.028702
2024.22  0.055541  0.030333
2024.23  0.026734  0.035066
2024.24  0.035181  0.036792
2024.25  0.049880  0.033094
2024.26  0.024201  0.034252
2024.27  0.025558   0.03603
2024.28  0.025460  0.035568
2024.29  0.035751  0.037886
2024.30  0.040661  0.041298
2024.31  0.038725  0.041963
2024.32  0.065120  0.046619
2024.33  0.078962  0.038366
2024.34  0.028736  0.031572
2024.35  0.019785  0.032297
2024.36  0.026346  0.030705
2024.37  0.031696  0.037873
2024.38  0.034750  0.036887
2024.39  0.032657  0.035955
2024.40  0.019770  0.040691
2024.41  0.031140  0.042945
2024.42  0.044910  0.041672
2024.43  0.030065  0.042331
2024.44  0.027089  0.043407
2024.45  0.048315  0.042075
2024.46  0.064099  0.033809
2024.47  0.033129  0.035425
2024.48  0.024092  0.034119
2024.49  0.028234  0.034258
2024.50  0.021655  0.034498
2024.51  0.039611   0.03404
2024.52  0.052050  0.039114
2025.01  0.025411  0.038806
2025.02  0.036901  0.039229
2025.03  0.035510  0.041998
2025.04  0.051092   0.03981
2025.05  0.038692  0.041384
2025.06  0.020813  0.045005
2025.07  0.041087  0.038952
2025.08  0.065741  0.036026
2025.09  0.033773  0.041576
2025.10  0.056267  0.048455
2025.11  0.045554  0.063275
2025.12  0.079776  0.058095
2025.13  0.099292  0.050934
2025.14  0.037189  0.054718
2025.15  0.054198  0.104478
2025.16  0.142716  0.083072
2025.17  0.180665  0.063312
2025.18  0.049677  0.062009</code></pre>
</div>
</div>
</section>
<section id="blotter-ledger" class="level3">
<h3 class="anchored" data-anchor-id="blotter-ledger">Blotter &amp; Ledger</h3>
<div id="c558ae0f" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trade periods from daily historical data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>trade_periods <span class="op">=</span> historical_data_daily[<span class="st">'trd_prd'</span>].unique()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calc blotter</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>blotter <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>trade_periods[<span class="dv">1</span>:], columns<span class="op">=</span>[<span class="st">'entry_timestamp'</span>, <span class="st">'qty'</span>, <span class="st">'exit_timestamp'</span>, <span class="st">'entry_price'</span>, <span class="st">'exit_price'</span>, <span class="st">'success'</span>, <span class="st">'iv'</span>, <span class="st">'wap'</span>, <span class="st">'sma'</span>])</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>blotter[:] <span class="op">=</span> <span class="va">None</span>  <span class="co"># Set empty values</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Ledger</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>filtered_historical <span class="op">=</span> historical_data_daily[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">!=</span> historical_data_daily[<span class="st">'trd_prd'</span>].iloc[<span class="dv">0</span>]]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>ledger <span class="op">=</span> pd.DataFrame()</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'date'</span>] <span class="op">=</span> filtered_historical[<span class="st">'timestamp'</span>]</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'position'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'cash'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'mark'</span>] <span class="op">=</span> historical_data_daily[<span class="st">'close'</span>][<span class="dv">1</span>:]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">#ledger['cash'] = 50000</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Ledger:"</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ledger)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Blotter &amp; Ledger Loop</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># This is where "backtesting" really occurs. We're calculating the blotter &amp;</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ledger that our trading system WOULD have produced.</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trd_prd <span class="kw">in</span> blotter.index:</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    entry_timestamp <span class="op">=</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'timestamp'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    entry_price <span class="op">=</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'open'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    prev_close <span class="op">=</span> historical_data_daily.loc[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">&lt;</span> trd_prd, <span class="st">'close'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    exp_vol <span class="op">=</span> vol_calcs.loc[trd_prd, <span class="st">'exp_vol'</span>]</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    iv <span class="op">=</span> iv_historical_data_daily.loc[iv_historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'wap'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    wap <span class="op">=</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'wap'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    sma <span class="op">=</span> historical_data_daily_SMA.loc[historical_data_daily_SMA[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'SMA_20'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> entry_price <span class="op">&gt;</span> prev_close:</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="op">-</span><span class="dv">100</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        exit_price_strategy <span class="op">=</span> entry_price <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> exp_vol)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>        exit_price_strategy <span class="op">=</span> entry_price <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> exp_vol)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    period_data <span class="op">=</span> historical_data_hourly[historical_data_hourly[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd]</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    max_high <span class="op">=</span> period_data[<span class="st">'high'</span>].<span class="bu">max</span>()</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    min_low <span class="op">=</span> period_data[<span class="st">'low'</span>].<span class="bu">min</span>()</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (qty <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> max_high <span class="op">&gt;=</span> exit_price_strategy) <span class="kw">or</span> (qty <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">and</span> min_low <span class="op">&lt;=</span> exit_price_strategy):</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> exit_price_strategy</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> qty <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>            exit_timestamp <span class="op">=</span> period_data.loc[period_data[<span class="st">'high'</span>] <span class="op">&gt;=</span> exit_price_strategy, <span class="st">'timestamp'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>            exit_high_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'high'</span>] <span class="op">&gt;=</span> exit_price_strategy, <span class="st">'high'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>            exit_low_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'high'</span>] <span class="op">&gt;=</span> exit_price_strategy, <span class="st">'low'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>            exit_timestamp <span class="op">=</span> period_data.loc[period_data[<span class="st">'low'</span>] <span class="op">&lt;=</span> exit_price_strategy, <span class="st">'timestamp'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>            exit_high_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'low'</span>] <span class="op">&lt;=</span> exit_price_strategy, <span class="st">'high'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>            exit_low_price <span class="op">=</span> period_data.loc[period_data[<span class="st">'low'</span>] <span class="op">&lt;=</span> exit_price_strategy, <span class="st">'low'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(exit_low_price, exit_high_price, exit_price_strategy, exit_timestamp, qty)</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> historical_data_daily.loc[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'close'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">#exit_timestamp = historical_data_daily.loc[historical_data_daily['trd_prd'] == trd_prd, 'timestamp'].iloc[-1]</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>        exit_timestamp <span class="op">=</span> pd.to_datetime(</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>        historical_data_daily.loc[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">==</span> trd_prd, <span class="st">'timestamp'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]).replace(hour<span class="op">=</span><span class="dv">15</span>, minute<span class="op">=</span><span class="dv">0</span>, second<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    blotter.loc[trd_prd] <span class="op">=</span> [entry_timestamp, qty, exit_timestamp, entry_price, exit_price, success, iv, wap, sma]</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'position'</span>] <span class="op">+=</span> qty</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'position'</span>] <span class="op">-=</span> qty</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'cash'</span>] <span class="op">-=</span> qty <span class="op">*</span> entry_price</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>    ledger.loc[ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'cash'</span>] <span class="op">+=</span> qty <span class="op">*</span> exit_price</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a><span class="co"># finally, calculate your strategy's end-of-day mark-to-market value</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> ledger[<span class="st">'position'</span>] <span class="op">*</span> ledger[<span class="st">'mark'</span>] <span class="op">+</span> ledger[<span class="st">'cash'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Ledger:
          date  position  cash    mark  mkt_value
8   2024-05-13       0.0   0.0  140.15        0.0
9   2024-05-14       0.0   0.0  144.93        0.0
10  2024-05-15       0.0   0.0  149.82        0.0
11  2024-05-16       0.0   0.0  146.66        0.0
12  2024-05-17       0.0   0.0  145.60        0.0
..         ...       ...   ...     ...        ...
245 2025-04-24       0.0   0.0  152.97        0.0
246 2025-04-25       0.0   0.0  153.88        0.0
247 2025-04-28       0.0   0.0  153.38        0.0
248 2025-04-29       0.0   0.0  152.79        0.0
249 2025-04-30       0.0   0.0  149.48        0.0

[242 rows x 5 columns]</code></pre>
</div>
</div>
</section>
<section id="extra" class="level3">
<h3 class="anchored" data-anchor-id="extra">Extra</h3>
<div id="3f266ff8" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> blotter[[<span class="st">'iv'</span>, <span class="st">'wap'</span>, <span class="st">'sma'</span>]]</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> blotter[<span class="st">'success'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Split train/test</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y.value_counts())</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> LogisticRegression()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># y_pred = model.predict(X_test) # 0.5 threshold</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> model.predict_proba(X_test)[:, <span class="dv">1</span>]</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> (probs <span class="op">&gt;</span> <span class="fl">0.3</span>).astype(<span class="bu">int</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>fill <span class="op">=</span> <span class="bu">len</span>(y_train)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>padded_y_pred <span class="op">=</span> np.concatenate(([<span class="fl">1.0</span>] <span class="op">*</span> fill, y_pred))</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'prediction'</span>] <span class="op">=</span> pd.Series(padded_y_pred, index<span class="op">=</span>blotter.index)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Results</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Coefficients:"</span>, model.coef_)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Intercept:"</span>, model.intercept_)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, y_pred))</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Blotter"</span>, blotter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>success
0    30
1    21
Name: count, dtype: int64
Coefficients: [[-0.04985929 -0.06708008  0.10414947]]
Intercept: [-6.44315096]
              precision    recall  f1-score   support

           0       0.40      0.29      0.33         7
           1       0.55      0.67      0.60         9

    accuracy                           0.50        16
   macro avg       0.47      0.48      0.47        16
weighted avg       0.48      0.50      0.48        16

Blotter              entry_timestamp   qty       exit_timestamp entry_price  \
2024.20  2024-05-13 09:30:00  -100  2024-05-17 15:00:00      142.86   
2024.21  2024-05-20 09:30:00   100  2024-05-24 15:00:00      145.14   
2024.22  2024-05-28 09:30:00  -100  2024-05-31 10:00:00      146.25   
2024.23  2024-06-03 09:30:00  -100  2024-06-03 13:00:00      141.46   
2024.24  2024-06-10 09:30:00   100  2024-06-10 10:00:00      132.44   
2024.25  2024-06-17 09:30:00  -100  2024-06-21 15:00:00      132.92   
2024.26  2024-06-24 09:30:00  -100  2024-06-28 15:00:00       132.1   
2024.27  2024-07-01 09:30:00  -100  2024-07-05 15:00:00      134.38   
2024.28  2024-07-08 09:30:00  -100  2024-07-12 15:00:00      138.44   
2024.29  2024-07-15 09:30:00  -100  2024-07-19 15:00:00      143.31   
2024.30  2024-07-22 09:30:00  -100  2024-07-26 15:00:00      148.47   
2024.31  2024-07-29 09:30:00  -100  2024-08-02 09:30:00      147.83   
2024.32  2024-08-05 09:30:00   100  2024-08-06 12:00:00       131.0   
2024.33  2024-08-12 09:30:00   100  2024-08-16 15:00:00      141.54   
2024.34  2024-08-19 09:30:00  -100  2024-08-23 15:00:00      145.48   
2024.35  2024-08-26 09:30:00  -100  2024-08-30 15:00:00       147.5   
2024.36  2024-09-03 09:30:00   100  2024-09-06 15:00:00       145.6   
2024.37  2024-09-09 09:30:00  -100  2024-09-13 15:00:00      138.93   
2024.38  2024-09-16 09:30:00   100  2024-09-17 11:00:00      146.66   
2024.39  2024-09-23 09:30:00  -100  2024-09-27 15:00:00      157.66   
2024.40  2024-09-30 09:30:00   100  2024-10-04 15:00:00       156.4   
2024.41  2024-10-07 09:30:00  -100  2024-10-08 13:00:00      160.43   
2024.42  2024-10-14 09:30:00  -100  2024-10-18 15:00:00       163.0   
2024.43  2024-10-21 09:30:00   100  2024-10-25 15:00:00      169.71   
2024.44  2024-10-28 09:30:00  -100  2024-11-01 09:30:00      170.68   
2024.45  2024-11-04 09:30:00   100  2024-11-06 09:30:00      160.25   
2024.46  2024-11-11 09:30:00  -100  2024-11-15 15:00:00      172.12   
2024.47  2024-11-18 09:30:00  -100  2024-11-22 15:00:00       167.5   
2024.48  2024-11-25 09:30:00  -100  2024-11-29 15:00:00       177.0   
2024.49  2024-12-02 09:30:00  -100  2024-12-06 15:00:00      177.08   
2024.50  2024-12-09 09:30:00  -100  2024-12-13 15:00:00       178.5   
2024.51  2024-12-16 09:30:00   100  2024-12-20 15:00:00      182.28   
2024.52  2024-12-23 09:30:00   100  2024-12-26 15:00:00       175.4   
2025.01  2024-12-30 09:30:00   100  2025-01-03 15:00:00      176.92   
2025.02  2025-01-06 09:30:00  -100  2025-01-07 09:30:00      183.28   
2025.03  2025-01-13 09:30:00   100  2025-01-14 14:00:00      172.77   
2025.04  2025-01-21 09:30:00  -100  2025-01-24 15:00:00      192.58   
2025.05  2025-01-27 09:30:00   100  2025-01-31 09:30:00      191.41   
2025.06  2025-02-03 09:30:00   100  2025-02-07 15:00:00      192.98   
2025.07  2025-02-10 09:30:00  -100  2025-02-11 10:00:00      191.37   
2025.08  2025-02-18 09:30:00  -100  2025-02-20 10:00:00      187.43   
2025.09  2025-02-24 09:30:00  -100  2025-02-25 09:30:00      174.33   
2025.10  2025-03-03 09:30:00  -100  2025-03-04 09:30:00      174.63   
2025.11  2025-03-10 09:30:00   100  2025-03-14 15:00:00      147.46   
2025.12  2025-03-17 09:30:00   100  2025-03-21 15:00:00       142.9   
2025.13  2025-03-24 09:30:00  -100  2025-03-28 13:00:00      151.04   
2025.14  2025-03-31 09:30:00   100  2025-04-01 15:00:00       142.0   
2025.15  2025-04-07 09:30:00   100  2025-04-07 10:00:00       114.0   
2025.16  2025-04-14 09:30:00  -100  2025-04-17 15:00:00      141.04   
2025.17  2025-04-21 09:30:00   100  2025-04-23 09:30:00       138.7   
2025.18  2025-04-28 09:30:00  -100  2025-04-30 15:00:00      153.94   

         exit_price success     iv      wap       sma  prediction  
2024.20       145.6   False  0.239  142.315   134.893         1.0  
2024.21      146.01   False   0.27  144.054    138.73         1.0  
2024.22  141.813789    True  0.236  146.963  141.1685         1.0  
2024.23  136.499553    True  0.305  140.544  142.7775         1.0  
2024.24  137.312728    True  0.279  133.523  141.8615         1.0  
2024.25      131.79   False  0.273  132.855   139.188         1.0  
2024.26      133.28   False  0.259  132.391  137.0715         1.0  
2024.27      138.26   False  0.269  133.994  135.0995         1.0  
2024.28      142.55   False  0.277  138.061  135.1435         1.0  
2024.29       147.3   False  0.288  143.272   136.461         1.0  
2024.30       147.1   False  0.307  148.779   139.913         1.0  
2024.31  141.626602    True  0.325  146.347  142.8715         1.0  
2024.32   137.10709    True  0.427  130.266  144.9165         1.0  
2024.33       145.0   False  0.302  140.063  144.3525         1.0  
2024.34       147.0   False  0.254  145.221    143.52         1.0  
2024.35       146.4   False  0.245  147.664   143.201         1.0  
2024.36      137.45   False  0.262  144.827  143.1595         1.0  
2024.37       147.4   False  0.288  138.973   143.555         1.0  
2024.38  152.069793    True  0.294  147.768  143.8485         1.0  
2024.39      156.91   False  0.275  157.828  146.3625         1.0  
2024.40      160.39   False  0.313  156.136  149.1195         1.0  
2024.41  153.540354    True  0.327  160.565  153.6645         1.0  
2024.42      169.89   False  0.334  162.486   157.288         1.0  
2024.43      169.47   False  0.316  169.816  160.2305         1.0  
2024.44  163.271264    True  0.322  170.973  163.3435         1.0  
2024.45  166.992571    True  0.314  160.338   165.157         1.0  
2024.46      167.21   False  0.262  172.436   167.773         1.0  
2024.47      175.52   False   0.28  166.622  168.1825         1.0  
2024.48      176.73   False  0.258  176.357  169.3005         1.0  
2024.49      178.07   False  0.274  177.055  171.0675         1.0  
2024.50      182.45   False  0.253   179.03  173.4205         1.0  
2024.51      176.04   False  0.274  182.707   176.515         1.0  
2024.52  182.260673    True  0.311   175.14  177.1885         1.0  
2025.01      181.11   False  0.297  176.707   177.985         1.0  
2025.02  176.090124    True  0.302  183.411  178.7025         1.0  
2025.03  180.026042    True  0.327  173.467  178.6665         1.0  
2025.04      197.32   False  0.303  193.224   180.725         1.0  
2025.05  199.331327    True  0.333  190.914  184.2165         1.0  
2025.06      190.34   False   0.38   193.07  188.3535         1.0  
2025.07  183.915844    True  0.295  189.543  191.3475         0.0  
2025.08  180.677669    True  0.313  188.405  191.7995         1.0  
2025.09  167.082125    True  0.367  173.292  188.1835         1.0  
2025.10  166.168308    True  0.386   173.25   181.726         1.0  
2025.11      144.36   False  0.518  146.115   172.227         0.0  
2025.12      147.71   False  0.437  143.898  161.7705         1.0  
2025.13  143.346966    True  0.367  151.504   153.937         1.0  
2025.14  149.769949    True   0.44  141.317  149.1705         0.0  
2025.15  125.910533    True  0.827  113.106  144.3575         0.0  
2025.16      141.24   False  0.621  138.996   142.201         0.0  
2025.17  147.481404    True   0.55  138.735   140.829         1.0  
2025.18      149.48   False   0.47  155.247   140.426         1.0  </code></pre>
</div>
</div>
</section>
</section>
<section id="outputting-interactive-blotter-ledger-final-hw-here" class="level1">
<h1>Outputting Interactive Blotter &amp; Ledger (FINAL HW HERE)</h1>
<div id="ada438a0" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your final blotter DataFrame already populated at this point</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>blotter <span class="op">=</span> blotter.<span class="bu">round</span>(<span class="dv">3</span>)  <span class="co"># Optional: round for cleaner display</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="584373a4" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display blotter as interactive table</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itables <span class="im">import</span> show</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>show(blotter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<table id="itables_96637758_24ab_453a_aee6_2ab491b69aea" class="display nowrap" data-quarto-disable-processing="true" style="table-layout:auto;width:auto;margin:auto;caption-side:bottom">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>entry_timestamp</th>
      <th>qty</th>
      <th>exit_timestamp</th>
      <th>entry_price</th>
      <th>exit_price</th>
      <th>success</th>
      <th>iv</th>
      <th>wap</th>
      <th>sma</th>
      <th>prediction</th>
    </tr>
  </thead><tbody><tr>
<td style="vertical-align:middle; text-align:left">
<a href="https://mwouts.github.io/itables/"><svg class="main-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="64" viewbox="0 0 500 400" style="font-family: 'Droid Sans', sans-serif;">
    <g style="fill:#d9d7fc">
        <path d="M100,400H500V357H100Z"></path>
        <path d="M100,300H400V257H100Z"></path>
        <path d="M0,200H400V157H0Z"></path>
        <path d="M100,100H500V57H100Z"></path>
        <path d="M100,350H500V307H100Z"></path>
        <path d="M100,250H400V207H100Z"></path>
        <path d="M0,150H400V107H0Z"></path>
        <path d="M100,50H500V7H100Z"></path>
    </g>
    <g style="fill:#1a1366;stroke:#1a1366;">
   <rect x="100" y="7" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="5s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="0" y="107" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="3.5s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="0;0;400" dur="3.5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="207" width="300" height="43">
    <animate attributename="width" values="0;300;0" dur="3s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="100;100;400" dur="3s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="307" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="4s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="4s" repeatcount="indefinite"></animate>
  </rect>
        <g style="fill:transparent;stroke-width:8; stroke-linejoin:round" rx="5">
            <g transform="translate(45 50) rotate(-45)">
                <circle r="33" cx="0" cy="0"></circle>
                <rect x="-8" y="32" width="16" height="30"></rect>
            </g>

            <g transform="translate(450 152)">
                <polyline points="-15,-20 -35,-20 -35,40 25,40 25,20"></polyline>
                <rect x="-15" y="-40" width="60" height="60"></rect>
            </g>

            <g transform="translate(50 352)">
                <polygon points="-35,-5 0,-40 35,-5"></polygon>
                <polygon points="-35,10 0,45 35,10"></polygon>
            </g>

            <g transform="translate(75 250)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>

            <g transform="translate(425 250) rotate(180)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>
        </g>
    </g>
</svg>
</a>
Loading ITables v2.3.0 from the internet...
(need <a href="https://mwouts.github.io/itables/troubleshooting.html">help</a>?)</td>
</tr></tbody>
</table>
<link href="https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.css" rel="stylesheet">
<script type="module">
    import {DataTable, jQuery as $} from 'https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.js';

    document.querySelectorAll("#itables_96637758_24ab_453a_aee6_2ab491b69aea:not(.dataTable)").forEach(table => {
        if (!(table instanceof HTMLTableElement))
            return;

        // Define the table data
        const data = [[2024.2, "2024-05-13 09:30:00", "-100", "2024-05-17 15:00:00", " 142.86", " 145.6", "False", " 0.239", " 142.315", " 134.893", 1.0], [2024.21, "2024-05-20 09:30:00", "100", "2024-05-24 15:00:00", " 145.14", " 146.01", "False", " 0.27", " 144.054", " 138.73", 1.0], [2024.22, "2024-05-28 09:30:00", "-100", "2024-05-31 10:00:00", " 146.25", " 141.813789", "True", " 0.236", " 146.963", " 141.1685", 1.0], [2024.23, "2024-06-03 09:30:00", "-100", "2024-06-03 13:00:00", " 141.46", " 136.499553", "True", " 0.305", " 140.544", " 142.7775", 1.0], [2024.24, "2024-06-10 09:30:00", "100", "2024-06-10 10:00:00", " 132.44", " 137.312728", "True", " 0.279", " 133.523", " 141.8615", 1.0], [2024.25, "2024-06-17 09:30:00", "-100", "2024-06-21 15:00:00", " 132.92", " 131.79", "False", " 0.273", " 132.855", " 139.188", 1.0], [2024.26, "2024-06-24 09:30:00", "-100", "2024-06-28 15:00:00", " 132.1", " 133.28", "False", " 0.259", " 132.391", " 137.0715", 1.0], [2024.27, "2024-07-01 09:30:00", "-100", "2024-07-05 15:00:00", " 134.38", " 138.26", "False", " 0.269", " 133.994", " 135.0995", 1.0], [2024.28, "2024-07-08 09:30:00", "-100", "2024-07-12 15:00:00", " 138.44", " 142.55", "False", " 0.277", " 138.061", " 135.1435", 1.0], [2024.29, "2024-07-15 09:30:00", "-100", "2024-07-19 15:00:00", " 143.31", " 147.3", "False", " 0.288", " 143.272", " 136.461", 1.0], [2024.3, "2024-07-22 09:30:00", "-100", "2024-07-26 15:00:00", " 148.47", " 147.1", "False", " 0.307", " 148.779", " 139.913", 1.0], [2024.31, "2024-07-29 09:30:00", "-100", "2024-08-02 09:30:00", " 147.83", " 141.626602", "True", " 0.325", " 146.347", " 142.8715", 1.0], [2024.32, "2024-08-05 09:30:00", "100", "2024-08-06 12:00:00", " 131.0", " 137.10709", "True", " 0.427", " 130.266", " 144.9165", 1.0], [2024.33, "2024-08-12 09:30:00", "100", "2024-08-16 15:00:00", " 141.54", " 145.0", "False", " 0.302", " 140.063", " 144.3525", 1.0], [2024.34, "2024-08-19 09:30:00", "-100", "2024-08-23 15:00:00", " 145.48", " 147.0", "False", " 0.254", " 145.221", " 143.52", 1.0], [2024.35, "2024-08-26 09:30:00", "-100", "2024-08-30 15:00:00", " 147.5", " 146.4", "False", " 0.245", " 147.664", " 143.201", 1.0], [2024.36, "2024-09-03 09:30:00", "100", "2024-09-06 15:00:00", " 145.6", " 137.45", "False", " 0.262", " 144.827", " 143.1595", 1.0], [2024.37, "2024-09-09 09:30:00", "-100", "2024-09-13 15:00:00", " 138.93", " 147.4", "False", " 0.288", " 138.973", " 143.555", 1.0], [2024.38, "2024-09-16 09:30:00", "100", "2024-09-17 11:00:00", " 146.66", " 152.069793", "True", " 0.294", " 147.768", " 143.8485", 1.0], [2024.39, "2024-09-23 09:30:00", "-100", "2024-09-27 15:00:00", " 157.66", " 156.91", "False", " 0.275", " 157.828", " 146.3625", 1.0], [2024.4, "2024-09-30 09:30:00", "100", "2024-10-04 15:00:00", " 156.4", " 160.39", "False", " 0.313", " 156.136", " 149.1195", 1.0], [2024.41, "2024-10-07 09:30:00", "-100", "2024-10-08 13:00:00", " 160.43", " 153.540354", "True", " 0.327", " 160.565", " 153.6645", 1.0], [2024.42, "2024-10-14 09:30:00", "-100", "2024-10-18 15:00:00", " 163.0", " 169.89", "False", " 0.334", " 162.486", " 157.288", 1.0], [2024.43, "2024-10-21 09:30:00", "100", "2024-10-25 15:00:00", " 169.71", " 169.47", "False", " 0.316", " 169.816", " 160.2305", 1.0], [2024.44, "2024-10-28 09:30:00", "-100", "2024-11-01 09:30:00", " 170.68", " 163.271264", "True", " 0.322", " 170.973", " 163.3435", 1.0], [2024.45, "2024-11-04 09:30:00", "100", "2024-11-06 09:30:00", " 160.25", " 166.992571", "True", " 0.314", " 160.338", " 165.157", 1.0], [2024.46, "2024-11-11 09:30:00", "-100", "2024-11-15 15:00:00", " 172.12", " 167.21", "False", " 0.262", " 172.436", " 167.773", 1.0], [2024.47, "2024-11-18 09:30:00", "-100", "2024-11-22 15:00:00", " 167.5", " 175.52", "False", " 0.28", " 166.622", " 168.1825", 1.0], [2024.48, "2024-11-25 09:30:00", "-100", "2024-11-29 15:00:00", " 177.0", " 176.73", "False", " 0.258", " 176.357", " 169.3005", 1.0], [2024.49, "2024-12-02 09:30:00", "-100", "2024-12-06 15:00:00", " 177.08", " 178.07", "False", " 0.274", " 177.055", " 171.0675", 1.0], [2024.5, "2024-12-09 09:30:00", "-100", "2024-12-13 15:00:00", " 178.5", " 182.45", "False", " 0.253", " 179.03", " 173.4205", 1.0], [2024.51, "2024-12-16 09:30:00", "100", "2024-12-20 15:00:00", " 182.28", " 176.04", "False", " 0.274", " 182.707", " 176.515", 1.0], [2024.52, "2024-12-23 09:30:00", "100", "2024-12-26 15:00:00", " 175.4", " 182.260673", "True", " 0.311", " 175.14", " 177.1885", 1.0], [2025.01, "2024-12-30 09:30:00", "100", "2025-01-03 15:00:00", " 176.92", " 181.11", "False", " 0.297", " 176.707", " 177.985", 1.0], [2025.02, "2025-01-06 09:30:00", "-100", "2025-01-07 09:30:00", " 183.28", " 176.090124", "True", " 0.302", " 183.411", " 178.7025", 1.0], [2025.03, "2025-01-13 09:30:00", "100", "2025-01-14 14:00:00", " 172.77", " 180.026042", "True", " 0.327", " 173.467", " 178.6665", 1.0], [2025.04, "2025-01-21 09:30:00", "-100", "2025-01-24 15:00:00", " 192.58", " 197.32", "False", " 0.303", " 193.224", " 180.725", 1.0], [2025.05, "2025-01-27 09:30:00", "100", "2025-01-31 09:30:00", " 191.41", " 199.331327", "True", " 0.333", " 190.914", " 184.2165", 1.0], [2025.06, "2025-02-03 09:30:00", "100", "2025-02-07 15:00:00", " 192.98", " 190.34", "False", " 0.38", " 193.07", " 188.3535", 1.0], [2025.07, "2025-02-10 09:30:00", "-100", "2025-02-11 10:00:00", " 191.37", " 183.915844", "True", " 0.295", " 189.543", " 191.3475", 0.0], [2025.08, "2025-02-18 09:30:00", "-100", "2025-02-20 10:00:00", " 187.43", " 180.677669", "True", " 0.313", " 188.405", " 191.7995", 1.0], [2025.09, "2025-02-24 09:30:00", "-100", "2025-02-25 09:30:00", " 174.33", " 167.082125", "True", " 0.367", " 173.292", " 188.1835", 1.0], [2025.1, "2025-03-03 09:30:00", "-100", "2025-03-04 09:30:00", " 174.63", " 166.168308", "True", " 0.386", " 173.25", " 181.726", 1.0], [2025.11, "2025-03-10 09:30:00", "100", "2025-03-14 15:00:00", " 147.46", " 144.36", "False", " 0.518", " 146.115", " 172.227", 0.0], [2025.12, "2025-03-17 09:30:00", "100", "2025-03-21 15:00:00", " 142.9", " 147.71", "False", " 0.437", " 143.898", " 161.7705", 1.0], [2025.13, "2025-03-24 09:30:00", "-100", "2025-03-28 13:00:00", " 151.04", " 143.346966", "True", " 0.367", " 151.504", " 153.937", 1.0], [2025.14, "2025-03-31 09:30:00", "100", "2025-04-01 15:00:00", " 142.0", " 149.769949", "True", " 0.44", " 141.317", " 149.1705", 0.0], [2025.15, "2025-04-07 09:30:00", "100", "2025-04-07 10:00:00", " 114.0", " 125.910533", "True", " 0.827", " 113.106", " 144.3575", 0.0], [2025.16, "2025-04-14 09:30:00", "-100", "2025-04-17 15:00:00", " 141.04", " 141.24", "False", " 0.621", " 138.996", " 142.201", 0.0], [2025.17, "2025-04-21 09:30:00", "100", "2025-04-23 09:30:00", " 138.7", " 147.481404", "True", " 0.55", " 138.735", " 140.829", 1.0], [2025.18, "2025-04-28 09:30:00", "-100", "2025-04-30 15:00:00", " 153.94", " 149.48", "False", " 0.47", " 155.247", " 140.426", 1.0]];

        // Define the dt_args
        let dt_args = {"layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "order": [], "warn_on_selected_rows_not_rendered": true};
        dt_args["data"] = data;

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<div id="84bd0fa5" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your final ledger DataFrame already populated at this point</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ledger <span class="op">=</span> ledger.<span class="bu">round</span>(<span class="dv">2</span>)  <span class="co"># Optional: clean output</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="28a6814f" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display ledger as interactive table</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>show(ledger)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<table id="itables_f56f4c71_9dd8_4202_ba58_0ab217ec92c1" class="display nowrap" data-quarto-disable-processing="true" style="table-layout:auto;width:auto;margin:auto;caption-side:bottom">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>position</th>
      <th>cash</th>
      <th>mark</th>
      <th>mkt_value</th>
    </tr>
  </thead><tbody><tr>
<td style="vertical-align:middle; text-align:left">
<a href="https://mwouts.github.io/itables/"><svg class="main-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="64" viewbox="0 0 500 400" style="font-family: 'Droid Sans', sans-serif;">
    <g style="fill:#d9d7fc">
        <path d="M100,400H500V357H100Z"></path>
        <path d="M100,300H400V257H100Z"></path>
        <path d="M0,200H400V157H0Z"></path>
        <path d="M100,100H500V57H100Z"></path>
        <path d="M100,350H500V307H100Z"></path>
        <path d="M100,250H400V207H100Z"></path>
        <path d="M0,150H400V107H0Z"></path>
        <path d="M100,50H500V7H100Z"></path>
    </g>
    <g style="fill:#1a1366;stroke:#1a1366;">
   <rect x="100" y="7" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="5s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="0" y="107" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="3.5s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="0;0;400" dur="3.5s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="207" width="300" height="43">
    <animate attributename="width" values="0;300;0" dur="3s" repeatcount="indefinite"></animate>
    <animate attributename="x" values="100;100;400" dur="3s" repeatcount="indefinite"></animate>
  </rect>
        <rect x="100" y="307" width="400" height="43">
    <animate attributename="width" values="0;400;0" dur="4s" repeatcount="indefinite"></animate>
      <animate attributename="x" values="100;100;500" dur="4s" repeatcount="indefinite"></animate>
  </rect>
        <g style="fill:transparent;stroke-width:8; stroke-linejoin:round" rx="5">
            <g transform="translate(45 50) rotate(-45)">
                <circle r="33" cx="0" cy="0"></circle>
                <rect x="-8" y="32" width="16" height="30"></rect>
            </g>

            <g transform="translate(450 152)">
                <polyline points="-15,-20 -35,-20 -35,40 25,40 25,20"></polyline>
                <rect x="-15" y="-40" width="60" height="60"></rect>
            </g>

            <g transform="translate(50 352)">
                <polygon points="-35,-5 0,-40 35,-5"></polygon>
                <polygon points="-35,10 0,45 35,10"></polygon>
            </g>

            <g transform="translate(75 250)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>

            <g transform="translate(425 250) rotate(180)">
                <polyline points="-30,30 -60,0 -30,-30"></polyline>
                <polyline points="0,30 -30,0 0,-30"></polyline>
            </g>
        </g>
    </g>
</svg>
</a>
Loading ITables v2.3.0 from the internet...
(need <a href="https://mwouts.github.io/itables/troubleshooting.html">help</a>?)</td>
</tr></tbody>
</table>
<link href="https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.css" rel="stylesheet">
<script type="module">
    import {DataTable, jQuery as $} from 'https://www.unpkg.com/dt_for_itables@2.2.0/dt_bundle.js';

    document.querySelectorAll("#itables_f56f4c71_9dd8_4202_ba58_0ab217ec92c1:not(.dataTable)").forEach(table => {
        if (!(table instanceof HTMLTableElement))
            return;

        // Define the table data
        const data = [[8, "2024-05-13", 0.0, 0.0, 140.15, 0.0], [9, "2024-05-14", -100.0, 14286.0, 144.93, -207.0], [10, "2024-05-15", -100.0, 14286.0, 149.82, -696.0], [11, "2024-05-16", -100.0, 14286.0, 146.66, -380.0], [12, "2024-05-17", -100.0, 14286.0, 145.6, -274.0], [13, "2024-05-20", 0.0, -274.0, 144.56, -274.0], [14, "2024-05-21", 100.0, -14788.0, 143.62, -426.0], [15, "2024-05-22", 100.0, -14788.0, 144.75, -313.0], [16, "2024-05-23", 100.0, -14788.0, 144.75, -313.0], [17, "2024-05-24", 100.0, -14788.0, 146.01, -187.0], [18, "2024-05-28", 0.0, -187.0, 144.34, -187.0], [19, "2024-05-29", -100.0, 14438.0, 142.17, 221.0], [20, "2024-05-30", -100.0, 14438.0, 142.98, 140.0], [21, "2024-05-31", -100.0, 14438.0, 140.17, 421.0], [22, "2024-06-03", 0.0, 256.62, 138.2, 256.62], [23, "2024-06-04", 0.0, 752.67, 135.19, 752.67], [24, "2024-06-05", 0.0, 752.67, 139.56, 752.67], [25, "2024-06-06", 0.0, 752.67, 134.0, 752.67], [26, "2024-06-07", 0.0, 752.67, 132.93, 752.67], [27, "2024-06-10", 0.0, 752.67, 136.84, 752.67], [28, "2024-06-11", 0.0, 1239.94, 135.78, 1239.94], [29, "2024-06-12", 0.0, 1239.94, 137.49, 1239.94], [30, "2024-06-13", 0.0, 1239.94, 133.76, 1239.94], [31, "2024-06-14", 0.0, 1239.94, 132.63, 1239.94], [32, "2024-06-17", 0.0, 1239.94, 134.03, 1239.94], [33, "2024-06-18", -100.0, 14531.94, 135.0, 1031.94], [34, "2024-06-20", -100.0, 14531.94, 134.71, 1060.94], [35, "2024-06-21", -100.0, 14531.94, 131.79, 1352.94], [36, "2024-06-24", 0.0, 1352.94, 133.85, 1352.94], [37, "2024-06-25", -100.0, 14562.94, 135.35, 1027.94], [38, "2024-06-26", -100.0, 14562.94, 135.45, 1017.94], [39, "2024-06-27", -100.0, 14562.94, 135.95, 967.94], [40, "2024-06-28", -100.0, 14562.94, 133.28, 1234.94], [41, "2024-07-01", 0.0, 1234.94, 136.2, 1234.94], [42, "2024-07-02", -100.0, 14672.94, 135.45, 1127.94], [43, "2024-07-03", -100.0, 14672.94, 138.35, 837.94], [44, "2024-07-05", -100.0, 14672.94, 138.26, 846.94], [45, "2024-07-08", 0.0, 846.94, 135.77, 846.94], [46, "2024-07-09", -100.0, 14690.94, 134.78, 1212.94], [47, "2024-07-10", -100.0, 14690.94, 138.74, 816.94], [48, "2024-07-11", -100.0, 14690.94, 141.1, 580.94], [49, "2024-07-12", -100.0, 14690.94, 142.55, 435.94], [50, "2024-07-15", 0.0, 435.94, 145.98, 435.94], [51, "2024-07-16", -100.0, 14766.94, 148.0, -33.06], [52, "2024-07-17", -100.0, 14766.94, 143.72, 394.94], [53, "2024-07-18", -100.0, 14766.94, 147.39, 27.94], [54, "2024-07-19", -100.0, 14766.94, 147.3, 36.94], [55, "2024-07-22", 0.0, 36.94, 150.79, 36.94], [56, "2024-07-23", -100.0, 14883.94, 150.79, -195.06], [57, "2024-07-24", -100.0, 14883.94, 144.51, 432.94], [58, "2024-07-25", -100.0, 14883.94, 145.3, 353.94], [59, "2024-07-26", -100.0, 14883.94, 147.1, 173.94], [60, "2024-07-29", 0.0, 173.94, 145.35, 173.94], [61, "2024-07-30", -100.0, 14956.94, 149.58, -1.06], [62, "2024-07-31", -100.0, 14956.94, 153.2, -363.06], [63, "2024-08-01", -100.0, 14956.94, 149.16, 40.94], [64, "2024-08-02", -100.0, 14956.94, 139.26, 1030.94], [65, "2024-08-05", 0.0, 794.28, 133.73, 794.28], [66, "2024-08-06", 100.0, -12305.72, 135.75, 1269.28], [67, "2024-08-07", 0.0, 1404.99, 135.28, 1404.99], [68, "2024-08-08", 0.0, 1404.99, 138.96, 1404.99], [69, "2024-08-09", 0.0, 1404.99, 141.54, 1404.99], [70, "2024-08-12", 0.0, 1404.99, 140.34, 1404.99], [71, "2024-08-13", 100.0, -12749.01, 141.54, 1404.99], [72, "2024-08-14", 100.0, -12749.01, 143.83, 1633.99], [73, "2024-08-15", 100.0, -12749.01, 145.6, 1810.99], [74, "2024-08-16", 100.0, -12749.01, 145.0, 1750.99], [75, "2024-08-19", 0.0, 1750.99, 144.58, 1750.99], [76, "2024-08-20", -100.0, 16298.99, 144.71, 1827.99], [77, "2024-08-21", -100.0, 16298.99, 144.5, 1848.99], [78, "2024-08-22", -100.0, 16298.99, 143.5, 1948.99], [79, "2024-08-23", -100.0, 16298.99, 147.0, 1598.99], [80, "2024-08-26", 0.0, 1598.99, 146.96, 1598.99], [81, "2024-08-27", -100.0, 16348.99, 146.14, 1734.99], [82, "2024-08-28", -100.0, 16348.99, 145.19, 1829.99], [83, "2024-08-29", -100.0, 16348.99, 144.35, 1913.99], [84, "2024-08-30", -100.0, 16348.99, 146.4, 1708.99], [85, "2024-09-03", 0.0, 1708.99, 142.02, 1708.99], [86, "2024-09-04", 100.0, -12851.01, 140.86, 1234.99], [87, "2024-09-05", 100.0, -12851.01, 141.05, 1253.99], [88, "2024-09-06", 100.0, -12851.01, 137.45, 893.99], [89, "2024-09-09", 0.0, 893.99, 140.08, 893.99], [90, "2024-09-10", -100.0, 14786.99, 140.09, 777.99], [91, "2024-09-11", -100.0, 14786.99, 141.46, 640.99], [92, "2024-09-12", -100.0, 14786.99, 143.84, 402.99], [93, "2024-09-13", -100.0, 14786.99, 147.4, 46.99], [94, "2024-09-16", 0.0, 46.99, 149.39, 46.99], [95, "2024-09-17", 100.0, -14619.01, 152.8, 660.99], [96, "2024-09-18", 0.0, 587.97, 152.35, 587.97], [97, "2024-09-19", 0.0, 587.97, 156.51, 587.97], [98, "2024-09-20", 0.0, 587.97, 156.66, 587.97], [99, "2024-09-23", 0.0, 587.97, 156.25, 587.97], [100, "2024-09-24", -100.0, 16353.97, 157.33, 620.97], [101, "2024-09-25", -100.0, 16353.97, 158.05, 548.97], [102, "2024-09-26", -100.0, 16353.97, 156.05, 748.97], [103, "2024-09-27", -100.0, 16353.97, 156.91, 662.97], [104, "2024-09-30", 0.0, 662.97, 155.84, 662.97], [105, "2024-10-01", 100.0, -14977.03, 156.31, 653.97], [106, "2024-10-02", 100.0, -14977.03, 158.05, 827.97], [107, "2024-10-03", 100.0, -14977.03, 157.05, 727.97], [108, "2024-10-04", 100.0, -14977.03, 160.39, 1061.97], [109, "2024-10-07", 0.0, 1061.97, 160.56, 1061.97], [110, "2024-10-08", -100.0, 17104.97, 153.38, 1766.97], [111, "2024-10-09", 0.0, 1750.93, 158.16, 1750.93], [112, "2024-10-10", 0.0, 1750.93, 157.81, 1750.93], [113, "2024-10-11", 0.0, 1750.93, 161.95, 1750.93], [114, "2024-10-14", 0.0, 1750.93, 163.35, 1750.93], [115, "2024-10-15", -100.0, 18050.93, 162.63, 1787.93], [116, "2024-10-16", -100.0, 18050.93, 163.48, 1702.93], [117, "2024-10-17", -100.0, 18050.93, 168.73, 1177.93], [118, "2024-10-18", -100.0, 18050.93, 169.89, 1061.93], [119, "2024-10-21", 0.0, 1061.93, 168.69, 1061.93], [120, "2024-10-22", 100.0, -15909.07, 167.78, 868.93], [121, "2024-10-23", 100.0, -15909.07, 167.38, 828.93], [122, "2024-10-24", 100.0, -15909.07, 170.83, 1173.93], [123, "2024-10-25", 100.0, -15909.07, 169.47, 1037.93], [124, "2024-10-28", 0.0, 1037.93, 170.98, 1037.93], [125, "2024-10-29", -100.0, 18105.93, 170.4, 1065.93], [126, "2024-10-30", -100.0, 18105.93, 169.0, 1205.93], [127, "2024-10-31", -100.0, 18105.93, 167.68, 1337.93], [128, "2024-11-01", -100.0, 18105.93, 161.87, 1918.93], [129, "2024-11-04", 0.0, 1778.8, 159.68, 1778.8], [130, "2024-11-05", 100.0, -14246.2, 164.44, 2197.8], [131, "2024-11-06", 100.0, -14246.2, 172.5, 3003.8], [132, "2024-11-07", 0.0, 2453.06, 168.27, 2453.06], [133, "2024-11-08", 0.0, 2453.06, 170.38, 2453.06], [134, "2024-11-11", 0.0, 2453.06, 171.38, 2453.06], [135, "2024-11-12", -100.0, 19665.06, 170.5, 2615.06], [136, "2024-11-13", -100.0, 19665.06, 167.45, 2920.06], [137, "2024-11-14", -100.0, 19665.06, 169.02, 2763.06], [138, "2024-11-15", -100.0, 19665.06, 167.21, 2944.06], [139, "2024-11-18", 0.0, 2944.06, 167.43, 2944.06], [140, "2024-11-19", -100.0, 19694.06, 170.35, 2659.06], [141, "2024-11-20", -100.0, 19694.06, 171.89, 2505.06], [142, "2024-11-21", -100.0, 19694.06, 175.01, 2193.06], [143, "2024-11-22", -100.0, 19694.06, 175.52, 2142.06], [144, "2024-11-25", 0.0, 2142.06, 176.03, 2142.06], [145, "2024-11-26", -100.0, 19842.06, 178.83, 1959.06], [146, "2024-11-27", -100.0, 19842.06, 174.78, 2364.06], [147, "2024-11-29", -100.0, 19842.06, 176.73, 2169.06], [148, "2024-12-02", 0.0, 2169.06, 173.95, 2169.06], [149, "2024-12-03", -100.0, 19877.06, 175.05, 2372.06], [150, "2024-12-04", -100.0, 19877.06, 176.85, 2192.06], [151, "2024-12-05", -100.0, 19877.06, 177.07, 2170.06], [152, "2024-12-06", -100.0, 19877.06, 178.07, 2070.06], [153, "2024-12-09", 0.0, 2070.06, 175.29, 2070.06], [154, "2024-12-10", -100.0, 19920.06, 176.11, 2309.06], [155, "2024-12-11", -100.0, 19920.06, 182.45, 1675.06], [156, "2024-12-12", -100.0, 19920.06, 182.74, 1646.06], [157, "2024-12-13", -100.0, 19920.06, 182.45, 1675.06], [158, "2024-12-16", 0.0, 1675.06, 183.7, 1675.06], [159, "2024-12-17", 100.0, -16552.94, 178.33, 1280.06], [160, "2024-12-18", 100.0, -16552.94, 169.22, 369.06], [161, "2024-12-19", 100.0, -16552.94, 171.08, 555.06], [162, "2024-12-20", 100.0, -16552.94, 176.04, 1051.06], [163, "2024-12-23", 0.0, 1051.06, 179.0, 1051.06], [164, "2024-12-24", 100.0, -16488.94, 181.06, 1617.06], [165, "2024-12-26", 100.0, -16488.94, 182.72, 1783.06], [166, "2024-12-27", 0.0, 1737.13, 179.5, 1737.13], [167, "2024-12-30", 0.0, 1737.13, 179.02, 1737.13], [168, "2024-12-31", 100.0, -15954.87, 177.03, 1748.13], [169, "2025-01-02", 100.0, -15954.87, 178.83, 1928.13], [170, "2025-01-03", 100.0, -15954.87, 181.11, 2156.13], [171, "2025-01-06", 0.0, 2156.13, 180.3, 2156.13], [172, "2025-01-07", -100.0, 20484.13, 178.37, 2647.13], [173, "2025-01-08", 0.0, 2875.12, 182.3, 2875.12], [174, "2025-01-10", 0.0, 2875.12, 175.04, 2875.12], [175, "2025-01-13", 0.0, 2875.12, 175.49, 2875.12], [176, "2025-01-14", 100.0, -14401.88, 179.17, 3515.12], [177, "2025-01-15", 0.0, 3600.72, 184.5, 3600.72], [178, "2025-01-16", 0.0, 3600.72, 187.9, 3600.72], [179, "2025-01-17", 0.0, 3600.72, 191.32, 3600.72], [180, "2025-01-21", 0.0, 3600.72, 194.72, 3600.72], [181, "2025-01-22", -100.0, 22858.72, 193.81, 3477.72], [182, "2025-01-23", -100.0, 22858.72, 195.9, 3268.72], [183, "2025-01-24", -100.0, 22858.72, 197.32, 3126.72], [184, "2025-01-27", 0.0, 3126.72, 189.98, 3126.72], [185, "2025-01-28", 100.0, -16014.28, 193.6, 3345.72], [186, "2025-01-29", 100.0, -16014.28, 193.42, 3327.72], [187, "2025-01-30", 100.0, -16014.28, 198.08, 3793.72], [188, "2025-01-31", 100.0, -16014.28, 198.22, 3807.72], [189, "2025-02-03", 0.0, 3918.85, 196.52, 3918.85], [190, "2025-02-04", 100.0, -15379.15, 195.36, 4156.85], [191, "2025-02-05", 100.0, -15379.15, 189.65, 3585.85], [192, "2025-02-06", 100.0, -15379.15, 191.67, 3787.85], [193, "2025-02-07", 100.0, -15379.15, 190.34, 3654.85], [194, "2025-02-10", 0.0, 3654.85, 189.98, 3654.85], [195, "2025-02-11", -100.0, 22791.85, 186.37, 4154.85], [196, "2025-02-12", 0.0, 4400.27, 182.81, 4400.27], [197, "2025-02-13", 0.0, 4400.27, 184.39, 4400.27], [198, "2025-02-14", 0.0, 4400.27, 186.18, 4400.27], [199, "2025-02-18", 0.0, 4400.27, 187.67, 4400.27], [200, "2025-02-19", -100.0, 23143.27, 186.74, 4469.27], [201, "2025-02-20", -100.0, 23143.27, 179.69, 5174.27], [202, "2025-02-21", 0.0, 5075.5, 174.09, 5075.5], [203, "2025-02-24", 0.0, 5075.5, 168.91, 5075.5], [204, "2025-02-25", -100.0, 22508.5, 167.36, 5772.5], [205, "2025-02-26", 0.0, 5800.29, 168.97, 5800.29], [206, "2025-02-27", 0.0, 5800.29, 167.12, 5800.29], [207, "2025-02-28", 0.0, 5800.29, 170.94, 5800.29], [208, "2025-03-03", 0.0, 5800.29, 169.76, 5800.29], [209, "2025-03-04", -100.0, 23263.29, 160.99, 7164.29], [210, "2025-03-05", 0.0, 6646.46, 163.0, 6646.46], [211, "2025-03-06", 0.0, 6646.46, 153.37, 6646.46], [212, "2025-03-07", 0.0, 6646.46, 154.96, 6646.46], [213, "2025-03-10", 0.0, 6646.46, 141.24, 6646.46], [214, "2025-03-11", 100.0, -8099.54, 143.01, 6201.46], [215, "2025-03-12", 100.0, -8099.54, 145.93, 6493.46], [216, "2025-03-13", 100.0, -8099.54, 140.19, 5919.46], [217, "2025-03-14", 100.0, -8099.54, 144.36, 6336.46], [218, "2025-03-17", 0.0, 6336.46, 147.11, 6336.46], [219, "2025-03-18", 100.0, -7953.54, 144.02, 6448.46], [220, "2025-03-19", 100.0, -7953.54, 147.61, 6807.46], [221, "2025-03-20", 100.0, -7953.54, 147.34, 6780.46], [222, "2025-03-21", 100.0, -7953.54, 147.71, 6817.46], [223, "2025-03-24", 0.0, 6817.46, 153.75, 6817.46], [224, "2025-03-25", -100.0, 21921.46, 155.63, 6358.46], [225, "2025-03-26", -100.0, 21921.46, 153.28, 6593.46], [226, "2025-03-27", -100.0, 21921.46, 148.4, 7081.46], [227, "2025-03-28", -100.0, 21921.46, 144.9, 7431.46], [228, "2025-03-31", 0.0, 7586.76, 146.61, 7586.76], [229, "2025-04-01", 100.0, -6613.24, 149.44, 8330.76], [230, "2025-04-02", 0.0, 8363.76, 154.5, 8363.76], [231, "2025-04-03", 0.0, 8363.76, 130.59, 8363.76], [232, "2025-04-04", 0.0, 8363.76, 118.04, 8363.76], [233, "2025-04-07", 0.0, 8363.76, 124.73, 8363.76], [234, "2025-04-08", 0.0, 9554.81, 123.21, 9554.81], [235, "2025-04-09", 0.0, 9554.81, 142.37, 9554.81], [236, "2025-04-10", 0.0, 9554.81, 135.77, 9554.81], [237, "2025-04-11", 0.0, 9554.81, 137.74, 9554.81], [238, "2025-04-14", 0.0, 9554.81, 138.38, 9554.81], [239, "2025-04-15", -100.0, 23658.81, 141.32, 9526.81], [240, "2025-04-16", -100.0, 23658.81, 139.6, 9698.81], [241, "2025-04-17", -100.0, 23658.81, 141.24, 9534.81], [242, "2025-04-21", 0.0, 9534.81, 137.08, 9534.81], [243, "2025-04-22", 100.0, -4335.19, 141.72, 9836.81], [244, "2025-04-23", 100.0, -4335.19, 145.95, 10259.81], [245, "2025-04-24", 0.0, 10412.95, 152.97, 10412.95], [246, "2025-04-25", 0.0, 10412.95, 153.88, 10412.95], [247, "2025-04-28", 0.0, 10412.95, 153.38, 10412.95], [248, "2025-04-29", -100.0, 25806.95, 152.79, 10527.95], [249, "2025-04-30", -100.0, 25806.95, 149.48, 10858.95]];

        // Define the dt_args
        let dt_args = {"layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "order": [], "warn_on_selected_rows_not_rendered": true};
        dt_args["data"] = data;

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<section id="navcharts-extra-not-necessary" class="level3">
<h3 class="anchored" data-anchor-id="navcharts-extra-not-necessary">NAV/Charts &amp; Extra (not necessary)</h3>
<div id="95a6db50" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list to store categories</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>position_category <span class="op">=</span> []</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Categorize positions manually</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pos <span class="kw">in</span> ledger[<span class="st">'position'</span>]:</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Long'</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> pos <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Short'</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Cash Only'</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Add category column to ledger</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>ledger[<span class="st">'position_category'</span>] <span class="op">=</span> position_category</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for each category</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> {<span class="st">'Long'</span>: <span class="st">'green'</span>, <span class="st">'Short'</span>: <span class="st">'red'</span>, <span class="st">'Cash Only'</span>: <span class="st">'blue'</span>}</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> []</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign colors manually</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat <span class="kw">in</span> ledger[<span class="st">'position_category'</span>]:</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    colors.append(color_map[cat])</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot NAV over time</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>plt.scatter(ledger[<span class="st">'date'</span>], ledger[<span class="st">'mkt_value'</span>], c<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Net Asset Value (NAV)'</span>)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'NAV Over Time with Position Coloring, Standard Model'</span>)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually add legend</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat, color <span class="kw">in</span> color_map.items():</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    plt.scatter([], [], color<span class="op">=</span>color, label<span class="op">=</span>cat)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Ledger</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>filtered_historical <span class="op">=</span> historical_data_daily[historical_data_daily[<span class="st">'trd_prd'</span>] <span class="op">!=</span> historical_data_daily[<span class="st">'trd_prd'</span>].iloc[<span class="dv">0</span>]]</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>new_ledger <span class="op">=</span> pd.DataFrame()</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'date'</span>] <span class="op">=</span> filtered_historical[<span class="st">'timestamp'</span>]</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'position'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'cash'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'mark'</span>] <span class="op">=</span> historical_data_daily[<span class="st">'close'</span>][<span class="dv">1</span>:]</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Placeholder values</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="co">#new_ledger['cash'] = 50000</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trd_prd <span class="kw">in</span> blotter.index:</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> blotter.loc[trd_prd][<span class="st">'prediction'</span>] <span class="op">==</span> <span class="dv">0</span>: <span class="co"># if the trade is predicted to fail, no trade</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># if in train set or predicted success, make the trade</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> blotter.loc[trd_prd, <span class="st">'qty'</span>]</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    entry_price <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'entry_price'</span>]</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    entry_timestamp <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'entry_timestamp'</span>]</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    exit_timestamp <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'exit_timestamp'</span>]</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    exit_price <span class="op">=</span> blotter.loc[trd_prd][<span class="st">'exit_price'</span>]</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'position'</span>] <span class="op">+=</span> qty</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'position'</span>] <span class="op">-=</span> qty</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> entry_timestamp, <span class="st">'cash'</span>] <span class="op">-=</span> qty <span class="op">*</span> entry_price</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    new_ledger.loc[new_ledger[<span class="st">'date'</span>] <span class="op">&gt;=</span> exit_timestamp, <span class="st">'cash'</span>] <span class="op">+=</span> qty <span class="op">*</span> exit_price</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a><span class="co"># finally, calculate your strategy's end-of-day mark-to-market value</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'mkt_value'</span>] <span class="op">=</span> new_ledger[<span class="st">'position'</span>] <span class="op">*</span> new_ledger[<span class="st">'mark'</span>] <span class="op">+</span> new_ledger[<span class="st">'cash'</span>]</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_ledger)</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list to store categories</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>position_category <span class="op">=</span> []</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Categorize positions manually</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pos <span class="kw">in</span> new_ledger[<span class="st">'position'</span>]:</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Long'</span>)</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> pos <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Short'</span>)</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>        position_category.append(<span class="st">'Cash Only'</span>)</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Add category column to new_ledger</span></span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>new_ledger[<span class="st">'position_category'</span>] <span class="op">=</span> position_category</span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for each category</span></span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> {<span class="st">'Long'</span>: <span class="st">'green'</span>, <span class="st">'Short'</span>: <span class="st">'red'</span>, <span class="st">'Cash Only'</span>: <span class="st">'blue'</span>}</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> []</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign colors manually</span></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat <span class="kw">in</span> new_ledger[<span class="st">'position_category'</span>]:</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>    colors.append(color_map[cat])</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot NAV over time</span></span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>plt.scatter(new_ledger[<span class="st">'date'</span>], new_ledger[<span class="st">'mkt_value'</span>], c<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Net Asset Value (NAV)'</span>)</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'NAV Over Time with Position Coloring, Enhanced Model'</span>)</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually add legend</span></span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat, color <span class="kw">in</span> color_map.items():</span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>    plt.scatter([], [], color<span class="op">=</span>color, label<span class="op">=</span>cat)</span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return'</span>] <span class="op">=</span> ((blotter[<span class="st">'exit_price'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price'</span>]) <span class="op">/</span> blotter[<span class="st">'entry_price'</span>]) <span class="op">*</span> (blotter[<span class="st">'qty'</span>] <span class="op">/</span> <span class="bu">abs</span>(blotter[<span class="st">'qty'</span>])) <span class="co"># get returns irrespective of long/short</span></span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nExit Timestamps:")</span></span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a><span class="co">#print(blotter['exit_timestamp'])</span></span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch entry and exit prices from historical_data_hourly based on timestamps</span></span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'entry_price_underlying'</span>] <span class="op">=</span> blotter[<span class="st">'entry_timestamp'</span>].<span class="bu">apply</span>(</span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> ts: historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> ts, <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">=</span> blotter.<span class="bu">apply</span>(</span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: (</span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a>        historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> (</span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a>            historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="va">None</span>  <span class="co"># If neither dataset has the timestamp</span></span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a>    ), axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate return based on hourly data</span></span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return_underlying'</span>] <span class="op">=</span> (blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price_underlying'</span>]) <span class="op">/</span> blotter[<span class="st">'entry_price_underlying'</span>]<span class="op">*</span> (blotter[<span class="st">'qty'</span>] <span class="op">/</span> <span class="bu">abs</span>(blotter[<span class="st">'qty'</span>]))</span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return_underlying'</span>])</span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a>original_index <span class="op">=</span> x.index.copy()</span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a>x.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a>dropped_rows <span class="op">=</span> original_index.difference(x.index)</span>
<span id="cb20-138"><a href="#cb20-138" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return'</span>])</span>
<span id="cb20-139"><a href="#cb20-139" aria-hidden="true" tabindex="-1"></a>y.drop(index<span class="op">=</span>dropped_rows, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot of returns</span></span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a>plt.scatter(x, y, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">"Trades"</span>)</span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Underlying Return"</span>)</span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Strategy Return"</span>)</span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Strategy Return vs. Underlying Return, Standard Model"</span>)</span>
<span id="cb20-147"><a href="#cb20-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-148"><a href="#cb20-148" aria-hidden="true" tabindex="-1"></a><span class="co">#print(x,y)</span></span>
<span id="cb20-149"><a href="#cb20-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-150"><a href="#cb20-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a linear regression model to get alpha and beta</span></span>
<span id="cb20-151"><a href="#cb20-151" aria-hidden="true" tabindex="-1"></a>x_with_const <span class="op">=</span> sm.add_constant(x)  <span class="co"># Adds intercept for regression</span></span>
<span id="cb20-152"><a href="#cb20-152" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.OLS(y, x_with_const).fit()</span>
<span id="cb20-153"><a href="#cb20-153" aria-hidden="true" tabindex="-1"></a>alpha, beta <span class="op">=</span> model.params</span>
<span id="cb20-154"><a href="#cb20-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-155"><a href="#cb20-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot regression line</span></span>
<span id="cb20-156"><a href="#cb20-156" aria-hidden="true" tabindex="-1"></a>plt.plot(x, alpha <span class="op">+</span> beta <span class="op">*</span> x, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="ss">f"Regression Line (α=</span><span class="sc">{</span>alpha<span class="sc">:.4f}</span><span class="ss">, β=</span><span class="sc">{</span>beta<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb20-157"><a href="#cb20-157" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb20-158"><a href="#cb20-158" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-159"><a href="#cb20-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-160"><a href="#cb20-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Print alpha and beta values</span></span>
<span id="cb20-161"><a href="#cb20-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-162"><a href="#cb20-162" aria-hidden="true" tabindex="-1"></a>alpha, beta</span>
<span id="cb20-163"><a href="#cb20-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-164"><a href="#cb20-164" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return'</span>] <span class="op">=</span> ((blotter[<span class="st">'exit_price'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price'</span>]) <span class="op">/</span> blotter[<span class="st">'entry_price'</span>]) <span class="op">*</span> (blotter[<span class="st">'qty'</span>] <span class="op">/</span> <span class="bu">abs</span>(blotter[<span class="st">'qty'</span>])) <span class="op">*</span> blotter[<span class="st">'prediction'</span>]<span class="co"># get returns irrespective of long/short</span></span>
<span id="cb20-165"><a href="#cb20-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-166"><a href="#cb20-166" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\nExit Timestamps:")</span></span>
<span id="cb20-167"><a href="#cb20-167" aria-hidden="true" tabindex="-1"></a><span class="co">#print(blotter['exit_timestamp'])</span></span>
<span id="cb20-168"><a href="#cb20-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-169"><a href="#cb20-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch entry and exit prices from historical_data_hourly based on timestamps</span></span>
<span id="cb20-170"><a href="#cb20-170" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'entry_price_underlying'</span>] <span class="op">=</span> blotter[<span class="st">'entry_timestamp'</span>].<span class="bu">apply</span>(</span>
<span id="cb20-171"><a href="#cb20-171" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> ts: historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> ts, <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-172"><a href="#cb20-172" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-173"><a href="#cb20-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-174"><a href="#cb20-174" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">=</span> blotter.<span class="bu">apply</span>(</span>
<span id="cb20-175"><a href="#cb20-175" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: (</span>
<span id="cb20-176"><a href="#cb20-176" aria-hidden="true" tabindex="-1"></a>        historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-177"><a href="#cb20-177" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> historical_data_hourly.loc[historical_data_hourly[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb20-178"><a href="#cb20-178" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> (</span>
<span id="cb20-179"><a href="#cb20-179" aria-hidden="true" tabindex="-1"></a>            historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb20-180"><a href="#cb20-180" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> historical_data_daily.loc[historical_data_daily[<span class="st">'timestamp'</span>] <span class="op">==</span> row[<span class="st">'exit_timestamp'</span>], <span class="st">'close'</span>].empty</span>
<span id="cb20-181"><a href="#cb20-181" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="va">None</span>  <span class="co"># If neither dataset has the timestamp</span></span>
<span id="cb20-182"><a href="#cb20-182" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-183"><a href="#cb20-183" aria-hidden="true" tabindex="-1"></a>    ), axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb20-184"><a href="#cb20-184" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-185"><a href="#cb20-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-186"><a href="#cb20-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate return based on hourly data</span></span>
<span id="cb20-187"><a href="#cb20-187" aria-hidden="true" tabindex="-1"></a>blotter[<span class="st">'return_underlying'</span>] <span class="op">=</span> (blotter[<span class="st">'exit_price_underlying'</span>] <span class="op">-</span> blotter[<span class="st">'entry_price_underlying'</span>]) <span class="op">/</span> blotter[<span class="st">'entry_price_underlying'</span>]<span class="op">*</span> (blotter[<span class="st">'qty'</span>] <span class="op">/</span> <span class="bu">abs</span>(blotter[<span class="st">'qty'</span>]))</span>
<span id="cb20-188"><a href="#cb20-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-189"><a href="#cb20-189" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return_underlying'</span>])</span>
<span id="cb20-190"><a href="#cb20-190" aria-hidden="true" tabindex="-1"></a>original_index <span class="op">=</span> x.index.copy()</span>
<span id="cb20-191"><a href="#cb20-191" aria-hidden="true" tabindex="-1"></a>x.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-192"><a href="#cb20-192" aria-hidden="true" tabindex="-1"></a>dropped_rows <span class="op">=</span> original_index.difference(x.index)</span>
<span id="cb20-193"><a href="#cb20-193" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> pd.to_numeric(blotter[<span class="st">'return'</span>])</span>
<span id="cb20-194"><a href="#cb20-194" aria-hidden="true" tabindex="-1"></a>y.drop(index<span class="op">=</span>dropped_rows, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-195"><a href="#cb20-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-196"><a href="#cb20-196" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot of returns</span></span>
<span id="cb20-197"><a href="#cb20-197" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb20-198"><a href="#cb20-198" aria-hidden="true" tabindex="-1"></a>plt.scatter(x, y, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">"Trades"</span>)</span>
<span id="cb20-199"><a href="#cb20-199" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Underlying Return"</span>)</span>
<span id="cb20-200"><a href="#cb20-200" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Strategy Return"</span>)</span>
<span id="cb20-201"><a href="#cb20-201" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Strategy Return vs. Underlying Return, Enhanced Model"</span>)</span>
<span id="cb20-202"><a href="#cb20-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-203"><a href="#cb20-203" aria-hidden="true" tabindex="-1"></a><span class="co">#print(x,y)</span></span>
<span id="cb20-204"><a href="#cb20-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-205"><a href="#cb20-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a linear regression model to get alpha and beta</span></span>
<span id="cb20-206"><a href="#cb20-206" aria-hidden="true" tabindex="-1"></a>x_with_const <span class="op">=</span> sm.add_constant(x)  <span class="co"># Adds intercept for regression</span></span>
<span id="cb20-207"><a href="#cb20-207" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.OLS(y, x_with_const).fit()</span>
<span id="cb20-208"><a href="#cb20-208" aria-hidden="true" tabindex="-1"></a>alpha, beta <span class="op">=</span> model.params</span>
<span id="cb20-209"><a href="#cb20-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-210"><a href="#cb20-210" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot regression line</span></span>
<span id="cb20-211"><a href="#cb20-211" aria-hidden="true" tabindex="-1"></a>plt.plot(x, alpha <span class="op">+</span> beta <span class="op">*</span> x, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="ss">f"Regression Line (α=</span><span class="sc">{</span>alpha<span class="sc">:.4f}</span><span class="ss">, β=</span><span class="sc">{</span>beta<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb20-212"><a href="#cb20-212" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb20-213"><a href="#cb20-213" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-214"><a href="#cb20-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-215"><a href="#cb20-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Print alpha and beta values</span></span>
<span id="cb20-216"><a href="#cb20-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-217"><a href="#cb20-217" aria-hidden="true" tabindex="-1"></a>alpha, beta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>          date  position          cash    mark    mkt_value
8   2024-05-13       0.0      0.000000  140.15     0.000000
9   2024-05-14    -100.0  14286.000000  144.93  -207.000000
10  2024-05-15    -100.0  14286.000000  149.82  -696.000000
11  2024-05-16    -100.0  14286.000000  146.66  -380.000000
12  2024-05-17    -100.0  14286.000000  145.60  -274.000000
..         ...       ...           ...     ...          ...
245 2025-04-24       0.0   8029.487246  152.97  8029.487246
246 2025-04-25       0.0   8029.487246  153.88  8029.487246
247 2025-04-28       0.0   8029.487246  153.38  8029.487246
248 2025-04-29    -100.0  23423.487246  152.79  8144.487246
249 2025-04-30    -100.0  23423.487246  149.48  8475.487246

[242 rows x 5 columns]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-15-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-15-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-15-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>